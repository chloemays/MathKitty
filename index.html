<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê± MathKitty - Learn Math, Grow Your Cat!</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&family=Nunito:wght@400;600;700;800&family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-pink: #FF6B9D;
            --primary-purple: #9B59B6;
            --primary-blue: #3498DB;
            --primary-green: #2ECC71;
            --primary-orange: #F39C12;
            --primary-red: #E74C3C;
            --bg-gradient-1: #FFE5EC;
            --bg-gradient-2: #E8F4FD;
            --bg-gradient-3: #E8FFE8;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow-color: rgba(155, 89, 182, 0.3);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 50%, var(--bg-gradient-3) 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Floating bubbles background */
        .bubbles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        
        .bubble {
            position: absolute;
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
            opacity: 0.6;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(180deg); }
        }
        
        /* Stars animation */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            font-size: 20px;
            animation: twinkle 2s ease-in-out infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        .main-container {
            position: relative;
            z-index: 1;
            padding: 20px;
        }
        
        /* Header styles */
        .game-title {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 3.5rem;
            background: linear-gradient(45deg, var(--primary-pink), var(--primary-purple), var(--primary-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
            animation: titleBounce 2s ease-in-out infinite;
        }
        
        @keyframes titleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .subtitle {
            font-family: 'Fredoka', sans-serif;
            color: var(--primary-purple);
            font-size: 1.2rem;
        }
        
        /* Card styles */
        .game-card {
            background: var(--card-bg);
            border-radius: 25px;
            box-shadow: 0 10px 40px var(--shadow-color);
            border: 3px solid white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px var(--shadow-color);
        }
        
        /* Cat display area */
        .cat-stage {
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            border-radius: 20px;
            min-height: 300px;
            position: relative;
            overflow: hidden;
            border: 4px solid #FFD700;
        }
        
        /* New large cat display */
        .cat-main-display {
            position: relative;
        }
        
        .cat-stage-large {
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            border-radius: 20px;
            height: 380px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            border: 4px solid #FFD700;
        }
        
        /* Theme Background Container */
        .theme-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 2;
        }
        
        /* ===== PIRATE THEME BACKGROUNDS ===== */
        .pirate-sun {
            position: absolute;
            top: 8%;
            right: 12%;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 50%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 30px #FFD700, 0 0 60px rgba(255, 165, 0, 0.5);
        }
        
        .pirate-cloud {
            position: absolute;
            font-size: 40px;
            opacity: 0.9;
            animation: cloudDrift 20s linear infinite;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1));
        }
        
        .cloud-1 { top: 5%; left: -60px; animation-duration: 25s; }
        .cloud-2 { top: 15%; left: -100px; animation-duration: 35s; animation-delay: 10s; font-size: 30px; }
        .cloud-3 { top: 8%; left: -80px; animation-duration: 30s; animation-delay: 5s; font-size: 35px; }
        
        @keyframes cloudDrift {
            0% { transform: translateX(0); }
            100% { transform: translateX(calc(100vw + 150px)); }
        }
        
        .ocean-waves {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            height: 50%;
            background: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 20'%3E%3Cpath d='M0 15 Q25 5 50 15 T100 15 L100 20 L0 20 Z' fill='%231B6B93' opacity='0.6'/%3E%3C/svg%3E") repeat-x bottom,
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 20'%3E%3Cpath d='M0 10 Q25 0 50 10 T100 10 L100 20 L0 20 Z' fill='%232E86AB' opacity='0.5'/%3E%3C/svg%3E") repeat-x bottom 15px left;
            animation: waveMove 3s ease-in-out infinite;
            z-index: 3;
        }
        
        @keyframes waveMove {
            0%, 100% { background-position: 0 bottom, 50px bottom; }
            50% { background-position: 50px bottom, 0 bottom; }
        }
        
        .island {
            position: absolute;
            bottom: 100px;
            animation: islandPass 18s linear infinite;
            z-index: 3;
        }
        
        .island-1 { left: -120px; animation-duration: 20s; }
        .island-2 { left: -150px; animation-duration: 25s; animation-delay: 8s; }
        
        @keyframes islandPass {
            0% { transform: translateX(0); }
            100% { transform: translateX(calc(100vw + 200px)); }
        }
        
        .island-base {
            width: 80px;
            height: 25px;
            background: linear-gradient(180deg, #F4D03F 0%, #D4AC0D 50%, #B7950B 100%);
            border-radius: 50%;
            position: relative;
            top: -5px;
        }
        
        .palm-tree {
            font-size: 45px;
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            animation: palmSway 3s ease-in-out infinite;
        }
        
        .palm-2 {
            font-size: 35px;
            left: 25%;
            animation-delay: 0.5s;
        }
        
        @keyframes palmSway {
            0%, 100% { transform: translateX(-50%) rotate(-3deg); }
            50% { transform: translateX(-50%) rotate(3deg); }
        }
        
        .deck-items {
            position: absolute;
            bottom: 25px;
            left: 0;
            right: 0;
            z-index: 2;
        }
        
        .deck-item {
            position: absolute;
            font-size: 20px;
            opacity: 0.8;
        }
        
        .floating-item {
            position: absolute;
            font-size: 24px;
            animation: floatItem 4s ease-in-out infinite;
            opacity: 0.7;
        }
        
        @keyframes floatItem {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        
        /* ===== SPACE THEME BACKGROUNDS ===== */
        .stars-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s ease-in-out infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        .planet {
            position: absolute;
            border-radius: 50%;
            opacity: 0.8;
        }
        
        .planet-1 {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #E74C3C 0%, #C0392B 50%, #922B21 100%);
            top: 10%;
            right: 10%;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.4), 0 0 20px rgba(231,76,60,0.3);
        }
        
        .planet-2 {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #9B59B6 0%, #8E44AD 50%, #6C3483 100%);
            bottom: 20%;
            left: 8%;
            box-shadow: inset -8px -8px 15px rgba(0,0,0,0.4), 0 0 15px rgba(155,89,182,0.3);
        }
        
        .planet-1::after {
            content: '';
            position: absolute;
            width: 90px;
            height: 15px;
            background: linear-gradient(90deg, transparent, rgba(255,200,150,0.5), transparent);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-20deg);
            border-radius: 50%;
        }
        
        .space-item {
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        
        .shooting-star {
            position: absolute;
            width: 80px;
            height: 2px;
            background: linear-gradient(90deg, white, transparent);
            top: 15%;
            left: -80px;
            animation: shootingStar 6s linear infinite;
            opacity: 0.8;
        }
        
        @keyframes shootingStar {
            0% { left: -80px; top: 15%; opacity: 0; }
            10% { opacity: 1; }
            30% { left: 100%; top: 40%; opacity: 0; }
            100% { left: 100%; top: 40%; opacity: 0; }
        }
        
        /* Ship deck for pirate theme */
        .ship-deck {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(180deg, #8B4513 0%, #654321 50%, #4a3520 100%);
            border-top: 4px solid #A0522D;
            z-index: 4;
        }
        
        .ship-deck::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10%;
            right: 10%;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                #654321 0px,
                #654321 40px,
                #5a3a1a 40px,
                #5a3a1a 42px
            );
            border-radius: 2px;
        }
        
        .ship-deck::after {
            content: '';
            position: absolute;
            top: 30px;
            left: 10%;
            right: 10%;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                #654321 0px,
                #654321 40px,
                #5a3a1a 40px,
                #5a3a1a 42px
            );
            border-radius: 2px;
        }
        
        /* Space platform for space theme */
        .space-platform {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 40px;
            background: linear-gradient(180deg, #4a4a6a 0%, #2a2a4a 100%);
            border-radius: 10px 10px 0 0;
            border: 2px solid #6a6a8a;
            border-bottom: none;
        }
        
        .space-platform::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 20px;
            right: 20px;
            height: 4px;
            background: linear-gradient(90deg, #00D4FF, #00FF88, #00D4FF);
            border-radius: 2px;
            animation: platformGlow 2s ease-in-out infinite;
        }
        
        .space-platform::after {
            content: '';
            position: absolute;
            top: 18px;
            left: 40px;
            right: 40px;
            height: 3px;
            background: linear-gradient(90deg, #FF6B9D, #9B59B6, #FF6B9D);
            border-radius: 2px;
            animation: platformGlow 2s ease-in-out infinite reverse;
        }
        
        @keyframes platformGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Overlay panels */
        .overlay-panel {
            position: absolute;
            background: rgba(255,255,255,0.92);
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            backdrop-filter: blur(5px);
        }
        
        .overlay-panel:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .overlay-panel.top-left {
            top: 10px;
            left: 10px;
        }
        
        .overlay-panel.top-right {
            top: 10px;
            right: 10px;
            text-align: center;
        }
        
        .overlay-panel.bottom-left {
            bottom: 70px;
            left: 10px;
        }
        
        .overlay-panel.bottom-right {
            bottom: 70px;
            right: 10px;
        }
        
        .overlay-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .cat-name-small {
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--primary-purple);
        }
        
        .mini-stats-row {
            display: flex;
            gap: 6px;
        }
        
        .stat-pip {
            font-size: 1rem;
            opacity: 1;
            transition: opacity 0.3s;
        }
        
        .stat-pip.low {
            animation: pipPulse 1s ease-in-out infinite;
        }
        
        /* Mini health bars in overlay */
        .mini-bars-grid {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-top: 4px;
        }
        
        .mini-bar-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .mini-bar-icon {
            font-size: 0.7rem;
            width: 16px;
        }
        
        .mini-bar-track {
            flex: 1;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
            min-width: 60px;
        }
        
        .mini-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .mini-bar-fill.health-mini { background: linear-gradient(90deg, #e74c3c, #ff6b6b); }
        .mini-bar-fill.hunger-mini { background: linear-gradient(90deg, #e67e22, #f39c12); }
        .mini-bar-fill.thirst-mini { background: linear-gradient(90deg, #3498db, #5dade2); }
        .mini-bar-fill.happiness-mini { background: linear-gradient(90deg, #2ecc71, #58d68d); }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            }
            
            .game-card, .evolution-card {
                background: rgba(30, 30, 50, 0.95);
                color: #e0e0e0;
            }
            
            .overlay-panel {
                background: rgba(30, 30, 50, 0.95);
                color: #e0e0e0;
            }
            
            .expanded-panel {
                background: rgba(30, 30, 50, 0.98);
                color: #e0e0e0;
            }
            
            .expanded-header h5 {
                color: #bb86fc;
            }
            
            .cat-name-small, .cat-name-display {
                color: #bb86fc;
            }
            
            .text-muted {
                color: #aaa !important;
            }
            
            .expand-hint {
                color: #888;
            }
            
            .mini-bar-track {
                background: rgba(255,255,255,0.15);
            }
            
            .stat-bar-full, .evo-bar-mini, .xp-bar {
                background: rgba(255,255,255,0.15);
            }
            
            .stat-name, .score-desc, .mode-label {
                color: #aaa;
            }
            
            .topic-btn {
                background: rgba(255,255,255,0.1);
                color: #e0e0e0;
                border-color: rgba(255,255,255,0.2);
            }
            
            .topic-btn:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .topic-btn.active {
                background: var(--primary-purple);
                color: white;
            }
            
            .action-btn {
                color: white;
            }
            
            .answer-input {
                background: rgba(255,255,255,0.1);
                color: #e0e0e0;
                border-color: rgba(255,255,255,0.3);
            }
            
            .answer-input:focus {
                background: rgba(255,255,255,0.15);
                border-color: var(--primary-purple);
            }
            
            .question-text {
                color: #e0e0e0;
            }
            
            .help-section {
                background: rgba(46, 204, 113, 0.15);
                border-color: rgba(46, 204, 113, 0.3);
            }
            
            .close-btn {
                color: #aaa;
            }
            
            .close-btn:hover {
                color: #fff;
            }
            
            .mode-btn-large.free {
                background: linear-gradient(135deg, #2d4a5e 0%, #3d5a6e 100%);
                color: #e0e0e0;
            }
            
            .score-num {
                color: #bb86fc;
            }
            
            .badge.bg-warning {
                background: #f39c12 !important;
            }
            
            .expanded-panel-above {
                background: rgba(30, 30, 50, 0.98);
                color: #e0e0e0;
            }
            
            .score-top-panel {
                background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            }
        }
        
        @keyframes pipPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        
        .expand-hint {
            font-size: 0.6rem;
            color: #999;
            text-align: center;
            margin-top: 2px;
        }
        
        .score-compact {
            display: flex;
            align-items: baseline;
            gap: 2px;
        }
        
        .score-num {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-purple);
        }
        
        .score-label {
            font-size: 0.7rem;
            color: #666;
        }
        
        .streak-compact {
            font-size: 0.85rem;
            color: #e67e22;
            font-weight: 600;
        }
        
        /* Centered score panel below topics */
        /* Score top bar - above everything */
        .score-top-bar {
            display: flex;
            justify-content: center;
        }
        
        .score-top-panel {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .score-top-panel:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .score-top-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .score-top-num {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .score-top-num.streak-color {
            color: #ffd700;
        }
        
        .score-top-num.correct-color {
            color: #7dffb3;
        }
        
        .score-top-label {
            font-size: 0.65rem;
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .score-top-divider {
            width: 1px;
            height: 30px;
            background: rgba(255,255,255,0.3);
        }
        
        .expand-arrow {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-left: 5px;
        }
        
        /* Expanded panel above topics */
        .expanded-panel-above {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease;
        }
        
        /* Small tricks button in stats panel */
        .tricks-btn-small {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 6px 14px;
            border-radius: 15px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 6px;
            width: 100%;
        }
        
        .tricks-btn-small:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.4);
        }
        
        /* Tricks dropdown below cat box */
        .tricks-dropdown {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease;
        }
        
        .tricks-dropdown-content {
            text-align: center;
        }
        
        .tricks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            color: var(--primary-purple);
        }
        
        .tricks-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        
        .tricks-grid .trick-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            margin: 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8f9fa;
            min-width: 70px;
        }
        
        .tricks-grid .trick-item:hover:not(.locked) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .tricks-grid .trick-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .tricks-grid .trick-item .emoji {
            font-size: 1.8rem;
            margin-bottom: 4px;
        }
        
        .tricks-grid .trick-item .name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .evo-compact {
            min-width: 120px;
        }
        
        .evo-icons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .evo-dot {
            font-size: 0.9rem;
            opacity: 0.3;
        }
        
        .evo-dot.active {
            opacity: 1;
        }
        
        .evo-dot.completed {
            opacity: 0.7;
        }
        
        .evo-bar-mini {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .evo-fill-mini {
            height: 100%;
            background: linear-gradient(90deg, #f1c40f, #e67e22);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .mode-icon {
            font-size: 1.2rem;
        }
        
        .mode-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            display: block;
        }
        
        /* Expanded panels */
        .expanded-panel {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            animation: slideDown 0.3s ease;
        }
        
        .expanded-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .expanded-header h5 {
            margin: 0;
            font-family: 'Fredoka', sans-serif;
            color: var(--primary-purple);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
            padding: 0 5px;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .stat-row-full {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .stat-icon {
            font-size: 1.2rem;
            width: 30px;
        }
        
        .stat-name {
            width: 70px;
            font-size: 0.85rem;
            color: #666;
        }
        
        .stat-bar-full {
            flex: 1;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .stat-fill-full {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        
        .stat-fill-full.health-fill { background: linear-gradient(90deg, #e74c3c, #ff6b6b); }
        .stat-fill-full.hunger-fill { background: linear-gradient(90deg, #e67e22, #f39c12); }
        .stat-fill-full.thirst-fill { background: linear-gradient(90deg, #3498db, #5dade2); }
        .stat-fill-full.happiness-fill { background: linear-gradient(90deg, #2ecc71, #58d68d); }
        
        .stat-value {
            width: 35px;
            text-align: right;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .score-detail {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            text-align: center;
        }
        
        .score-item {
            padding: 5px 10px;
        }
        
        .score-big {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }
        
        .score-desc {
            font-size: 0.75rem;
            color: #666;
        }
        
        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .mode-btn-large {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .mode-btn-large.free {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        .mode-btn-large.story {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .mode-btn-large.boss {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .mode-btn-large.active {
            box-shadow: 0 0 0 3px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }
        
        .mode-btn-large:hover {
            transform: scale(1.05);
        }
        
        .mode-emoji {
            font-size: 1.5rem;
            display: block;
        }
        
        .mode-name {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .ground {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, #8BC34A 0%, #689F38 100%);
            border-radius: 0 0 16px 16px;
            z-index: 3;
        }
        
        .grass {
            position: absolute;
            bottom: 45px;
            left: 0;
            right: 0;
            height: 30px;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            z-index: 5;
            pointer-events: none;
        }
        
        .grass-blade {
            width: 8px;
            height: 25px;
            background: #7CB342;
            border-radius: 50% 50% 0 0;
            transform-origin: bottom;
            animation: sway 2s ease-in-out infinite;
            flex-shrink: 0;
        }
        
        @keyframes sway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        
        .sun {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 30px #FFD700;
            animation: pulse 3s ease-in-out infinite;
            z-index: 1;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px #FFD700; }
            50% { transform: scale(1.1); box-shadow: 0 0 50px #FFD700; }
        }
        
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            animation: drift 20s linear infinite;
            z-index: 1;
        }
        
        @keyframes drift {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(calc(100% + 100px)); }
        }
        
        /* Cat SVG styles */
        .cat-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.5s ease;
            z-index: 10;
        }
        
        .cat-svg {
            transition: all 0.3s ease;
        }
        
        .cat-container.happy .cat-svg {
            animation: catHappy 0.5s ease-in-out;
        }
        
        .cat-container.sad .cat-svg {
            animation: catSad 0.5s ease-in-out;
        }
        
        .cat-container.eating .cat-svg {
            animation: catEat 0.8s ease-in-out;
        }
        
        .cat-container.playing .cat-svg {
            animation: catPlay 1s ease-in-out;
        }
        
        /* Idle animations - subtle movements */
        .cat-tail {
            transform-origin: 45% 85%;
            animation: tailWag 3s ease-in-out infinite;
        }
        
        .cat-nose {
            transform-origin: center center;
            animation: noseWiggle 4s ease-in-out infinite;
        }
        
        .cat-ear-left {
            transform-origin: 60% 100%;
            animation: earTwitchLeft 6s ease-in-out infinite;
        }
        
        .cat-ear-right {
            transform-origin: 40% 100%;
            animation: earTwitchRight 6s ease-in-out infinite;
            animation-delay: 3s;
        }
        
        .cat-whiskers-left {
            transform-origin: 100% 50%;
            animation: whiskersLeft 3.5s ease-in-out infinite;
        }
        
        .cat-whiskers-right {
            transform-origin: 0% 50%;
            animation: whiskersRight 3.5s ease-in-out infinite;
        }
        
        .cat-body {
            transform-origin: center center;
            animation: bodyBreathe 4s ease-in-out infinite;
        }
        
        .cat-eyes {
            transform-origin: center center;
            animation: eyeBlink 5s ease-in-out infinite;
        }
        
        @keyframes tailWag {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
        }
        
        @keyframes noseWiggle {
            0%, 100% { transform: scale(1); }
            15% { transform: scale(1.05); }
            30% { transform: scale(1); }
        }
        
        @keyframes earTwitchLeft {
            0%, 100% { transform: rotate(0deg); }
            3% { transform: rotate(-3deg); }
            6% { transform: rotate(0deg); }
        }
        
        @keyframes earTwitchRight {
            0%, 100% { transform: rotate(0deg); }
            3% { transform: rotate(3deg); }
            6% { transform: rotate(0deg); }
        }
        
        @keyframes whiskersLeft {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-2deg); }
        }
        
        @keyframes whiskersRight {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(2deg); }
        }
        
        @keyframes bodyBreathe {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.01); }
        }
        
        @keyframes eyeBlink {
            0%, 100% { transform: scaleY(1); }
            48% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
            52% { transform: scaleY(1); }
        }
        
        @keyframes catHappy {
            0%, 100% { transform: translateY(0) rotate(0); }
            25% { transform: translateY(-20px) rotate(-5deg); }
            75% { transform: translateY(-20px) rotate(5deg); }
        }
        
        @keyframes catSad {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(10px); }
        }
        
        @keyframes catEat {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.9); }
        }
        
        @keyframes catPlay {
            0% { transform: rotate(0) translateX(0); }
            25% { transform: rotate(-15deg) translateX(-20px); }
            75% { transform: rotate(15deg) translateX(20px); }
            100% { transform: rotate(0) translateX(0); }
        }
        
        /* Status bars - Mini overlay version */
        .status-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 8px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
        }
        
        .mini-status {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .mini-status-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .mini-icon {
            font-size: 0.85rem;
            width: 18px;
            text-align: center;
        }
        
        .mini-bar {
            width: 60px;
            height: 10px;
            background: #E0E0E0;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .mini-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .mini-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
        }
        
        .health-fill { background: linear-gradient(90deg, #E74C3C, #FF6B6B); }
        .hunger-fill { background: linear-gradient(90deg, #F39C12, #F1C40F); }
        .thirst-fill { background: linear-gradient(90deg, #3498DB, #5DADE2); }
        .happiness-fill { background: linear-gradient(90deg, #9B59B6, #BB8FCE); }
        
        .mini-value {
            font-family: 'Fredoka', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            color: #555;
            width: 22px;
            text-align: right;
        }
        
        .mini-fill.low {
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        /* Old status bar styles - keep for compatibility but hidden */
        .status-bar {
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
            background: #E0E0E0;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .status-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease, background 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .status-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
        }
        
        .status-label {
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .health-bar .status-fill { background: linear-gradient(90deg, #E74C3C, #FF6B6B); }
        .hunger-bar .status-fill { background: linear-gradient(90deg, #F39C12, #F1C40F); }
        .thirst-bar .status-fill { background: linear-gradient(90deg, #3498DB, #5DADE2); }
        .happiness-bar .status-fill { background: linear-gradient(90deg, #9B59B6, #BB8FCE); }
        
        /* Action buttons */
        .action-btn {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 15px 25px;
            border-radius: 50px;
            border: none;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, transparent 100%);
        }
        
        .action-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .action-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .btn-feed { background: linear-gradient(135deg, #F39C12, #E67E22); }
        .btn-water { background: linear-gradient(135deg, #3498DB, #2980B9); }
        .btn-play { background: linear-gradient(135deg, #9B59B6, #8E44AD); }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Topic selector */
        .topic-btn {
            font-family: 'Fredoka', sans-serif;
            font-weight: 500;
            padding: 12px 20px;
            border-radius: 20px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            background: white;
            color: #333;
        }
        
        .topic-btn:hover {
            transform: scale(1.05);
        }
        
        .topic-btn.active {
            border-color: var(--primary-purple);
            background: linear-gradient(135deg, #F8E8FF, #E8F4FF);
            color: var(--primary-purple);
        }
        
        .topic-btn i {
            font-size: 1.5rem;
        }
        
        /* Math question area */
        .question-card {
            background: linear-gradient(135deg, #FFF5E6, #FFE6F0);
            border-radius: 20px;
            padding: 30px;
            border: 3px solid #FFD700;
        }
        
        .question-text {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 2.5rem;
            color: #333;
        }
        
        .answer-input {
            font-family: 'Fredoka', sans-serif;
            font-size: 2rem;
            text-align: center;
            border: 4px solid var(--primary-purple);
            border-radius: 15px;
            padding: 15px;
            width: 200px;
            transition: all 0.3s ease;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.4);
        }
        
        .submit-btn {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            padding: 15px 40px;
            border-radius: 50px;
            border: none;
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            color: white;
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.4);
        }
        
        /* Feedback messages */
        .feedback-message {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            padding: 20px;
            border-radius: 15px;
            animation: popIn 0.5s ease;
        }
        
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes slideDown {
            0% { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        /* Mini-game styles */
        .mini-game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mini-game-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        
        .mini-game-area {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            height: 250px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            margin: 15px 0;
        }
        
        .catch-target {
            position: absolute;
            font-size: 2rem;
            cursor: pointer;
            user-select: none;
            z-index: 10;
        }
        
        .catch-target:hover {
            filter: brightness(1.2);
        }
        
        /* Bouncing yarn animation */
        .catch-target.bouncing {
            animation: yarnBounce 0.6s ease-in-out infinite;
        }
        
        @keyframes yarnBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-50px) rotate(180deg); }
        }
        
        /* Swimming fish animation - gentle bob */
        .catch-target.swimming {
            animation: fishSwim 1s ease-in-out infinite;
        }
        
        @keyframes fishSwim {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        /* Floating butterfly animation - smooth drift */
        .catch-target.floating {
            animation: butterflyFloat 2s ease-in-out infinite;
        }
        
        @keyframes butterflyFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        /* Falling treats animation - gentle sway */
        .catch-target.falling {
            animation: treatSway 1s ease-in-out infinite;
        }
        
        @keyframes treatSway {
            0%, 100% { margin-left: 0; }
            50% { margin-left: 10px; }
        }
        
        /* Laser dot animation - pulsing glow */
        .catch-target.laser-dot {
            animation: laserPulse 0.3s ease-in-out infinite;
            filter: drop-shadow(0 0 8px #ff0000);
        }
        
        @keyframes laserPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        /* Water waves effect for fish game */
        .water-waves {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: linear-gradient(180deg, transparent 0%, rgba(255,255,255,0.1) 100%);
            pointer-events: none;
        }
        
        .water-waves::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 300%;
            height: 20px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 20'%3E%3Cpath d='M0 10 Q25 0 50 10 T100 10 V20 H0Z' fill='rgba(255,255,255,0.2)'/%3E%3C/svg%3E") repeat-x;
            animation: waveMove 3s linear infinite;
        }
        
        @keyframes waveMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(33.33%); }
        }
        
        /* Tricks panel */
        .tricks-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tricks-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }
        
        .tricks-panel {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 100;
            min-width: 200px;
        }
        
        .tricks-panel.show {
            display: block;
            animation: popIn 0.3s ease;
        }
        
        .trick-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            margin: 3px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8f9fa;
        }
        
        .trick-item:hover:not(.locked) {
            background: #e9ecef;
            transform: scale(1.1);
        }
        
        .trick-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .trick-item .emoji {
            font-size: 1.5rem;
        }
        
        .trick-item .name {
            font-size: 0.65rem;
            color: #666;
        }
        
        /* Story mode styles */
        .story-banner {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 12px 15px;
            margin-bottom: 10px;
            color: white;
            display: none;
        }
        
        .story-banner.active {
            display: block;
            animation: popIn 0.3s ease;
        }
        
        .story-progress-bar {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .story-progress-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* Boss battle styles */
        .boss-banner {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            color: white;
            display: none;
        }
        
        .boss-banner.active {
            display: block;
            animation: popIn 0.3s ease;
        }
        
        .boss-emoji {
            font-size: 2.5rem;
            animation: bossFloat 1s ease-in-out infinite;
        }
        
        @keyframes bossFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .boss-health-bar {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            height: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .boss-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #f1c40f, #e74c3c);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        /* Cat fact popup */
        .cat-fact-popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20px;
            padding: 15px 25px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1500;
            display: none;
        }
        
        .cat-fact-popup.show {
            display: block;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            0% { transform: translateX(-50%) translateY(100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        /* Multiple cats selector */
        .cats-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .cat-tab {
            padding: 5px 12px;
            border-radius: 15px;
            background: #e9ecef;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: 'Fredoka', sans-serif;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .cat-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .cat-tab.add-new {
            background: #f8f9fa;
            border: 2px dashed #ccc;
        }
        
        .cat-tab.add-new:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        /* Mode selector buttons */
        .mode-btn {
            padding: 8px 12px;
            border-radius: 12px;
            border: none;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin: 2px;
        }
        
        .mode-btn.story {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .mode-btn.boss {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .mode-btn.free {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }
        
        .mode-btn:hover {
            transform: scale(1.05);
        }
        
        .mode-btn.active {
            box-shadow: 0 0 0 3px rgba(0,0,0,0.2);
        }
        
        /* Cat trick animations - on container */
        .cat-container.trick-sit {
            animation: trickSit 1s ease-in-out;
        }
        
        .cat-container.trick-wave {
            animation: trickWave 1s ease-in-out;
        }
        
        .cat-container.trick-roll {
            animation: trickRoll 1s ease-in-out;
        }
        
        .cat-container.trick-highfive {
            animation: trickHighfive 0.8s ease-in-out;
        }
        
        .cat-container.trick-dance {
            animation: trickDance 1.5s ease-in-out;
        }
        
        .cat-container.trick-backflip {
            animation: trickBackflip 1s ease-in-out;
        }
        
        @keyframes trickSit {
            0%, 100% { transform: translateX(-50%) scaleY(1); }
            30%, 70% { transform: translateX(-50%) scaleY(0.85) translateY(10px); }
        }
        
        @keyframes trickWave {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(-15deg); }
            75% { transform: translateX(-50%) rotate(15deg); }
        }
        
        @keyframes trickRoll {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }
        
        @keyframes trickHighfive {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-30px); }
        }
        
        @keyframes trickDance {
            0%, 100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
            25% { transform: translateX(-60%) translateY(-10px) rotate(-10deg); }
            50% { transform: translateX(-50%) translateY(0) rotate(0deg); }
            75% { transform: translateX(-40%) translateY(-10px) rotate(10deg); }
        }
        
        @keyframes trickBackflip {
            0% { transform: translateX(-50%) rotateY(0deg) scale(1); }
            25% { transform: translateX(-50%) rotateY(90deg) scale(0.8); }
            50% { transform: translateX(-50%) rotateY(180deg) scale(1); }
            75% { transform: translateX(-50%) rotateY(270deg) scale(0.8); }
            100% { transform: translateX(-50%) rotateY(360deg) scale(1); }
        }
        
        /* Extra expressions */
        .cat-svg.curious {
            animation: curious 2s ease-in-out infinite;
        }
        
        .cat-svg.excited {
            animation: excited 0.5s ease-in-out infinite;
        }
        
        @keyframes curious {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(15deg); }
        }
        
        @keyframes excited {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .feedback-correct {
            background: linear-gradient(135deg, #D5F5E3, #A9DFBF);
            color: #1E8449;
            border: 3px solid #2ECC71;
        }
        
        .feedback-incorrect {
            background: linear-gradient(135deg, #FADBD8, #F5B7B1);
            color: #922B21;
            border: 3px solid #E74C3C;
        }
        
        /* Help section */
        .help-section {
            background: linear-gradient(135deg, #E8F8F5, #D1F2EB);
            border-radius: 15px;
            padding: 20px;
            border: 3px solid #1ABC9C;
        }
        
        .help-title {
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            color: #16A085;
        }
        
        /* Evolution progress */
        .evolution-card {
            background: linear-gradient(135deg, #FCF3CF, #F9E79F);
            border-radius: 15px;
            padding: 15px;
            border: 3px solid #F1C40F;
        }
        
        .stage-indicator {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            transition: all 0.3s ease;
        }
        
        .stage-indicator.active {
            background: linear-gradient(135deg, #F1C40F, #F39C12);
            box-shadow: 0 5px 20px rgba(241, 196, 15, 0.5);
            animation: stageGlow 2s ease-in-out infinite;
        }
        
        .stage-indicator.completed {
            background: linear-gradient(135deg, #2ECC71, #27AE60);
        }
        
        .stage-indicator.locked {
            background: #BDC3C7;
            opacity: 0.6;
        }
        
        @keyframes stageGlow {
            0%, 100% { box-shadow: 0 5px 20px rgba(241, 196, 15, 0.5); }
            50% { box-shadow: 0 5px 35px rgba(241, 196, 15, 0.8); }
        }
        
        .stage-line {
            width: 25px;
            height: 4px;
            background: #BDC3C7;
            border-radius: 2px;
        }
        
        .stage-line.completed {
            background: linear-gradient(90deg, #2ECC71, #F1C40F);
        }
        
        /* XP bar */
        .xp-bar {
            height: 20px;
            background: #34495E;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #F1C40F, #E67E22);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Score display */
        .score-display {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 1.5rem;
            color: var(--primary-purple);
        }
        
        .score-display.text-warning {
            font-size: 1rem;
        }
        
        /* Sound toggle */
        /* Top Controls Container */
        .top-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .mode-toggle, .sound-toggle {
            background: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.3rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mode-toggle:hover, .sound-toggle:hover {
            transform: scale(1.1);
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
        }
        
        body.dark-mode .game-card {
            background: rgba(30, 30, 50, 0.95);
            border-color: #3a3a5a;
        }
        
        body.dark-mode .game-title {
            color: #e0b0ff;
        }
        
        body.dark-mode .subtitle {
            color: #b0b0c0;
        }
        
        body.dark-mode .mode-toggle,
        body.dark-mode .sound-toggle {
            background: #2a2a4a;
            color: white;
        }
        
        body.dark-mode .how-to-play-btn {
            background: linear-gradient(135deg, #1a3a2a, #2a4a3a);
            border-color: #3a6a4a;
            color: #90d090;
        }
        
        body.dark-mode .how-to-play-inner {
            background: linear-gradient(135deg, #1a2a20, #2a3a30);
            border-color: #3a5a4a;
            color: #c0d0c0;
        }
        
        body.dark-mode .color-picker-btn {
            background: linear-gradient(135deg, #2a1a3a, #3a2a4a);
            border-color: #6a4a8a;
            color: #c0a0d0;
        }
        
        body.dark-mode .topic-picker-btn {
            background: linear-gradient(135deg, #1a2a3a, #2a3a4a);
            border-color: #4a6a8a;
            color: #a0c0d0;
        }
        
        body.dark-mode .name-input {
            background: #2a2a4a;
            color: white;
            border-color: #6a4a8a;
        }
        
        body.dark-mode .name-input::placeholder {
            color: #8080a0;
        }
        
        body.dark-mode .theme-btn {
            background: #2a2a4a;
            border-color: #4a4a6a;
        }
        
        body.dark-mode .theme-btn .theme-name {
            color: #e0e0f0;
        }
        
        body.dark-mode .theme-btn .theme-desc {
            color: #a0a0b0;
        }
        
        body.dark-mode .overlay-panel {
            background: rgba(30, 30, 50, 0.95);
        }
        
        body.dark-mode .overlay-header,
        body.dark-mode .cat-name-display {
            color: #e0b0ff;
        }
        
        body.dark-mode .expanded-panel {
            background: rgba(30, 30, 50, 0.98);
            border-color: #4a4a6a;
        }
        
        body.dark-mode .expanded-header h5 {
            color: #e0b0ff;
        }
        
        body.dark-mode .topic-btn {
            background: #3a3a5a;
            color: #e0e0f0;
        }
        
        body.dark-mode .action-btn {
            background: linear-gradient(135deg, #3a3a5a, #4a4a6a);
        }
        
        body.dark-mode .question-card {
            background: rgba(40, 40, 60, 0.95);
            border-color: #5a5a7a;
        }
        
        body.dark-mode .question-text {
            color: #f0f0ff;
        }
        
        body.dark-mode #answerInput {
            background: #2a2a4a;
            color: white;
            border-color: #6a4a8a;
        }
        
        body.dark-mode .tricks-dropdown {
            background: rgba(30, 30, 50, 0.98);
            border-color: #4a4a6a;
        }
        
        body.dark-mode .modal-content {
            background: #2a2a4a;
            color: #e0e0f0;
        }
        
        body.dark-mode .modal-header {
            border-color: #4a4a6a;
        }
        
        body.dark-mode .text-muted {
            color: #a0a0b0 !important;
        }
        
        body.dark-mode .preview-text {
            color: #e0e0f0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }
        
        body.dark-mode .form-label {
            color: #c0a0d0 !important;
        }
        
        body.dark-mode .how-to-play-item {
            color: #c0d0c0;
            border-color: rgba(100, 180, 100, 0.2);
        }
        
        body.dark-mode .badge {
            opacity: 0.9;
        }
        
        body.dark-mode .stat-label {
            color: #a0a0b0;
        }
        
        body.dark-mode .xp-bar {
            background: #2a2a4a;
        }
        
        body.dark-mode .cat-fact-popup {
            background: rgba(30, 30, 50, 0.98);
            border-color: #5a5a7a;
            color: #e0e0f0;
        }

        /* Confetti container */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }
        
        @keyframes confettiFall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Food/water/toy animations */
        .item-animation {
            position: absolute;
            font-size: 3rem;
            animation: itemFloat 1s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes itemFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }
        }
        
        /* Heart particles */
        .heart-particle {
            position: absolute;
            font-size: 1.5rem;
            animation: heartFloat 1.5s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes heartFloat {
            0% {
                transform: translateY(0) scale(0);
                opacity: 1;
            }
            50% {
                transform: translateY(-50px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }
        }
        
        /* Modal styling */
        .modal-content {
            border-radius: 25px;
            border: none;
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-pink), var(--primary-purple));
            border: none;
            color: white;
        }
        
        .modal-title {
            font-family: 'Bubblegum Sans', cursive;
        }
        
        /* Game over / Evolution modal */
        .celebration-modal {
            background: linear-gradient(135deg, #FCF3CF, #F9E79F);
        }
        
        .evolution-text {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #F39C12, #E74C3C, #9B59B6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            .question-text {
                font-size: 1.8rem;
            }
            .answer-input {
                font-size: 1.5rem;
                width: 150px;
            }
            .cat-stage {
                min-height: 250px;
            }
        }
        
        /* Name input styling */
        .name-input {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            text-align: center;
            border: 4px solid var(--primary-pink);
            border-radius: 15px;
            padding: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .cat-name-display {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 1.8rem;
            color: var(--primary-purple);
        }
        
        /* Color picker buttons */
        .color-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .color-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .color-btn.active {
            border: 4px solid var(--primary-purple);
            transform: scale(1.1);
            box-shadow: 0 0 0 3px white, 0 5px 20px rgba(155, 89, 182, 0.5);
        }
        
        /* Theme Selector Buttons */
        .theme-selector {
            margin-bottom: 1rem;
        }
        
        .theme-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 20px;
            border: 3px solid #ddd;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .theme-btn:hover {
            transform: scale(1.05);
            border-color: var(--primary-purple);
        }
        
        .theme-btn.active {
            border-color: var(--primary-purple);
            background: linear-gradient(135deg, #f5f0ff 0%, #fff0f5 100%);
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.3);
        }
        
        .theme-btn[data-theme="pirate"].active {
            border-color: #8B4513;
            background: linear-gradient(135deg, #fff8dc 0%, #ffe4c4 100%);
            box-shadow: 0 0 20px rgba(139, 69, 19, 0.3);
        }
        
        .theme-btn[data-theme="space"].active {
            border-color: #4A00E0;
            background: linear-gradient(135deg, #e8e0ff 0%, #e0f0ff 100%);
            box-shadow: 0 0 20px rgba(74, 0, 224, 0.3);
        }
        
        .theme-emoji {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }
        
        .theme-name {
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
        }
        
        .theme-desc {
            font-size: 0.7rem;
            color: #666;
        }
        
        /* How to Play Collapsible */
        .how-to-play-btn {
            background: linear-gradient(135deg, #E8F8F5, #D5F5E3);
            border: 2px solid #2ECC71;
            border-radius: 25px;
            padding: 10px 25px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: #1E8449;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .how-to-play-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        #howToPlayArrow {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }
        
        .how-to-play-btn.expanded #howToPlayArrow {
            transform: rotate(180deg);
        }
        
        .how-to-play-content {
            margin-top: 15px;
            overflow: hidden;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 300px; }
        }
        
        .how-to-play-inner {
            background: linear-gradient(135deg, #f8fffe, #f0fff8);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid #d5f5e3;
        }
        
        .how-to-play-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            text-align: left;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(46, 204, 113, 0.1);
        }
        
        .how-to-play-item:last-child {
            border-bottom: none;
        }
        
        .how-to-play-icon {
            font-size: 1.3rem;
            min-width: 30px;
            text-align: center;
        }
        
        /* Color Picker Collapsible */
        .color-picker-btn {
            background: linear-gradient(135deg, #fff0f5, #f5f0ff);
            border: 2px solid var(--primary-purple);
            border-radius: 25px;
            padding: 8px 20px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary-purple);
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .color-picker-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.2);
        }
        
        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        #colorPickerArrow {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }
        
        .color-picker-btn.expanded #colorPickerArrow {
            transform: rotate(180deg);
        }
        
        .color-picker-content {
            margin-top: 10px;
            animation: slideDown 0.3s ease;
        }
        
        /* Topic Picker Collapsible */
        .topic-picker-btn {
            background: linear-gradient(135deg, #e8f4fd, #d4edff);
            border: 2px solid #3498db;
            border-radius: 25px;
            padding: 8px 20px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: #2980b9;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .topic-picker-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        #topicPickerArrow {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }
        
        .topic-picker-btn.expanded #topicPickerArrow {
            transform: rotate(180deg);
        }
        
        .topic-picker-content {
            margin-top: 10px;
            animation: slideDown 0.3s ease;
        }
        
        /* Preview text styling */
        .preview-text {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c5530;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8), -1px -1px 2px rgba(255,255,255,0.8);
        }
        
        .preview-text.dark-bg {
            color: #ffffff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8), -1px -1px 3px rgba(0,0,0,0.5);
        }
        
        @media (max-width: 576px) {
            .theme-btn {
                min-width: 90px;
                padding: 10px 12px;
            }
            .theme-emoji {
                font-size: 2rem;
            }
            .theme-name {
                font-size: 0.8rem;
            }
        }
        
        /* Tooltip styling */
        .info-tooltip {
            cursor: help;
            color: var(--primary-purple);
        }
        
        /* Yarn ball icon styling */
        .yarn-icon {
            display: inline-block;
            width: 1.5em;
            height: 1.5em;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <!-- Floating bubbles background -->
    <div class="bubbles" id="bubbles"></div>
    
    <!-- Stars background -->
    <div class="stars" id="stars"></div>
    
    <!-- Confetti container -->
    <div class="confetti-container" id="confetti-container"></div>
    
    <!-- Top controls -->
    <div class="top-controls">
        <button class="mode-toggle" id="darkModeToggle" title="Toggle Dark Mode" onclick="toggleDarkMode()">
            ‚òÄÔ∏è
        </button>
        <button class="sound-toggle" id="soundToggle" title="Toggle Sound" onclick="toggleSound()">
            üîä
        </button>
    </div>
    
    <!-- Main container -->
    <div class="main-container">
        <div class="container">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="game-title mb-2" id="gameHeaderTitle">üê± MathKitty</h1>
                <p class="subtitle" id="gameHeaderSubtitle">Solve math problems to care for your cat!</p>
            </div>
            
            <!-- Start Screen -->
            <div id="startScreen" class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="game-card p-4">
                        <!-- Theme Selector -->
                        <div class="mb-4 text-center">
                            <label class="form-label" style="font-family: 'Fredoka', sans-serif; font-weight: 600; color: var(--primary-purple);">
                                üé® Choose Your Adventure
                            </label>
                            <div class="theme-selector d-flex justify-content-center gap-3 flex-wrap">
                                <button class="theme-btn active" data-theme="cat" onclick="selectTheme('cat')">
                                    <span class="theme-emoji">üê±</span>
                                    <span class="theme-name">MathKitty</span>
                                    <span class="theme-desc">Care for your cat!</span>
                                </button>
                                <button class="theme-btn" data-theme="pirate" onclick="selectTheme('pirate')">
                                    <span class="theme-emoji">‚ò†Ô∏è</span>
                                    <span class="theme-name">MathPirate</span>
                                    <span class="theme-desc">Find treasure!</span>
                                </button>
                                <button class="theme-btn" data-theme="space" onclick="selectTheme('space')">
                                    <span class="theme-emoji">üöÄ</span>
                                    <span class="theme-name">MathSpace</span>
                                    <span class="theme-desc">Explore the galaxy!</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- How to Play - Collapsible -->
                        <div class="mb-4 text-center">
                            <button class="how-to-play-btn" onclick="toggleHowToPlay()" id="howToPlayBtn">
                                üìñ How to Play <span id="howToPlayArrow">‚ñº</span>
                            </button>
                            <div class="how-to-play-content" id="howToPlayContent" style="display: none;">
                                <div class="how-to-play-inner">
                                    <div class="how-to-play-item">
                                        <span class="how-to-play-icon">üéØ</span>
                                        <span><strong>Goal:</strong> <span id="goalText">Keep your cat happy and healthy!</span></span>
                                    </div>
                                    <div class="how-to-play-item">
                                        <span class="how-to-play-icon" id="characterEmoji">üê±</span>
                                        <span><strong>Your <span id="characterType">Cat</span>:</strong> Has 4 stats - ‚ù§Ô∏è Health, <span id="hungerEmoji">üçñ</span> <span id="hungerName">Hunger</span>, <span id="thirstEmoji">üíß</span> <span id="thirstName">Thirst</span>, <span id="happinessEmoji">üòä</span> <span id="happinessName">Happiness</span></span>
                                    </div>
                                    <div class="how-to-play-item">
                                        <span class="how-to-play-icon">üßÆ</span>
                                        <span><strong>Solve Math:</strong> Answer questions to <span id="actionText">feed, water, or play with your cat</span></span>
                                    </div>
                                    <div class="how-to-play-item">
                                        <span class="how-to-play-icon">‚≠ê</span>
                                        <span><strong>Evolve:</strong> <span class="badge bg-warning text-dark" id="stage1Badge">Kitten</span> ‚Üí <span class="badge bg-info text-dark" id="stage2Badge">Teen</span> ‚Üí <span class="badge bg-success" id="stage3Badge">Adult</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden spans for theme updates -->
                        <span id="characterTypeLower" style="display:none;">cat</span>
                        <span id="characterTypeLower2" style="display:none;">cat</span>
                        <span id="characterTypeLower3" style="display:none;">cat</span>
                        
                        <div class="row align-items-center">
                            <!-- Character Preview -->
                            <div class="col-md-5 text-center mb-4 mb-md-0">
                                <div class="p-3" id="previewContainer" style="background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%); border-radius: 20px; border: 3px solid #FFD700;">
                                    <div id="catPreview"></div>
                                    <p class="preview-text mt-2 mb-0" id="previewText">Your New Kitten!</p>
                                </div>
                            </div>
                            
                            <!-- Name and Color Selection -->
                            <div class="col-md-7">
                                <div class="mb-4 text-center">
                                    <label class="form-label" style="font-family: 'Fredoka', sans-serif; font-weight: 600; color: var(--primary-purple);">
                                        ‚úèÔ∏è <span id="nameLabel">Name Your Kitten</span>
                                    </label>
                                    <input type="text" id="catNameInput" class="name-input" placeholder="Enter name..." maxlength="15" style="max-width: 200px; margin: 0 auto; display: block;">
                                </div>
                                
                                <div class="mb-4 text-center">
                                    <button class="color-picker-btn" onclick="toggleColorPicker()" id="colorPickerBtn">
                                        üé® <span id="colorLabel">Choose Color</span> <span class="color-preview" id="colorPreview" style="background: #FFB347;"></span> <span id="colorPickerArrow">‚ñº</span>
                                    </button>
                                    <div class="color-picker-content" id="colorPickerContent" style="display: none;">
                                        <div class="d-flex flex-wrap gap-2 justify-content-center p-2" id="colorPicker">
                                            <button class="color-btn active" data-color="#FFB347" style="background: #FFB347;" title="Orange Tabby" onclick="selectColor('#FFB347')"></button>
                                            <button class="color-btn" data-color="#A0A0A0" style="background: #A0A0A0;" title="Gray" onclick="selectColor('#A0A0A0')"></button>
                                            <button class="color-btn" data-color="#3D3D3D" style="background: #3D3D3D;" title="Black" onclick="selectColor('#3D3D3D')"></button>
                                            <button class="color-btn" data-color="#F5DEB3" style="background: #F5DEB3;" title="Cream" onclick="selectColor('#F5DEB3')"></button>
                                            <button class="color-btn" data-color="#D2691E" style="background: #D2691E;" title="Brown" onclick="selectColor('#D2691E')"></button>
                                            <button class="color-btn" data-color="#FFE4B5" style="background: #FFE4B5;" title="White/Cream" onclick="selectColor('#FFE4B5')"></button>
                                            <button class="color-btn" data-color="#FF8C69" style="background: #FF8C69;" title="Ginger" onclick="selectColor('#FF8C69')"></button>
                                            <button class="color-btn" data-color="#DDA0DD" style="background: #DDA0DD;" title="Purple (Fantasy)" onclick="selectColor('#DDA0DD')"></button>
                                            <button class="color-btn" data-color="#87CEEB" style="background: #87CEEB;" title="Blue (Fantasy)" onclick="selectColor('#87CEEB')"></button>
                                            <button class="color-btn" data-color="#98FB98" style="background: #98FB98;" title="Green (Fantasy)" onclick="selectColor('#98FB98')"></button>
                                            <button class="color-btn" data-color="#FFB6C1" style="background: #FFB6C1;" title="Pink (Fantasy)" onclick="selectColor('#FFB6C1')"></button>
                                            <button class="color-btn" data-color="#F0E68C" style="background: #F0E68C;" title="Golden" onclick="selectColor('#F0E68C')"></button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <button class="submit-btn px-5" onclick="startGame()">
                                        üéÆ Start Playing!
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Game Screen -->
            <div id="gameScreen" style="display: none;">
                <!-- Score Panel - Above Everything -->
                <div class="score-top-bar mb-2">
                    <div class="score-top-panel" onclick="toggleScoreExpand()">
                        <div class="score-top-item">
                            <span class="score-top-num" id="scoreCompactTop">0</span>
                            <span class="score-top-label">points</span>
                        </div>
                        <div class="score-top-divider"></div>
                        <div class="score-top-item">
                            <span class="score-top-num streak-color" id="streakCompactTop">0</span>
                            <span class="score-top-label">streak üî•</span>
                        </div>
                        <div class="score-top-divider"></div>
                        <div class="score-top-item">
                            <span class="score-top-num correct-color" id="correctCompactTop">0</span>
                            <span class="score-top-label">correct ‚úì</span>
                        </div>
                        <div class="expand-arrow">‚ñº</div>
                    </div>
                </div>
                
                <!-- Score Expanded Panel - Shows above topics -->
                <div class="expanded-panel-above" id="scoreExpanded" style="display: none;">
                    <div class="expanded-header">
                        <h5>üèÜ Score Details</h5>
                        <button class="close-btn" onclick="toggleScoreExpand()">‚úï</button>
                    </div>
                    <div class="expanded-content">
                        <div class="score-detail">
                            <div class="score-item">
                                <span class="score-big" id="scoreDisplay">0</span>
                                <span class="score-desc">Points</span>
                            </div>
                            <div class="score-item">
                                <span class="score-big text-success" id="streakDisplay">0 üî•</span>
                                <span class="score-desc">Streak</span>
                            </div>
                            <div class="score-item">
                                <span class="score-big text-info" id="correctDisplay">0</span>
                                <span class="score-desc">Correct</span>
                            </div>
                            <div class="score-item">
                                <span class="score-big text-warning" id="difficultyDisplay">‚≠ê‚òÜ‚òÜ‚òÜ‚òÜ</span>
                                <span class="score-desc">Level <span id="diffLevel">1</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Topic Selection - Collapsible -->
                <div class="game-card p-2 mb-2 text-center">
                    <button class="topic-picker-btn" onclick="toggleTopicPicker()" id="topicPickerBtn">
                        üßÆ <span id="currentTopicLabel">‚ûï Addition</span> <span id="topicPickerArrow">‚ñº</span>
                    </button>
                    <div class="topic-picker-content" id="topicPickerContent" style="display: none;">
                        <div class="d-flex justify-content-center flex-wrap gap-2 p-2">
                            <button class="topic-btn active" data-topic="addition" onclick="selectTopic('addition')">‚ûï Add</button>
                            <button class="topic-btn" data-topic="subtraction" onclick="selectTopic('subtraction')">‚ûñ Sub</button>
                            <button class="topic-btn" data-topic="multiplication" onclick="selectTopic('multiplication')">‚úñÔ∏è Mult</button>
                            <button class="topic-btn" data-topic="division" onclick="selectTopic('division')">‚ûó Div</button>
                            <button class="topic-btn" data-topic="equations" onclick="selectTopic('equations')">üî¢ Eq</button>
                            <button class="topic-btn" data-topic="fractions" onclick="selectTopic('fractions')">¬Ω Frac</button>
                            <button class="topic-btn" data-topic="mixed" onclick="selectTopic('mixed')">üé≤ Mix</button>
                        </div>
                    </div>
                </div>
                
                <!-- Main Cat Display - Full Width -->
                <div class="cat-main-display mb-3">
                    <div class="cat-stage-large" id="catStage">
                        <!-- Sun -->
                        <div class="sun"></div>
                        
                        <!-- Clouds -->
                        <div class="cloud" style="top: 20px; left: -50px; width: 80px; height: 30px;"></div>
                        <div class="cloud" style="top: 50px; left: -100px; width: 60px; height: 25px; animation-delay: 5s;"></div>
                        
                        <!-- Top Left - Cat Name & Stats (clickable) -->
                        <div class="overlay-panel top-left" id="statsPanel">
                            <div class="overlay-header" onclick="toggleStatsExpand()">
                                <span class="cat-name-small" id="catNameDisplay">Whiskers</span>
                                <span class="badge bg-warning text-dark" id="stageLabel">üò¥ Newborn</span>
                            </div>
                            <div class="mini-bars-grid" onclick="toggleStatsExpand()">
                                <div class="mini-bar-row">
                                    <span class="mini-bar-icon" id="healthIconMini">‚ù§Ô∏è</span>
                                    <div class="mini-bar-track"><div class="mini-bar-fill health-mini" id="healthBarMini" style="width: 100%;"></div></div>
                                </div>
                                <div class="mini-bar-row">
                                    <span class="mini-bar-icon" id="hungerIconMini">üçñ</span>
                                    <div class="mini-bar-track"><div class="mini-bar-fill hunger-mini" id="hungerBarMini" style="width: 100%;"></div></div>
                                </div>
                                <div class="mini-bar-row">
                                    <span class="mini-bar-icon" id="thirstIconMini">üíß</span>
                                    <div class="mini-bar-track"><div class="mini-bar-fill thirst-mini" id="thirstBarMini" style="width: 100%;"></div></div>
                                </div>
                                <div class="mini-bar-row">
                                    <span class="mini-bar-icon" id="happinessIconMini">üòä</span>
                                    <div class="mini-bar-track"><div class="mini-bar-fill happiness-mini" id="happinessBarMini" style="width: 100%;"></div></div>
                                </div>
                            </div>
                            <button class="tricks-btn-small" onclick="toggleTricksPanel(event)">üé™ Tricks</button>
                        </div>
                        
                        <!-- Bottom Left - Evolution Progress (clickable) -->
                        <div class="overlay-panel bottom-left" id="evolutionPanel" onclick="toggleEvolutionExpand()">
                            <div class="evo-compact">
                                <div class="evo-icons">
                                    <span class="evo-dot active" id="evo0">üò¥</span>
                                    <span class="evo-dot" id="evo1">üê±</span>
                                    <span class="evo-dot" id="evo2">üò∫</span>
                                    <span class="evo-dot" id="evo3">ü¶Å</span>
                                </div>
                                <div class="evo-bar-mini">
                                    <div class="evo-fill-mini" id="xpBarMini" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bottom Right - Game Mode (clickable) -->
                        <div class="overlay-panel bottom-right" id="modePanel" onclick="toggleModeExpand()">
                            <span class="mode-icon" id="currentModeIcon">üéÆ</span>
                            <span class="mode-label" id="currentModeLabel">Free</span>
                        </div>
                        
                        <!-- Grass -->
                        <div class="grass" id="grass">
                            <!-- Initial grass blades - more added by JS -->
                            <div class="grass-blade"></div>
                            <div class="grass-blade"></div>
                            <div class="grass-blade"></div>
                            <div class="grass-blade"></div>
                            <div class="grass-blade"></div>
                        </div>
                        
                        <!-- Ground -->
                        <div class="ground"></div>
                        
                        <!-- Cat Container -->
                        <div class="cat-container" id="catContainer">
                            <!-- Cat SVG will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Tricks Dropdown Panel (shows below cat box when opened) -->
                <div class="tricks-dropdown" id="tricksPanel" style="display: none;">
                    <div class="tricks-dropdown-content">
                        <div class="tricks-header">
                            <span>üé™ Teach Tricks</span>
                            <button class="close-btn" onclick="toggleTricksPanel(event)">‚úï</button>
                        </div>
                        <div id="tricksList" class="tricks-grid"></div>
                    </div>
                </div>
                
                <!-- Expanded Panels (hidden by default) -->
                
                <!-- Stats Expanded Panel -->
                <div class="expanded-panel" id="statsExpanded" style="display: none;">
                    <div class="expanded-header">
                        <h5>üìä Cat Stats</h5>
                        <button class="close-btn" onclick="toggleStatsExpand()">‚úï</button>
                    </div>
                    <div class="expanded-content">
                        <div class="stat-row-full">
                            <span class="stat-icon" id="healthIconFull">‚ù§Ô∏è</span>
                            <span class="stat-name" id="healthNameFull">Health</span>
                            <div class="stat-bar-full">
                                <div class="stat-fill-full health-fill" id="healthBar" style="width: 100%;"></div>
                            </div>
                            <span class="stat-value" id="healthValue">100</span>
                        </div>
                        <div class="stat-row-full">
                            <span class="stat-icon" id="hungerIconFull">üçñ</span>
                            <span class="stat-name" id="hungerNameFull">Hunger</span>
                            <div class="stat-bar-full">
                                <div class="stat-fill-full hunger-fill" id="hungerBar" style="width: 100%;"></div>
                            </div>
                            <span class="stat-value" id="hungerValue">100</span>
                        </div>
                        <div class="stat-row-full">
                            <span class="stat-icon" id="thirstIconFull">üíß</span>
                            <span class="stat-name" id="thirstNameFull">Thirst</span>
                            <div class="stat-bar-full">
                                <div class="stat-fill-full thirst-fill" id="thirstBar" style="width: 100%;"></div>
                            </div>
                            <span class="stat-value" id="thirstValue">100</span>
                        </div>
                        <div class="stat-row-full">
                            <span class="stat-icon" id="happinessIconFull">üòä</span>
                            <span class="stat-name" id="happinessNameFull">Happiness</span>
                            <div class="stat-bar-full">
                                <div class="stat-fill-full happiness-fill" id="happinessBar" style="width: 100%;"></div>
                            </div>
                            <span class="stat-value" id="happinessValue">100</span>
                        </div>
                    </div>
                </div>
                
                <!-- Evolution Expanded Panel -->
                <div class="expanded-panel" id="evolutionExpanded" style="display: none;">
                    <div class="expanded-header">
                        <h5>‚≠ê Evolution Progress</h5>
                        <button class="close-btn" onclick="toggleEvolutionExpand()">‚úï</button>
                    </div>
                    <div class="expanded-content">
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <div class="stage-indicator active" id="stage0">üò¥</div>
                            <div class="stage-line" id="line0"></div>
                            <div class="stage-indicator locked" id="stage1">üê±</div>
                            <div class="stage-line" id="line1"></div>
                            <div class="stage-indicator locked" id="stage2">üò∫</div>
                            <div class="stage-line" id="line2"></div>
                            <div class="stage-indicator locked" id="stage3">ü¶Å</div>
                        </div>
                        <div class="text-center small text-muted mb-2">
                            <span id="evoLabel0">Newborn</span>
                            <span class="mx-3" id="evoLabel1">Kitten</span>
                            <span class="mx-3" id="evoLabel2">Teen</span>
                            <span id="evoLabel3">Adult</span>
                        </div>
                        <div class="xp-bar">
                            <div class="xp-fill" id="xpBar" style="width: 0%;"></div>
                        </div>
                        <div class="text-center mt-2">
                            <span id="xpText">0 / 100 XP to wake up!</span>
                        </div>
                    </div>
                </div>
                
                <!-- Mode Expanded Panel -->
                <div class="expanded-panel" id="modeExpanded" style="display: none;">
                    <div class="expanded-header">
                        <h5>üéÆ Game Mode</h5>
                        <button class="close-btn" onclick="toggleModeExpand()">‚úï</button>
                    </div>
                    <div class="expanded-content">
                        <div class="mode-buttons">
                            <button class="mode-btn-large free active" onclick="setGameMode('free')">
                                <span class="mode-emoji">üéÆ</span>
                                <span class="mode-name">Free Play</span>
                            </button>
                            <button class="mode-btn-large story" onclick="setGameMode('story')">
                                <span class="mode-emoji">üìñ</span>
                                <span class="mode-name">Story</span>
                            </button>
                            <button class="mode-btn-large boss" onclick="setGameMode('boss')">
                                <span class="mode-emoji">üëπ</span>
                                <span class="mode-name">Boss</span>
                            </button>
                        </div>
                        
                        <!-- Story Banner (hidden by default) -->
                        <div class="story-banner mt-3" id="storyBanner">
                            <div class="d-flex align-items-center">
                                <span class="fs-4 me-2" id="storyIcon">üêü</span>
                                <div class="flex-grow-1">
                                    <div class="fw-bold small" id="storyTitle">The Hungry Kitten</div>
                                    <div class="small opacity-75" style="font-size: 0.7rem;" id="storyDesc">Collect 5 fish!</div>
                                </div>
                                <span class="badge bg-light text-dark" id="storyCount">0/5</span>
                            </div>
                            <div class="story-progress-bar mt-1">
                                <div class="story-progress-fill" id="storyProgressFill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Boss Banner (hidden by default) -->
                        <div class="boss-banner mt-3" id="bossBanner">
                            <div class="d-flex align-items-center">
                                <span class="boss-emoji me-2" id="bossEmoji" style="font-size: 1.8rem;">üêï</span>
                                <div class="flex-grow-1">
                                    <div class="fw-bold small" id="bossName">Grumpy Dog</div>
                                    <div class="boss-health-bar">
                                        <div class="boss-health-fill" id="bossHealthFill" style="width: 100%"></div>
                                    </div>
                                </div>
                                <span class="badge bg-light text-dark" id="bossHP">5/5</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Controls Row -->
                <div class="row g-3">
                    <!-- Actions & Math Section -->
                    <div class="col-12">
                        <!-- Actions Row -->
                        <div class="game-card p-3 mb-2">
                            <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
                                <button class="action-btn btn-feed" id="feedBtn" onclick="selectAction('feed')">
                                    <span id="feedBtnText">üçñ Feed</span>
                                </button>
                                <button class="action-btn btn-water" id="waterBtn" onclick="selectAction('water')">
                                    <span id="waterBtnText">üíß Water</span>
                                </button>
                                <button class="action-btn btn-play" id="playBtn" onclick="selectAction('play')">
                                    <span id="playBtnText">üß∂ Play</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Question Area -->
                        <div class="game-card p-3" id="questionArea" style="display: none;">
                            <div class="question-card text-center">
                                <div class="mb-2 small text-muted" id="questionType">Addition Problem</div>
                                <div class="question-text mb-3" id="questionText">5 + 3 = ?</div>
                                <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
                                    <input type="number" class="answer-input" id="answerInput" placeholder="?" autocomplete="off">
                                    <button class="submit-btn" onclick="checkAnswer()">
                                        ‚úì Check
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Feedback Area -->
                        <div id="feedbackArea" style="display: none;">
                            <div class="feedback-message" id="feedbackMessage"></div>
                        </div>
                        
                        <!-- Help Section -->
                        <div class="help-section mt-2" id="helpSection" style="display: none;">
                            <h6 class="text-center text-info mb-2">üí° Let's Learn!</h6>
                            <div id="helpContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Evolution Modal -->
    <div class="modal fade" id="evolutionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content celebration-modal">
                <div class="modal-header border-0 justify-content-center">
                    <h4 class="modal-title">üéâ Evolution Time! üéâ</h4>
                </div>
                <div class="modal-body text-center">
                    <div class="evolution-text mb-3" id="evolutionText">Your cat evolved!</div>
                    <div id="evolutionCatDisplay" class="mb-3"></div>
                    <p class="mb-0" id="evolutionMessage">Keep practicing to help your cat grow more!</p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="submit-btn" data-bs-dismiss="modal">
                        üéÆ Continue Playing!
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Over Modal -->
    <div class="modal fade" id="gameOverModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white justify-content-center">
                    <h4 class="modal-title" id="gameOverTitle">üòø Oh No!</h4>
                </div>
                <div class="modal-body text-center">
                    <p class="fs-5" id="gameOverMessage">Your cat's health reached zero!</p>
                    <p id="gameOverEncouragement">Don't worry, you can try again and help your cat thrive!</p>
                    <p class="text-muted">Final Score: <span id="finalScore">0</span></p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="submit-btn" onclick="restartGame()">
                        üîÑ Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ============ GAME STATE ============
        const gameState = {
            catName: 'Whiskers',
            catColor: '#FFB347',
            health: 100,
            hunger: 100,
            thirst: 100,
            happiness: 100,
            score: 0,
            streak: 0,
            correct: 0,
            xp: 0,
            stage: 0, // 0 = newborn, 1 = kitten, 2 = teen, 3 = adult
            currentTopic: 'addition',
            currentAction: null,
            currentQuestion: null,
            currentAnswer: null,
            soundEnabled: true,
            xpToEvolve: [100, 350, 800], // XP needed for kitten, teen, adult
            difficulty: 1, // 1-5 difficulty level
            correctInARow: 0, // Track consecutive correct answers for difficulty scaling
            questionsAtCurrentDifficulty: 0, // Track questions answered at current difficulty
            
            // New features
            totalCorrect: 0, // Lifetime correct answers
            unlockedTricks: ['sit'], // Available tricks
            currentCatIndex: 0, // Which cat is active
            cats: [], // Array of cat data for multiple cats
            storyMode: false, // Story mode active
            storyProgress: 0, // Current story chapter
            bossActive: false, // Boss battle in progress
            bossHealth: 0, // Boss HP
            catFacts: [
                "Cats sleep for about 70% of their lives!",
                "A group of cats is called a 'clowder'.",
                "Cats can rotate their ears 180 degrees!",
                "A cat's nose print is unique, like a fingerprint.",
                "Cats can jump up to 6 times their length!",
                "The oldest known cat lived to be 38 years old!",
                "Cats have over 20 different vocalizations.",
                "A cat's purr vibrates at 25-150 Hz.",
                "Cats spend 30-50% of their day grooming.",
                "Cats can run up to 30 miles per hour!",
                "Cats have 230 bones (humans have 206).",
                "A cat's heart beats twice as fast as a human's.",
                "Cats can't taste sweetness.",
                "Cats have whiskers on their front legs too!",
                "A cat's meow is only used to communicate with humans."
            ],
            lastFactIndex: -1,
            miniGameActive: false,
            miniGameScore: 0,
            currentTheme: 'cat' // 'cat', 'pirate', or 'space'
        };
        
        // ============ THEME CONFIGURATIONS ============
        const themes = {
            cat: {
                name: 'MathKitty',
                emoji: 'üê±',
                subtitle: 'Learn Math, Grow Your Cat!',
                characterName: 'cat',
                defaultName: 'Whiskers',
                
                // Evolution stages
                stages: ['üò¥ Newborn', 'üê± Kitten', 'üò∫ Teen Cat', 'ü¶Å Adult Cat'],
                stageNames: ['Newborn', 'Kitten', 'Teen Cat', 'Adult Cat'],
                stageEmojis: ['üò¥', 'üê±', 'üò∫', 'ü¶Å'],
                evolveMessages: [
                    '',
                    '{name} woke up! Your kitten is ready to play! üéâ',
                    '{name} is growing up! Keep practicing!',
                    '{name} is now a majestic adult cat! üèÜ'
                ],
                
                // Actions
                actions: {
                    feed: { name: 'Feed', emoji: 'üçñ', message: 'üçñ Answer correctly to feed your cat!' },
                    water: { name: 'Water', emoji: 'üíß', message: 'üíß Answer correctly to give water!' },
                    play: { name: 'Play', emoji: 'üß∂', message: 'üéæ Answer correctly to play with your cat!' }
                },
                
                // Stats
                stats: {
                    health: { name: 'Health', emoji: '‚ù§Ô∏è' },
                    hunger: { name: 'Hunger', emoji: 'üçñ' },
                    thirst: { name: 'Thirst', emoji: 'üíß' },
                    happiness: { name: 'Happiness', emoji: 'üòä' }
                },
                
                // Mini-games
                miniGames: [
                    { id: 'mice', name: 'Catch the Mice!', emoji: 'üê≠', target: 'üê≠', decoys: ['üßÄ', 'üï≥Ô∏è'], caught: 'mice', description: 'Click mice before they escape!', bg: 'linear-gradient(135deg, #8B4513 0%, #D2691E 100%)' },
                    { id: 'yarn', name: 'Yarn Ball Frenzy!', emoji: 'üß∂', target: 'üß∂', decoys: ['üéæ', '‚öΩ'], caught: 'yarn balls', description: 'Catch the bouncing yarn balls!', bg: 'linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%)' },
                    { id: 'fish', name: 'Fishing Fun!', emoji: 'üêü', target: 'üêü', decoys: ['üê†', 'ü¶Ä', 'üêö'], caught: 'fish', description: 'Catch fish swimming by!', bg: 'linear-gradient(180deg, #87CEEB 0%, #1E90FF 50%, #006994 100%)' },
                    { id: 'butterfly', name: 'Butterfly Chase!', emoji: 'ü¶ã', target: 'ü¶ã', decoys: ['üå∏', 'üå∫', 'üêù'], caught: 'butterflies', description: 'Catch colorful butterflies!', bg: 'linear-gradient(180deg, #87CEEB 0%, #98FB98 100%)' },
                    { id: 'treats', name: 'Treat Time!', emoji: 'üçó', target: 'üçó', decoys: ['ü•¶', 'ü•ï', 'üçã'], caught: 'treats', description: 'Catch yummy cat treats!', bg: 'linear-gradient(135deg, #FFF8DC 0%, #FFDAB9 100%)' },
                    { id: 'laser', name: 'Laser Pointer!', emoji: 'üî¥', target: 'üî¥', decoys: ['üü°', 'üü¢', 'üîµ'], caught: 'red dots', description: 'Catch the red laser dots!', bg: 'linear-gradient(135deg, #2C3E50 0%, #4A4A4A 100%)' }
                ],
                
                // Story chapters
                storyChapters: [
                    { title: "The Hungry Kitten", description: "Help your kitten collect 5 fish to have dinner!", goal: 5, reward: 50, icon: "üêü" },
                    { title: "Cross the River", description: "Build a bridge with 8 wooden planks!", goal: 8, reward: 75, icon: "üåâ" },
                    { title: "The Yarn Ball Hunt", description: "Find 10 yarn balls in the garden!", goal: 10, reward: 100, icon: "üß∂" },
                    { title: "Moonlight Adventure", description: "Catch 12 fireflies to light your way!", goal: 12, reward: 125, icon: "‚ú®" },
                    { title: "The Cat Castle", description: "Collect 15 blocks for your castle!", goal: 15, reward: 150, icon: "üè∞" }
                ],
                
                // Boss battles
                bossData: [
                    { name: "Grumpy Dog", emoji: "üêï", hp: 5, reward: 100 },
                    { name: "Sneaky Raccoon", emoji: "ü¶ù", hp: 7, reward: 150 },
                    { name: "Giant Spider", emoji: "üï∑Ô∏è", hp: 10, reward: 200 },
                    { name: "Mischief Mouse King", emoji: "üê≠üëë", hp: 12, reward: 250 },
                    { name: "The Vacuum Cleaner", emoji: "üåÄ", hp: 15, reward: 300 }
                ],
                
                // Tricks
                tricks: {
                    sit: { name: 'Sit', emoji: 'üê±', unlockStage: 0 },
                    wave: { name: 'Wave', emoji: 'üëã', unlockStage: 1 },
                    roll: { name: 'Roll Over', emoji: 'üîÑ', unlockStage: 1 },
                    highfive: { name: 'High Five', emoji: '‚úã', unlockStage: 2 },
                    dance: { name: 'Dance', emoji: 'üíÉ', unlockStage: 2 },
                    backflip: { name: 'Backflip', emoji: 'ü§∏', unlockStage: 3 }
                },
                
                // Fun facts
                facts: [
                    "Cats sleep for about 70% of their lives!",
                    "A group of cats is called a 'clowder'.",
                    "Cats can rotate their ears 180 degrees!",
                    "A cat's nose print is unique, like a fingerprint.",
                    "Cats can jump up to 6 times their length!",
                    "The oldest known cat lived to be 38 years old!",
                    "Cats have over 20 different vocalizations.",
                    "A cat's purr vibrates at 25-150 Hz.",
                    "Cats spend 30-50% of their day grooming.",
                    "Cats can run up to 30 miles per hour!"
                ],
                
                // UI colors
                colors: {
                    primary: '#9B59B6',
                    secondary: '#FF6B9D',
                    accent: '#FFD700',
                    bgGradient1: '#FFE5EC',
                    bgGradient2: '#E8F4FD',
                    bgGradient3: '#E8FFE8',
                    stageBg: 'linear-gradient(180deg, #87CEEB 0%, #98FB98 100%)'
                },
                
                // Game over message
                gameOverTitle: 'üòø Oh No!',
                gameOverMessage: "Your cat's health reached zero!"
            },
            
            pirate: {
                name: 'MathPirate',
                emoji: '‚ò†Ô∏è',
                subtitle: 'Solve Math, Find Treasure!',
                characterName: 'parrot',
                defaultName: 'Polly',
                
                stages: ['ü•í Egg', 'üê£ Hatchling', 'ü¶ú Young Parrot', 'ü¶ú Captain Parrot'],
                stageNames: ['Egg', 'Hatchling', 'Young Parrot', 'Captain Parrot'],
                stageEmojis: ['ü•ö', 'üê£', 'ü¶ú', 'ü¶ú'],
                evolveMessages: [
                    '',
                    '{name} hatched! Ready to sail! ‚öì',
                    '{name} is growing colorful feathers!',
                    '{name} is now Captain Parrot! üëë'
                ],
                
                actions: {
                    feed: { name: 'Rations', emoji: 'üçñ', message: 'üçñ Answer correctly to eat rations!' },
                    water: { name: 'Coconut', emoji: 'ü••', message: 'ü•• Answer correctly for coconut water!' },
                    play: { name: 'Shanty', emoji: 'üéµ', message: 'üéµ Answer correctly to sing a shanty!' }
                },
                
                stats: {
                    health: { name: 'Health', emoji: '‚ù§Ô∏è' },
                    hunger: { name: 'Hunger', emoji: 'üçñ' },
                    thirst: { name: 'Thirst', emoji: 'ü••' },
                    happiness: { name: 'Morale', emoji: 'üí™' }
                },
                
                miniGames: [
                    { id: 'coins', name: 'Gold Rush!', emoji: 'ü™ô', target: 'ü™ô', decoys: ['üîµ', '‚ö´'], caught: 'gold coins', description: 'Catch the gold coins!', bg: 'linear-gradient(135deg, #8B4513 0%, #D2691E 100%)' },
                    { id: 'treasure', name: 'Treasure Hunt!', emoji: 'üíé', target: 'üíé', decoys: ['ü™®', 'ü¶¥'], caught: 'gems', description: 'Grab the treasures!', bg: 'linear-gradient(135deg, #2C3E50 0%, #4A4A4A 100%)' },
                    { id: 'fish', name: 'Fishing!', emoji: 'üêü', target: 'üêü', decoys: ['üê†', 'ü¶à', 'üêö'], caught: 'fish', description: 'Catch fish for dinner!', bg: 'linear-gradient(180deg, #87CEEB 0%, #1E90FF 50%, #006994 100%)' },
                    { id: 'cannonball', name: 'Cannonballs!', emoji: 'üí£', target: 'üí£', decoys: ['ü••', '‚öΩ'], caught: 'cannonballs', description: 'Load the cannons!', bg: 'linear-gradient(180deg, #4a4a4a 0%, #2d2d2d 100%)' },
                    { id: 'parrot', name: 'Parrot Catch!', emoji: 'ü¶ú', target: 'ü¶ú', decoys: ['ü¶Ö', 'üê¶'], caught: 'parrots', description: 'Catch a parrot friend!', bg: 'linear-gradient(180deg, #87CEEB 0%, #98FB98 100%)' },
                    { id: 'maps', name: 'Map Pieces!', emoji: 'üó∫Ô∏è', target: 'üó∫Ô∏è', decoys: ['üìú', 'üì∞'], caught: 'map pieces', description: 'Collect map pieces!', bg: 'linear-gradient(135deg, #DEB887 0%, #D2B48C 100%)' }
                ],
                
                storyChapters: [
                    { title: "Set Sail!", description: "Collect 5 compass pieces to navigate!", goal: 5, reward: 50, icon: "üß≠" },
                    { title: "Storm's Coming", description: "Secure 8 ropes before the storm!", goal: 8, reward: 75, icon: "üåä" },
                    { title: "Treasure Island", description: "Dig up 10 treasure chests!", goal: 10, reward: 100, icon: "üí∞" },
                    { title: "Kraken Attack", description: "Fire 12 cannons to defeat the kraken!", goal: 12, reward: 125, icon: "ü¶ë" },
                    { title: "The Golden Ship", description: "Collect 15 gold bars for your ship!", goal: 15, reward: 150, icon: "üö¢" }
                ],
                
                bossData: [
                    { name: "Rival Pirate", emoji: "üè¥‚Äç‚ò†Ô∏è", hp: 5, reward: 100 },
                    { name: "Sea Monster", emoji: "üêô", hp: 7, reward: 150 },
                    { name: "Ghost Ship", emoji: "üëª", hp: 10, reward: 200 },
                    { name: "The Kraken", emoji: "ü¶ë", hp: 12, reward: 250 },
                    { name: "Davy Jones", emoji: "üíÄ", hp: 15, reward: 300 }
                ],
                
                tricks: {
                    sit: { name: 'Salute', emoji: 'ü´°', unlockStage: 0 },
                    wave: { name: 'Wave Flag', emoji: 'üè¥‚Äç‚ò†Ô∏è', unlockStage: 1 },
                    roll: { name: 'Barrel Roll', emoji: 'üõ¢Ô∏è', unlockStage: 1 },
                    highfive: { name: 'Hook High-Five', emoji: 'ü™ù', unlockStage: 2 },
                    dance: { name: 'Jig', emoji: 'üï∫', unlockStage: 2 },
                    backflip: { name: 'Plank Flip', emoji: 'ü§∏', unlockStage: 3 }
                },
                
                facts: [
                    "Pirates wore eye patches to see better below deck!",
                    "Blackbeard put lit fuses in his beard to scare enemies!",
                    "Pirates had their own code of conduct!",
                    "The Jolly Roger flag meant 'surrender or else'!",
                    "Pirates earned vacation time and health insurance!",
                    "Female pirates like Anne Bonny were fierce fighters!",
                    "Pirates rarely made people walk the plank!",
                    "Coconuts were prized on ships for fresh water and food!",
                    "Pirates used earrings to pay for their funerals!",
                    "The Caribbean was called the 'Golden Age of Piracy'!"
                ],
                
                colors: {
                    primary: '#8B4513',
                    secondary: '#FFD700',
                    accent: '#DC143C',
                    bgGradient1: '#DEB887',
                    bgGradient2: '#87CEEB',
                    bgGradient3: '#F4A460',
                    stageBg: 'linear-gradient(180deg, #87CEEB 0%, #1E90FF 50%, #8B4513 100%)'
                },
                
                gameOverTitle: 'üíÄ Arrr!',
                gameOverMessage: "Ye ship has sunk, matey!"
            },
            
            space: {
                name: 'MathSpace',
                emoji: 'üöÄ',
                subtitle: 'Solve Math, Explore the Galaxy!',
                characterName: 'ship',
                defaultName: 'Nova',
                
                stages: ['üõ∞Ô∏è Satellite', 'üöÄ Rocket', 'üõ∏ Spacecraft', '‚≠ê Starship'],
                stageNames: ['Satellite', 'Rocket', 'Spacecraft', 'Starship'],
                stageEmojis: ['üõ∞Ô∏è', 'üöÄ', 'üõ∏', '‚≠ê'],
                evolveMessages: [
                    '',
                    '{name} launched! Ready for space! üöÄ',
                    '{name} upgraded to a spacecraft!',
                    '{name} is now a mighty Starship! ‚≠ê'
                ],
                
                actions: {
                    feed: { name: 'Fuel', emoji: '‚õΩ', message: '‚õΩ Answer correctly to refuel!' },
                    water: { name: 'Oxygen', emoji: 'üí®', message: 'üí® Answer correctly for oxygen!' },
                    play: { name: 'Explore', emoji: 'üî≠', message: 'üî≠ Answer correctly to explore!' }
                },
                
                stats: {
                    health: { name: 'Health', emoji: '‚ù§Ô∏è' },
                    hunger: { name: 'Fuel', emoji: '‚õΩ' },
                    thirst: { name: 'Oxygen', emoji: 'üí®' },
                    happiness: { name: 'Morale', emoji: 'üåü' }
                },
                
                miniGames: [
                    { id: 'stars', name: 'Star Collector!', emoji: '‚≠ê', target: '‚≠ê', decoys: ['üí´', '‚ú®'], caught: 'stars', description: 'Collect the stars!', bg: 'linear-gradient(180deg, #0a0a2e 0%, #1a1a4e 100%)' },
                    { id: 'asteroids', name: 'Asteroid Dodge!', emoji: '‚òÑÔ∏è', target: 'üíé', decoys: ['‚òÑÔ∏è', 'ü™®'], caught: 'crystals', description: 'Grab crystals, avoid asteroids!', bg: 'linear-gradient(180deg, #1a0a2e 0%, #2a1a4e 100%)' },
                    { id: 'satellites', name: 'Satellite Repair!', emoji: 'üõ∞Ô∏è', target: 'üõ∞Ô∏è', decoys: ['üóëÔ∏è', 'üì°'], caught: 'satellites', description: 'Fix the satellites!', bg: 'linear-gradient(180deg, #000022 0%, #000044 100%)' },
                    { id: 'planets', name: 'Planet Discovery!', emoji: 'ü™ê', target: 'ü™ê', decoys: ['üåë', '‚òÄÔ∏è'], caught: 'planets', description: 'Discover new planets!', bg: 'linear-gradient(180deg, #0f0f3f 0%, #1f1f5f 100%)' },
                    { id: 'aliens', name: 'Friendly Aliens!', emoji: 'üëΩ', target: 'üëΩ', decoys: ['ü§ñ', 'üëæ'], caught: 'aliens', description: 'Make alien friends!', bg: 'linear-gradient(180deg, #1a2a1a 0%, #2a4a2a 100%)' },
                    { id: 'rockets', name: 'Rocket Parts!', emoji: 'üîß', target: 'üîß', decoys: ['üî©', '‚öôÔ∏è'], caught: 'parts', description: 'Collect rocket parts!', bg: 'linear-gradient(180deg, #2a2a2a 0%, #4a4a4a 100%)' }
                ],
                
                storyChapters: [
                    { title: "Launch Day", description: "Collect 5 fuel cells to launch!", goal: 5, reward: 50, icon: "üöÄ" },
                    { title: "Moon Mission", description: "Gather 8 moon rocks!", goal: 8, reward: 75, icon: "üåô" },
                    { title: "Asteroid Belt", description: "Navigate through 10 asteroids!", goal: 10, reward: 100, icon: "‚òÑÔ∏è" },
                    { title: "Alien Contact", description: "Send 12 signals to aliens!", goal: 12, reward: 125, icon: "üì°" },
                    { title: "New Home", description: "Collect 15 supplies for the colony!", goal: 15, reward: 150, icon: "üè†" }
                ],
                
                bossData: [
                    { name: "Space Junk", emoji: "üóëÔ∏è", hp: 5, reward: 100 },
                    { name: "Asteroid Storm", emoji: "‚òÑÔ∏è", hp: 7, reward: 150 },
                    { name: "Alien Scout", emoji: "üëæ", hp: 10, reward: 200 },
                    { name: "Black Hole", emoji: "üï≥Ô∏è", hp: 12, reward: 250 },
                    { name: "Mothership", emoji: "üõ∏", hp: 15, reward: 300 }
                ],
                
                tricks: {
                    sit: { name: 'Float', emoji: 'üßò', unlockStage: 0 },
                    wave: { name: 'Signal', emoji: 'üì°', unlockStage: 1 },
                    roll: { name: 'Barrel Roll', emoji: 'üîÑ', unlockStage: 1 },
                    highfive: { name: 'Alien High-Five', emoji: 'üëΩ', unlockStage: 2 },
                    dance: { name: 'Moon Walk', emoji: 'üï∫', unlockStage: 2 },
                    backflip: { name: 'Zero-G Flip', emoji: 'ü§∏', unlockStage: 3 }
                },
                
                facts: [
                    "A day on Venus is longer than its year!",
                    "There are more stars than grains of sand on Earth!",
                    "Footprints on the Moon will last millions of years!",
                    "The Sun makes up 99.86% of our solar system's mass!",
                    "Neutron stars spin 600 times per second!",
                    "Space is completely silent - no air for sound!",
                    "One million Earths could fit inside the Sun!",
                    "The International Space Station orbits at 17,500 mph!",
                    "Astronauts grow up to 2 inches taller in space!",
                    "There may be a planet made entirely of diamonds!"
                ],
                
                colors: {
                    primary: '#4A00E0',
                    secondary: '#00D4FF',
                    accent: '#FFD700',
                    bgGradient1: '#0a0a2e',
                    bgGradient2: '#1a1a4e',
                    bgGradient3: '#2a1a5e',
                    stageBg: 'linear-gradient(180deg, #0a0a2e 0%, #1a1a4e 50%, #2a2a6e 100%)'
                },
                
                gameOverTitle: 'üí• Mission Failed!',
                gameOverMessage: "Your ship ran out of power!"
            }
        };
        
        // Helper function to get current theme
        function getTheme() {
            return themes[gameState.currentTheme];
        }
        
        // Dynamic getters that use current theme
        function getTricksData() {
            return getTheme().tricks;
        }
        
        function getStoryChapters() {
            return getTheme().storyChapters;
        }
        
        function getBossData() {
            return getTheme().bossData;
        }
        
        function getMiniGames() {
            return getTheme().miniGames;
        }
        
        // ============ AUDIO CONTEXT ============
        let audioContext = null;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            initAudio();
            
            switch(type) {
                case 'correct':
                    playCorrectSound();
                    break;
                case 'incorrect':
                    playIncorrectSound();
                    break;
                case 'click':
                    playClickSound();
                    break;
                case 'meow':
                    playMeowSound();
                    break;
                case 'purr':
                    playPurrSound();
                    break;
                case 'evolution':
                    playEvolutionSound();
                    break;
                case 'feed':
                case 'water':
                    playMunchSound();
                    playMeowSound();
                    break;
                case 'play':
                    playChirpSound();
                    break;
                case 'happy':
                    playPurrSound();
                    break;
                case 'sad':
                    playSadSound();
                    break;
            }
        }
        
        function playCorrectSound() {
            // Happy ascending chime
            const notes = [523.25, 659.25, 783.99];
            notes.forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.1);
                gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.3);
                osc.start(audioContext.currentTime + i * 0.1);
                osc.stop(audioContext.currentTime + i * 0.1 + 0.3);
            });
        }
        
        function playIncorrectSound() {
            // Soft descending tone
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(330, audioContext.currentTime);
            osc.frequency.exponentialRampToValueAtTime(220, audioContext.currentTime + 0.3);
            gain.gain.setValueAtTime(0.15, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + 0.3);
        }
        
        function playClickSound() {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioContext.currentTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + 0.05);
        }
        
        function playMeowSound() {
            // Simple cute "mew" sound
            const now = audioContext.currentTime;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.type = 'sine';
            // Quick rise then fall - like "mew"
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.08);
            osc.frequency.linearRampToValueAtTime(500, now + 0.25);
            
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.15, now + 0.03);
            gain.gain.linearRampToValueAtTime(0.12, now + 0.15);
            gain.gain.linearRampToValueAtTime(0, now + 0.25);
            
            osc.start(now);
            osc.stop(now + 0.25);
        }
        
        function playPurrSound() {
            // Soft rumble purr effect
            const now = audioContext.currentTime;
            const duration = 0.6;
            
            // Create white noise for texture
            const bufferSize = audioContext.sampleRate * duration;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            // Create rhythmic purr pattern
            for (let i = 0; i < bufferSize; i++) {
                const t = i / audioContext.sampleRate;
                const purrRate = 25; // purrs per second
                const purrEnvelope = 0.5 + 0.5 * Math.sin(2 * Math.PI * purrRate * t);
                data[i] = (Math.random() * 2 - 1) * 0.3 * purrEnvelope;
            }
            
            const noise = audioContext.createBufferSource();
            noise.buffer = buffer;
            
            // Low pass filter to make it rumbly
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(150, now);
            
            const gain = audioContext.createGain();
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.2, now + 0.1);
            gain.gain.setValueAtTime(0.2, now + duration - 0.15);
            gain.gain.linearRampToValueAtTime(0, now + duration);
            
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);
            
            noise.start(now);
            noise.stop(now + duration);
        }
        
        function playChirpSound() {
            // Playful chirp/trill sound
            const now = audioContext.currentTime;
            
            for (let i = 0; i < 3; i++) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.type = 'sine';
                const startTime = now + i * 0.12;
                osc.frequency.setValueAtTime(700 + i * 100, startTime);
                osc.frequency.linearRampToValueAtTime(900 + i * 100, startTime + 0.05);
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.1, startTime + 0.02);
                gain.gain.linearRampToValueAtTime(0, startTime + 0.08);
                
                osc.start(startTime);
                osc.stop(startTime + 0.08);
            }
        }
        
        function playSadSound() {
            // Soft descending whimper
            const now = audioContext.currentTime;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, now);
            osc.frequency.linearRampToValueAtTime(350, now + 0.3);
            
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.05);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            
            osc.start(now);
            osc.stop(now + 0.3);
        }
        
        function playEvolutionSound() {
            // Magical ascending arpeggio
            const notes = [392, 440, 523.25, 587.33, 659.25, 783.99, 880, 1046.5];
            notes.forEach((freq, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'sine';
                const startTime = audioContext.currentTime + i * 0.08;
                osc.frequency.setValueAtTime(freq, startTime);
                gain.gain.setValueAtTime(0.15, startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.25);
                osc.start(startTime);
                osc.stop(startTime + 0.25);
            });
        }
        
        function playMunchSound() {
            // Simple soft pop sounds
            for (let i = 0; i < 2; i++) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.type = 'sine';
                const startTime = audioContext.currentTime + i * 0.15;
                osc.frequency.setValueAtTime(200, startTime);
                osc.frequency.exponentialRampToValueAtTime(100, startTime + 0.08);
                
                gain.gain.setValueAtTime(0.1, startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.08);
                
                osc.start(startTime);
                osc.stop(startTime + 0.08);
            }
        }
        
        // ============ CAT SVG GENERATION ============
        function getCatSVG(stage, expression = 'normal', catColor = null) {
            const color = catColor || gameState.catColor || '#FFB347';
            
            // Calculate color variations
            const lighterColor = lightenColor(color, 30);
            const darkerColor = darkenColor(color, 20);
            const pinkColor = '#FFB6C1';
            
            let size, scale;
            
            switch(stage) {
                case 0: // Newborn (sleeping)
                    size = 160;
                    scale = 0.6;
                    break;
                case 1: // Kitten
                    size = 160;
                    scale = 0.75;
                    break;
                case 2: // Teen
                    size = 180;
                    scale = 0.88;
                    break;
                case 3: // Adult
                    size = 200;
                    scale = 1;
                    break;
            }
            
            const cx = size / 2;
            const cy = size / 2;
            
            // Newborn sleeping stage - curled up ball
            if (stage === 0) {
                return `
                    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="cat-svg">
                        <g transform="translate(${cx}, ${cy + 20}) scale(${scale}) translate(${-cx}, ${-cy})">
                            
                            <!-- Shadow -->
                            <ellipse cx="${cx}" cy="${cy + 45}" rx="40" ry="10" fill="rgba(0,0,0,0.1)"/>
                            
                            <!-- Curled up body -->
                            <ellipse cx="${cx}" cy="${cy + 20}" rx="45" ry="35" fill="${color}"/>
                            
                            <!-- Tail curled around -->
                            <g class="cat-tail">
                                <path d="M${cx + 35} ${cy + 30} Q${cx + 50} ${cy + 45} ${cx + 40} ${cy + 50} Q${cx + 20} ${cy + 55} ${cx} ${cy + 45}" 
                                      stroke="${color}" stroke-width="14" fill="none" stroke-linecap="round"/>
                                <path d="M${cx + 35} ${cy + 30} Q${cx + 50} ${cy + 45} ${cx + 40} ${cy + 50} Q${cx + 20} ${cy + 55} ${cx} ${cy + 45}" 
                                      stroke="${darkerColor}" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.3" stroke-dasharray="8 12"/>
                            </g>
                            
                            <!-- Head resting -->
                            <ellipse cx="${cx - 15}" cy="${cy}" rx="32" ry="28" fill="${color}"/>
                            
                            <!-- Curved ears (folded down for baby) -->
                            <ellipse cx="${cx - 38}" cy="${cy - 18}" rx="12" ry="10" fill="${color}" transform="rotate(-20 ${cx - 38} ${cy - 18})"/>
                            <ellipse cx="${cx - 36}" cy="${cy - 16}" rx="7" ry="6" fill="${pinkColor}" transform="rotate(-20 ${cx - 36} ${cy - 16})"/>
                            
                            <ellipse cx="${cx + 5}" cy="${cy - 22}" rx="12" ry="10" fill="${color}" transform="rotate(20 ${cx + 5} ${cy - 22})"/>
                            <ellipse cx="${cx + 3}" cy="${cy - 20}" rx="7" ry="6" fill="${pinkColor}" transform="rotate(20 ${cx + 3} ${cy - 20})"/>
                            
                            <!-- Closed sleeping eyes -->
                            <path d="M${cx - 28} ${cy - 2} Q${cx - 22} ${cy - 8} ${cx - 16} ${cy - 2}" stroke="#2D1B07" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            <path d="M${cx - 8} ${cy - 2} Q${cx - 2} ${cy - 8} ${cx + 4} ${cy - 2}" stroke="#2D1B07" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            
                            <!-- Tiny nose -->
                            <ellipse cx="${cx - 12}" cy="${cy + 6}" rx="4" ry="3" fill="${pinkColor}" stroke="#2D1B07" stroke-width="1.5"/>
                            
                            <!-- Nose to mouth line -->
                            <line x1="${cx - 12}" y1="${cy + 9}" x2="${cx - 12}" y2="${cy + 11}" stroke="#2D1B07" stroke-width="1.5" stroke-linecap="round"/>
                            
                            <!-- Tiny smile -->
                            <path d="M${cx - 16} ${cy + 12} Q${cx - 12} ${cy + 15} ${cx - 8} ${cy + 12}" stroke="#2D1B07" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                            
                            <!-- Small whiskers -->
                            <g class="cat-whiskers-left">
                                <line x1="${cx - 22}" y1="${cy + 6}" x2="${cx - 38}" y2="${cy + 2}" stroke="#2D1B07" stroke-width="1.5" stroke-linecap="round"/>
                                <line x1="${cx - 22}" y1="${cy + 10}" x2="${cx - 38}" y2="${cy + 10}" stroke="#2D1B07" stroke-width="1.5" stroke-linecap="round"/>
                            </g>
                            <g class="cat-whiskers-right">
                                <line x1="${cx - 2}" y1="${cy + 6}" x2="${cx + 14}" y2="${cy + 2}" stroke="#2D1B07" stroke-width="1.5" stroke-linecap="round"/>
                                <line x1="${cx - 2}" y1="${cy + 10}" x2="${cx + 14}" y2="${cy + 10}" stroke="#2D1B07" stroke-width="1.5" stroke-linecap="round"/>
                            </g>
                            
                            <!-- Zzz sleeping indicator -->
                            <text x="${cx + 30}" y="${cy - 25}" font-family="Fredoka, sans-serif" font-size="14" fill="#9B59B6" opacity="0.8">z</text>
                            <text x="${cx + 40}" y="${cy - 35}" font-family="Fredoka, sans-serif" font-size="18" fill="#9B59B6" opacity="0.6">z</text>
                            <text x="${cx + 52}" y="${cy - 48}" font-family="Fredoka, sans-serif" font-size="22" fill="#9B59B6" opacity="0.4">z</text>
                            
                            <!-- Body stripes -->
                            <ellipse cx="${cx + 15}" cy="${cy + 15}" rx="8" ry="12" fill="${darkerColor}" opacity="0.3"/>
                            <ellipse cx="${cx - 5}" cy="${cy + 25}" rx="6" ry="10" fill="${darkerColor}" opacity="0.3"/>
                            
                        </g>
                    </svg>
                `;
            }
            
            // Eye expressions
            let eyeContent = '';
            let mouthContent = '';
            
            if (expression === 'happy') {
                // Happy closed eyes (^ ^)
                eyeContent = `
                    <path d="M${cx-22} ${cy-15} Q${cx-17} ${cy-25} ${cx-12} ${cy-15}" stroke="#2D1B07" stroke-width="3" fill="none" stroke-linecap="round"/>
                    <path d="M${cx+12} ${cy-15} Q${cx+17} ${cy-25} ${cx+22} ${cy-15}" stroke="#2D1B07" stroke-width="3" fill="none" stroke-linecap="round"/>
                `;
                mouthContent = `
                    <path d="M${cx-8} ${cy+8} Q${cx} ${cy+15} ${cx+8} ${cy+8}" stroke="#2D1B07" stroke-width="2" fill="none" stroke-linecap="round"/>
                `;
            } else if (expression === 'sad') {
                // Sad eyes
                eyeContent = `
                    <ellipse cx="${cx-17}" cy="${cy-12}" rx="10" ry="12" fill="white"/>
                    <ellipse cx="${cx+17}" cy="${cy-12}" rx="10" ry="12" fill="white"/>
                    <ellipse cx="${cx-17}" cy="${cy-10}" rx="7" ry="8" fill="#6BB5E0"/>
                    <ellipse cx="${cx+17}" cy="${cy-10}" rx="7" ry="8" fill="#6BB5E0"/>
                    <ellipse cx="${cx-17}" cy="${cy-10}" rx="4" ry="5" fill="#2D1B07"/>
                    <ellipse cx="${cx+17}" cy="${cy-10}" rx="4" ry="5" fill="#2D1B07"/>
                    <ellipse cx="${cx-15}" cy="${cy-13}" rx="2" ry="2" fill="white"/>
                    <ellipse cx="${cx+19}" cy="${cy-13}" rx="2" ry="2" fill="white"/>
                    <path d="M${cx-25} ${cy-25} L${cx-10} ${cy-20}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                    <path d="M${cx+10} ${cy-20} L${cx+25} ${cy-25}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                `;
                mouthContent = `
                    <path d="M${cx-6} ${cy+12} Q${cx} ${cy+6} ${cx+6} ${cy+12}" stroke="#2D1B07" stroke-width="2" fill="none" stroke-linecap="round"/>
                `;
            } else if (expression === 'eating') {
                // Eating - happy eyes, open mouth
                eyeContent = `
                    <path d="M${cx-22} ${cy-15} Q${cx-17} ${cy-25} ${cx-12} ${cy-15}" stroke="#2D1B07" stroke-width="3" fill="none" stroke-linecap="round"/>
                    <path d="M${cx+12} ${cy-15} Q${cx+17} ${cy-25} ${cx+22} ${cy-15}" stroke="#2D1B07" stroke-width="3" fill="none" stroke-linecap="round"/>
                `;
                mouthContent = `
                    <ellipse cx="${cx}" cy="${cy+10}" rx="8" ry="6" fill="#2D1B07"/>
                    <ellipse cx="${cx}" cy="${cy+8}" rx="5" ry="3" fill="#FF6B6B"/>
                `;
            } else {
                // Normal - big cute blue eyes
                eyeContent = `
                    <ellipse cx="${cx-17}" cy="${cy-12}" rx="12" ry="14" fill="white"/>
                    <ellipse cx="${cx+17}" cy="${cy-12}" rx="12" ry="14" fill="white"/>
                    <ellipse cx="${cx-17}" cy="${cy-10}" rx="8" ry="10" fill="#6BB5E0"/>
                    <ellipse cx="${cx+17}" cy="${cy-10}" rx="8" ry="10" fill="#6BB5E0"/>
                    <ellipse cx="${cx-17}" cy="${cy-10}" rx="5" ry="6" fill="#2D1B07"/>
                    <ellipse cx="${cx+17}" cy="${cy-10}" rx="5" ry="6" fill="#2D1B07"/>
                    <ellipse cx="${cx-14}" cy="${cy-14}" rx="3" ry="3" fill="white"/>
                    <ellipse cx="${cx+20}" cy="${cy-14}" rx="3" ry="3" fill="white"/>
                    <ellipse cx="${cx-19}" cy="${cy-8}" rx="1.5" ry="1.5" fill="white" opacity="0.7"/>
                    <ellipse cx="${cx+15}" cy="${cy-8}" rx="1.5" ry="1.5" fill="white" opacity="0.7"/>
                `;
                mouthContent = `
                    <path d="M${cx-5} ${cy+8} Q${cx} ${cy+12} ${cx+5} ${cy+8}" stroke="#2D1B07" stroke-width="2" fill="none" stroke-linecap="round"/>
                    <circle cx="${cx-8}" cy="${cy+10}" r="1" fill="#2D1B07"/>
                    <circle cx="${cx+8}" cy="${cy+10}" r="1" fill="#2D1B07"/>
                `;
            }
            
            return `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="cat-svg">
                    <g transform="translate(${cx}, ${cy}) scale(${scale}) translate(${-cx}, ${-cy})">
                        
                        <!-- Shadow -->
                        <ellipse cx="${cx}" cy="${size-15}" rx="35" ry="8" fill="rgba(0,0,0,0.1)"/>
                        
                        <!-- Tail with animation -->
                        <g class="cat-tail">
                            <path d="M${cx+30} ${size-40} Q${cx+55} ${size-50} ${cx+60} ${size-75} Q${cx+62} ${size-90} ${cx+55} ${size-95}" 
                                  stroke="${color}" stroke-width="14" fill="none" stroke-linecap="round"/>
                            <!-- Tail stripes -->
                            <path d="M${cx+50} ${size-60} Q${cx+55} ${size-65} ${cx+58} ${size-70}" 
                                  stroke="${darkerColor}" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.4"/>
                            <path d="M${cx+55} ${size-78} Q${cx+58} ${size-83} ${cx+57} ${size-88}" 
                                  stroke="${darkerColor}" stroke-width="4" fill="none" stroke-linecap="round" opacity="0.4"/>
                        </g>
                        
                        <!-- Back body -->
                        <ellipse cx="${cx+5}" cy="${size-50}" rx="35" ry="30" fill="${color}"/>
                        
                        <!-- Body (front) with subtle breathing -->
                        <g class="cat-body">
                            <ellipse cx="${cx}" cy="${size-55}" rx="30" ry="35" fill="${color}"/>
                            <!-- Body stripes/spots -->
                            <ellipse cx="${cx-12}" cy="${size-45}" rx="6" ry="8" fill="${darkerColor}" opacity="0.35"/>
                            <ellipse cx="${cx+10}" cy="${size-50}" rx="5" ry="6" fill="${darkerColor}" opacity="0.35"/>
                        </g>
                        
                        <!-- Front paws -->
                        <ellipse cx="${cx-15}" cy="${size-22}" rx="12" ry="8" fill="${color}"/>
                        <ellipse cx="${cx+15}" cy="${size-22}" rx="12" ry="8" fill="${color}"/>
                        <!-- Paw details -->
                        <ellipse cx="${cx-18}" cy="${size-20}" rx="3" ry="2" fill="${lighterColor}"/>
                        <ellipse cx="${cx-15}" cy="${size-19}" rx="3" ry="2" fill="${lighterColor}"/>
                        <ellipse cx="${cx-12}" cy="${size-20}" rx="3" ry="2" fill="${lighterColor}"/>
                        <ellipse cx="${cx+12}" cy="${size-20}" rx="3" ry="2" fill="${lighterColor}"/>
                        <ellipse cx="${cx+15}" cy="${size-19}" rx="3" ry="2" fill="${lighterColor}"/>
                        <ellipse cx="${cx+18}" cy="${size-20}" rx="3" ry="2" fill="${lighterColor}"/>
                        
                        <!-- Chest tuft -->
                        <ellipse cx="${cx}" cy="${size-70}" rx="18" ry="12" fill="${lighterColor}"/>
                        
                        <!-- Head -->
                        <ellipse cx="${cx}" cy="${cy}" rx="40" ry="35" fill="${color}"/>
                        
                        <!-- Head stripes -->
                        <path d="M${cx} ${cy-35} L${cx} ${cy-20}" stroke="${darkerColor}" stroke-width="4" stroke-linecap="round" opacity="0.4"/>
                        <path d="M${cx-8} ${cy-33} L${cx-6} ${cy-22}" stroke="${darkerColor}" stroke-width="3" stroke-linecap="round" opacity="0.35"/>
                        <path d="M${cx+8} ${cy-33} L${cx+6} ${cy-22}" stroke="${darkerColor}" stroke-width="3" stroke-linecap="round" opacity="0.35"/>
                        
                        <!-- Cheek patches -->
                        <ellipse cx="${cx-25}" cy="${cy+5}" rx="8" ry="6" fill="${darkerColor}" opacity="0.25"/>
                        <ellipse cx="${cx+25}" cy="${cy+5}" rx="8" ry="6" fill="${darkerColor}" opacity="0.25"/>
                        
                        <!-- Curved ears (more rounded like reference) -->
                        <g class="cat-ear-left">
                            <ellipse cx="${cx-30}" cy="${cy-32}" rx="15" ry="22" fill="${color}" transform="rotate(-15 ${cx-30} ${cy-32})"/>
                            <ellipse cx="${cx-29}" cy="${cy-30}" rx="9" ry="14" fill="${pinkColor}" transform="rotate(-15 ${cx-29} ${cy-30})"/>
                        </g>
                        <g class="cat-ear-right">
                            <ellipse cx="${cx+30}" cy="${cy-32}" rx="15" ry="22" fill="${color}" transform="rotate(15 ${cx+30} ${cy-32})"/>
                            <ellipse cx="${cx+29}" cy="${cy-30}" rx="9" ry="14" fill="${pinkColor}" transform="rotate(15 ${cx+29} ${cy-30})"/>
                        </g>
                        
                        <!-- Eyes with blink animation -->
                        <g class="cat-eyes">
                            ${eyeContent}
                        </g>
                        
                        <!-- Nose -->
                        <g class="cat-nose">
                            <ellipse cx="${cx}" cy="${cy+2}" rx="5" ry="4" fill="${pinkColor}" stroke="#2D1B07" stroke-width="1.5"/>
                        </g>
                        
                        <!-- Nose to mouth line -->
                        <line x1="${cx}" y1="${cy+6}" x2="${cx}" y2="${cy+8}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                        
                        <!-- Mouth -->
                        ${mouthContent}
                        
                        <!-- Whiskers with subtle animation -->
                        <g class="cat-whiskers-left">
                            <line x1="${cx-15}" y1="${cy+5}" x2="${cx-45}" y2="${cy-2}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                            <line x1="${cx-15}" y1="${cy+8}" x2="${cx-45}" y2="${cy+8}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                            <line x1="${cx-15}" y1="${cy+11}" x2="${cx-45}" y2="${cy+18}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                        </g>
                        <g class="cat-whiskers-right">
                            <line x1="${cx+15}" y1="${cy+5}" x2="${cx+45}" y2="${cy-2}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                            <line x1="${cx+15}" y1="${cy+8}" x2="${cx+45}" y2="${cy+8}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                            <line x1="${cx+15}" y1="${cy+11}" x2="${cx+45}" y2="${cy+18}" stroke="#2D1B07" stroke-width="2" stroke-linecap="round"/>
                        </g>
                        
                        ${stage === 3 ? `
                            <!-- Crown for adult cat -->
                            <g transform="translate(${cx}, ${cy-58})">
                                <polygon points="-15,5 -10,-12 -5,2 0,-18 5,2 10,-12 15,5" fill="#FFD700" stroke="#FFA500" stroke-width="2"/>
                                <circle cx="0" cy="-10" r="3" fill="#E74C3C"/>
                                <circle cx="-8" cy="-5" r="2" fill="#3498DB"/>
                                <circle cx="8" cy="-5" r="2" fill="#2ECC71"/>
                            </g>
                        ` : ''}
                    </g>
                </svg>
            `;
        }
        
        // Helper function to lighten a color
        function lightenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (
                0x1000000 +
                (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
                (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
                (B < 255 ? (B < 1 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }
        
        // Helper function to darken a color
        function darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return '#' + (
                0x1000000 +
                (R > 0 ? R : 0) * 0x10000 +
                (G > 0 ? G : 0) * 0x100 +
                (B > 0 ? B : 0)
            ).toString(16).slice(1);
        }
        
        // ============ PARROT SVG FOR PIRATE THEME ============
        function getParrotSVG(stage, expression = 'normal', parrotColor = null) {
            const color = parrotColor || gameState.catColor || '#2ECC71'; // Default green
            const lighterColor = lightenColor(color, 30);
            const darkerColor = darkenColor(color, 20);
            
            let size, scale;
            switch(stage) {
                case 0: size = 160; scale = 0.5; break;  // Baby egg/chick
                case 1: size = 160; scale = 0.7; break;  // Young parrot
                case 2: size = 180; scale = 0.85; break; // Teen parrot
                case 3: size = 200; scale = 1; break;    // Adult captain parrot
            }
            
            const cx = size / 2;
            const cy = size / 2;
            
            // Stage 0: Baby parrot in egg/just hatched
            if (stage === 0) {
                return `
                    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="parrot-svg">
                        <g transform="translate(${cx}, ${cy + 15}) scale(${scale}) translate(${-cx}, ${-cy})">
                            <!-- Shadow -->
                            <ellipse cx="${cx}" cy="${cy + 50}" rx="35" ry="10" fill="rgba(0,0,0,0.1)"/>
                            
                            <!-- Cracked egg shell bottom -->
                            <ellipse cx="${cx}" cy="${cy + 25}" rx="35" ry="25" fill="#F5F5DC"/>
                            <path d="M${cx-35} ${cy+10} Q${cx-20} ${cy+5} ${cx-10} ${cy+15} Q${cx} ${cy} ${cx+15} ${cy+12} Q${cx+25} ${cy+5} ${cx+35} ${cy+10}" 
                                  fill="#F5F5DC" stroke="#DDD" stroke-width="2"/>
                            
                            <!-- Baby parrot body -->
                            <ellipse cx="${cx}" cy="${cy}" rx="25" ry="22" fill="${color}"/>
                            
                            <!-- Fluffy head feathers -->
                            <circle cx="${cx}" cy="${cy - 15}" r="18" fill="${color}"/>
                            <ellipse cx="${cx - 8}" cy="${cy - 28}" rx="5" ry="8" fill="${lighterColor}"/>
                            <ellipse cx="${cx + 8}" cy="${cy - 28}" rx="5" ry="8" fill="${lighterColor}"/>
                            
                            <!-- Big baby eyes -->
                            <ellipse cx="${cx - 8}" cy="${cy - 15}" rx="8" ry="9" fill="white"/>
                            <ellipse cx="${cx + 8}" cy="${cy - 15}" rx="8" ry="9" fill="white"/>
                            <circle cx="${cx - 6}" cy="${cy - 14}" r="5" fill="#2D1B07"/>
                            <circle cx="${cx + 10}" cy="${cy - 14}" r="5" fill="#2D1B07"/>
                            <circle cx="${cx - 4}" cy="${cy - 16}" r="2" fill="white"/>
                            <circle cx="${cx + 12}" cy="${cy - 16}" r="2" fill="white"/>
                            
                            <!-- Small beak -->
                            <path d="M${cx - 5} ${cy - 5} Q${cx} ${cy + 5} ${cx + 5} ${cy - 5} Q${cx} ${cy - 8} ${cx - 5} ${cy - 5}" 
                                  fill="#F39C12" stroke="#E67E22" stroke-width="1"/>
                            
                            <!-- Tiny wings -->
                            <ellipse cx="${cx - 20}" cy="${cy + 5}" rx="8" ry="12" fill="${darkerColor}" transform="rotate(-20 ${cx-20} ${cy+5})"/>
                            <ellipse cx="${cx + 20}" cy="${cy + 5}" rx="8" ry="12" fill="${darkerColor}" transform="rotate(20 ${cx+20} ${cy+5})"/>
                            
                            <!-- Zzz for sleeping -->
                            <text x="${cx + 25}" y="${cy - 25}" font-family="Fredoka" font-size="12" fill="#8B4513" opacity="0.7">z</text>
                            <text x="${cx + 33}" y="${cy - 35}" font-family="Fredoka" font-size="16" fill="#8B4513" opacity="0.5">z</text>
                        </g>
                    </svg>
                `;
            }
            
            // Expressions
            let eyeContent = '';
            let beakContent = '';
            
            if (expression === 'happy') {
                eyeContent = `
                    <path d="M${cx-15} ${cy-18} Q${cx-10} ${cy-28} ${cx-5} ${cy-18}" stroke="#2D1B07" stroke-width="3" fill="none" stroke-linecap="round"/>
                    <path d="M${cx+5} ${cy-18} Q${cx+10} ${cy-28} ${cx+15} ${cy-18}" stroke="#2D1B07" stroke-width="3" fill="none" stroke-linecap="round"/>
                `;
                beakContent = `
                    <path d="M${cx - 8} ${cy - 5} Q${cx} ${cy + 10} ${cx + 8} ${cy - 5} Q${cx} ${cy - 12} ${cx - 8} ${cy - 5}" 
                          fill="#F39C12" stroke="#E67E22" stroke-width="2"/>
                    <path d="M${cx - 3} ${cy + 3} Q${cx} ${cy + 6} ${cx + 3} ${cy + 3}" stroke="#E67E22" stroke-width="1.5" fill="none"/>
                `;
            } else if (expression === 'sad') {
                eyeContent = `
                    <ellipse cx="${cx-10}" cy="${cy-18}" rx="8" ry="10" fill="white"/>
                    <ellipse cx="${cx+10}" cy="${cy-18}" rx="8" ry="10" fill="white"/>
                    <circle cx="${cx-8}" cy="${cy-16}" r="5" fill="#2D1B07"/>
                    <circle cx="${cx+12}" cy="${cy-16}" r="5" fill="#2D1B07"/>
                    <path d="M${cx-18} ${cy-28} L${cx-5} ${cy-24}" stroke="#2D1B07" stroke-width="2"/>
                    <path d="M${cx+18} ${cy-28} L${cx+5} ${cy-24}" stroke="#2D1B07" stroke-width="2"/>
                `;
                beakContent = `
                    <path d="M${cx - 8} ${cy - 5} Q${cx} ${cy + 8} ${cx + 8} ${cy - 5} Q${cx} ${cy - 12} ${cx - 8} ${cy - 5}" 
                          fill="#F39C12" stroke="#E67E22" stroke-width="2"/>
                `;
            } else {
                eyeContent = `
                    <ellipse cx="${cx-10}" cy="${cy-18}" rx="9" ry="11" fill="white"/>
                    <ellipse cx="${cx+10}" cy="${cy-18}" rx="9" ry="11" fill="white"/>
                    <circle cx="${cx-8}" cy="${cy-16}" r="6" fill="#2D1B07"/>
                    <circle cx="${cx+12}" cy="${cy-16}" r="6" fill="#2D1B07"/>
                    <circle cx="${cx-6}" cy="${cy-18}" r="2" fill="white"/>
                    <circle cx="${cx+14}" cy="${cy-18}" r="2" fill="white"/>
                `;
                beakContent = `
                    <path d="M${cx - 8} ${cy - 5} Q${cx} ${cy + 10} ${cx + 8} ${cy - 5} Q${cx} ${cy - 12} ${cx - 8} ${cy - 5}" 
                          fill="#F39C12" stroke="#E67E22" stroke-width="2"/>
                `;
            }
            
            // Pirate hat for stages 1+
            const pirateHat = stage >= 1 ? `
                <g transform="translate(${cx}, ${cy - 45})">
                    <!-- Hat base -->
                    <ellipse cx="0" cy="8" rx="${20 + stage * 5}" ry="8" fill="#2C3E50"/>
                    <!-- Hat top -->
                    <path d="M${-18 - stage*3} 5 Q${-25 - stage*3} ${-15 - stage*5} 0 ${-20 - stage*6} Q${25 + stage*3} ${-15 - stage*5} ${18 + stage*3} 5" 
                          fill="#2C3E50" stroke="#1a252f" stroke-width="2"/>
                    <!-- Skull and crossbones -->
                    <text x="0" y="${-5 - stage*2}" text-anchor="middle" font-size="${12 + stage*2}" fill="white">‚ò†Ô∏è</text>
                    ${stage === 3 ? `
                        <!-- Gold trim for captain -->
                        <path d="M${-20} 5 Q${-28} ${-18} 0 ${-25} Q${28} ${-18} ${20} 5" 
                              fill="none" stroke="#FFD700" stroke-width="3"/>
                        <!-- Feather -->
                        <ellipse cx="18" cy="-15" rx="4" ry="15" fill="#E74C3C" transform="rotate(20 18 -15)"/>
                    ` : ''}
                </g>
            ` : '';
            
            // Wing detail increases with stage
            const wingDetail = stage >= 2 ? `
                <path d="M${cx-35} ${cy+15} Q${cx-45} ${cy+25} ${cx-40} ${cy+40}" stroke="${darkerColor}" stroke-width="3" fill="none"/>
                <path d="M${cx+35} ${cy+15} Q${cx+45} ${cy+25} ${cx+40} ${cy+40}" stroke="${darkerColor}" stroke-width="3" fill="none"/>
            ` : '';
            
            return `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="parrot-svg">
                    <g transform="translate(${cx}, ${cy + 10}) scale(${scale}) translate(${-cx}, ${-cy})">
                        <!-- Shadow -->
                        <ellipse cx="${cx}" cy="${cy + 55}" rx="${30 + stage*5}" ry="10" fill="rgba(0,0,0,0.1)"/>
                        
                        <!-- Tail feathers -->
                        <g class="parrot-tail">
                            <ellipse cx="${cx - 8}" cy="${cy + 45}" rx="6" ry="20" fill="${darkerColor}" transform="rotate(-10 ${cx-8} ${cy+45})"/>
                            <ellipse cx="${cx}" cy="${cy + 48}" rx="6" ry="22" fill="${color}"/>
                            <ellipse cx="${cx + 8}" cy="${cy + 45}" rx="6" ry="20" fill="${darkerColor}" transform="rotate(10 ${cx+8} ${cy+45})"/>
                            ${stage >= 2 ? `
                                <ellipse cx="${cx - 15}" cy="${cy + 42}" rx="5" ry="18" fill="#E74C3C" transform="rotate(-15 ${cx-15} ${cy+42})"/>
                                <ellipse cx="${cx + 15}" cy="${cy + 42}" rx="5" ry="18" fill="#3498DB" transform="rotate(15 ${cx+15} ${cy+42})"/>
                            ` : ''}
                        </g>
                        
                        <!-- Body -->
                        <ellipse cx="${cx}" cy="${cy + 15}" rx="${25 + stage*3}" ry="${30 + stage*3}" fill="${color}"/>
                        
                        <!-- Belly -->
                        <ellipse cx="${cx}" cy="${cy + 20}" rx="${18 + stage*2}" ry="${22 + stage*2}" fill="${lighterColor}"/>
                        
                        <!-- Wings -->
                        <ellipse cx="${cx - 28 - stage*3}" cy="${cy + 10}" rx="${12 + stage*2}" ry="${22 + stage*3}" fill="${darkerColor}" transform="rotate(-15 ${cx-28-stage*3} ${cy+10})"/>
                        <ellipse cx="${cx + 28 + stage*3}" cy="${cy + 10}" rx="${12 + stage*2}" ry="${22 + stage*3}" fill="${darkerColor}" transform="rotate(15 ${cx+28+stage*3} ${cy+10})"/>
                        ${wingDetail}
                        
                        <!-- Head -->
                        <circle cx="${cx}" cy="${cy - 15}" r="${22 + stage*2}" fill="${color}"/>
                        
                        <!-- Head feathers/crest -->
                        <ellipse cx="${cx - 10}" cy="${cy - 35 - stage*2}" rx="6" ry="12" fill="${stage >= 2 ? '#E74C3C' : lighterColor}"/>
                        <ellipse cx="${cx}" cy="${cy - 38 - stage*2}" rx="5" ry="14" fill="${stage >= 2 ? '#F39C12' : color}"/>
                        <ellipse cx="${cx + 10}" cy="${cy - 35 - stage*2}" rx="6" ry="12" fill="${stage >= 2 ? '#3498DB' : lighterColor}"/>
                        
                        <!-- Eyes -->
                        ${eyeContent}
                        
                        <!-- Beak -->
                        ${beakContent}
                        
                        <!-- Feet -->
                        <g fill="#F39C12" stroke="#E67E22" stroke-width="1">
                            <ellipse cx="${cx - 12}" cy="${cy + 48}" rx="8" ry="4"/>
                            <ellipse cx="${cx + 12}" cy="${cy + 48}" rx="8" ry="4"/>
                        </g>
                        
                        <!-- Pirate hat -->
                        ${pirateHat}
                        
                        ${stage === 3 ? `
                            <!-- Eye patch for captain (optional flair) -->
                            <ellipse cx="${cx + 10}" cy="${cy - 18}" rx="10" ry="12" fill="#2C3E50"/>
                            <line x1="${cx + 20}" y1="${cy - 25}" x2="${cx + 35}" y2="${cy - 40}" stroke="#2C3E50" stroke-width="2"/>
                            <!-- Gold earring -->
                            <circle cx="${cx - 28}" cy="${cy - 8}" r="4" fill="#FFD700" stroke="#FFA500" stroke-width="1"/>
                        ` : ''}
                    </g>
                </svg>
            `;
        }
        
        // ============ SPACESHIP SVG FOR SPACE THEME ============
        function getSpaceshipSVG(stage, expression = 'normal', shipColor = null) {
            const color = shipColor || gameState.catColor || '#3498DB';
            const lighterColor = lightenColor(color, 30);
            const darkerColor = darkenColor(color, 20);
            
            let size = 200;
            const cx = size / 2;
            const cy = size / 2;
            
            // Flame color based on expression
            const flameColor = expression === 'happy' ? '#2ECC71' : expression === 'sad' ? '#E74C3C' : '#F39C12';
            const flameColor2 = expression === 'happy' ? '#27AE60' : expression === 'sad' ? '#C0392B' : '#E67E22';
            
            // Stage 0: Small satellite probe
            if (stage === 0) {
                return `
                    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="ship-svg">
                        <g transform="translate(${cx}, ${cy})">
                            <!-- Orbit ring -->
                            <ellipse cx="0" cy="0" rx="50" ry="15" fill="none" stroke="#00D4FF" stroke-width="1" opacity="0.3" transform="rotate(-20)">
                                <animateTransform attributeName="transform" type="rotate" from="-20" to="340" dur="10s" repeatCount="indefinite"/>
                            </ellipse>
                            
                            <!-- Main body -->
                            <rect x="-15" y="-20" width="30" height="40" rx="5" fill="${color}"/>
                            <rect x="-12" y="-17" width="24" height="20" rx="3" fill="${lighterColor}" opacity="0.5"/>
                            
                            <!-- Solar panels -->
                            <rect x="-45" y="-5" width="25" height="10" fill="#1a1a4e" stroke="#00D4FF" stroke-width="1"/>
                            <rect x="20" y="-5" width="25" height="10" fill="#1a1a4e" stroke="#00D4FF" stroke-width="1"/>
                            <!-- Panel lines -->
                            <line x1="-40" y1="-5" x2="-40" y2="5" stroke="#00D4FF" stroke-width="0.5" opacity="0.5"/>
                            <line x1="-32" y1="-5" x2="-32" y2="5" stroke="#00D4FF" stroke-width="0.5" opacity="0.5"/>
                            <line x1="25" y1="-5" x2="25" y2="5" stroke="#00D4FF" stroke-width="0.5" opacity="0.5"/>
                            <line x1="33" y1="-5" x2="33" y2="5" stroke="#00D4FF" stroke-width="0.5" opacity="0.5"/>
                            
                            <!-- Zzz for sleeping/idle -->
                            <text x="20" y="-30" font-family="Fredoka" font-size="12" fill="#00D4FF" opacity="0.7">z</text>
                            <text x="30" y="-40" font-family="Fredoka" font-size="16" fill="#00D4FF" opacity="0.5">z</text>
                        </g>
                    </svg>
                `;
            }
            
            // Stage 1: Basic rocket
            if (stage === 1) {
                return `
                    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="ship-svg">
                        <g transform="translate(${cx}, ${cy + 20})">
                            <!-- Flame -->
                            <ellipse cx="0" cy="50" rx="12" ry="20" fill="${flameColor}" opacity="0.9">
                                <animate attributeName="ry" values="20;28;20" dur="0.3s" repeatCount="indefinite"/>
                            </ellipse>
                            <ellipse cx="0" cy="48" rx="8" ry="15" fill="${flameColor2}">
                                <animate attributeName="ry" values="15;20;15" dur="0.25s" repeatCount="indefinite"/>
                            </ellipse>
                            
                            <!-- Fins -->
                            <polygon points="-25,40 -15,10 -15,40" fill="${darkerColor}"/>
                            <polygon points="25,40 15,10 15,40" fill="${darkerColor}"/>
                            
                            <!-- Body -->
                            <ellipse cx="0" cy="20" rx="18" ry="30" fill="${color}"/>
                            <ellipse cx="-5" cy="15" rx="5" ry="20" fill="${lighterColor}" opacity="0.4"/>
                            
                            <!-- Nose cone -->
                            <ellipse cx="0" cy="-20" rx="12" ry="20" fill="${color}"/>
                            <ellipse cx="0" cy="-25" rx="8" ry="12" fill="${lighterColor}" opacity="0.4"/>
                            
                            <!-- Window -->
                            <circle cx="0" cy="5" r="8" fill="#1a1a4e" stroke="#00D4FF" stroke-width="2"/>
                            <circle cx="-2" cy="3" r="3" fill="rgba(255,255,255,0.3)"/>
                        </g>
                    </svg>
                `;
            }
            
            // Stage 2: Medium rocket with boosters
            if (stage === 2) {
                return `
                    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="ship-svg">
                        <g transform="translate(${cx}, ${cy + 15})">
                            <!-- Side booster flames -->
                            <ellipse cx="-30" cy="55" rx="8" ry="15" fill="${flameColor}" opacity="0.8">
                                <animate attributeName="ry" values="15;22;15" dur="0.35s" repeatCount="indefinite"/>
                            </ellipse>
                            <ellipse cx="30" cy="55" rx="8" ry="15" fill="${flameColor}" opacity="0.8">
                                <animate attributeName="ry" values="15;22;15" dur="0.35s" repeatCount="indefinite"/>
                            </ellipse>
                            
                            <!-- Main flame -->
                            <ellipse cx="0" cy="55" rx="15" ry="25" fill="${flameColor}" opacity="0.9">
                                <animate attributeName="ry" values="25;35;25" dur="0.3s" repeatCount="indefinite"/>
                            </ellipse>
                            <ellipse cx="0" cy="52" rx="10" ry="18" fill="${flameColor2}">
                                <animate attributeName="ry" values="18;25;18" dur="0.25s" repeatCount="indefinite"/>
                            </ellipse>
                            
                            <!-- Side boosters -->
                            <rect x="-38" y="10" width="16" height="45" rx="8" fill="${darkerColor}"/>
                            <rect x="22" y="10" width="16" height="45" rx="8" fill="${darkerColor}"/>
                            
                            <!-- Main fins -->
                            <polygon points="-30,45 -22,0 -22,45" fill="${darkerColor}"/>
                            <polygon points="30,45 22,0 22,45" fill="${darkerColor}"/>
                            
                            <!-- Main body -->
                            <rect x="-22" y="-20" width="44" height="70" rx="22" fill="${color}"/>
                            <rect x="-18" y="-15" width="10" height="55" rx="5" fill="${lighterColor}" opacity="0.3"/>
                            
                            <!-- Nose cone -->
                            <ellipse cx="0" cy="-35" rx="15" ry="25" fill="${color}"/>
                            <ellipse cx="-4" cy="-40" rx="5" ry="15" fill="${lighterColor}" opacity="0.3"/>
                            
                            <!-- Windows -->
                            <circle cx="0" cy="-5" r="10" fill="#1a1a4e" stroke="#00D4FF" stroke-width="2"/>
                            <circle cx="-3" cy="-7" r="4" fill="rgba(255,255,255,0.3)"/>
                            <circle cx="0" cy="20" r="7" fill="#1a1a4e" stroke="#00D4FF" stroke-width="1.5"/>
                            
                            <!-- Racing stripes -->
                            <line x1="-15" y1="-50" x2="-15" y2="45" stroke="#FFD700" stroke-width="2"/>
                            <line x1="15" y1="-50" x2="15" y2="45" stroke="#FFD700" stroke-width="2"/>
                        </g>
                    </svg>
                `;
            }
            
            // Stage 3: Full spacecraft/shuttle
            return `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="ship-svg">
                    <g transform="translate(${cx}, ${cy + 10})">
                        <!-- Shield glow effect -->
                        <ellipse cx="0" cy="0" rx="70" ry="80" fill="none" stroke="#00D4FF" stroke-width="2" opacity="0.2">
                            <animate attributeName="opacity" values="0.2;0.4;0.2" dur="2s" repeatCount="indefinite"/>
                        </ellipse>
                        
                        <!-- Side booster flames -->
                        <ellipse cx="-40" cy="60" rx="10" ry="18" fill="${flameColor}" opacity="0.8">
                            <animate attributeName="ry" values="18;28;18" dur="0.3s" repeatCount="indefinite"/>
                        </ellipse>
                        <ellipse cx="40" cy="60" rx="10" ry="18" fill="${flameColor}" opacity="0.8">
                            <animate attributeName="ry" values="18;28;18" dur="0.3s" repeatCount="indefinite"/>
                        </ellipse>
                        
                        <!-- Main engine flames -->
                        <ellipse cx="-12" cy="58" rx="10" ry="22" fill="${flameColor}" opacity="0.9">
                            <animate attributeName="ry" values="22;32;22" dur="0.28s" repeatCount="indefinite"/>
                        </ellipse>
                        <ellipse cx="12" cy="58" rx="10" ry="22" fill="${flameColor}" opacity="0.9">
                            <animate attributeName="ry" values="22;32;22" dur="0.32s" repeatCount="indefinite"/>
                        </ellipse>
                        <ellipse cx="0" cy="60" rx="12" ry="28" fill="${flameColor2}">
                            <animate attributeName="ry" values="28;40;28" dur="0.25s" repeatCount="indefinite"/>
                        </ellipse>
                        
                        <!-- Large side boosters -->
                        <rect x="-52" y="0" width="20" height="55" rx="10" fill="${darkerColor}"/>
                        <rect x="32" y="0" width="20" height="55" rx="10" fill="${darkerColor}"/>
                        <ellipse cx="-42" cy="0" rx="10" ry="15" fill="${darkerColor}"/>
                        <ellipse cx="42" cy="0" rx="10" ry="15" fill="${darkerColor}"/>
                        
                        <!-- Wings -->
                        <polygon points="-55,50 -28,10 -28,50" fill="${darkerColor}"/>
                        <polygon points="55,50 28,10 28,50" fill="${darkerColor}"/>
                        <polygon points="-60,55 -35,25 -35,55" fill="${color}" opacity="0.7"/>
                        <polygon points="60,55 35,25 35,55" fill="${color}" opacity="0.7"/>
                        
                        <!-- Main body -->
                        <rect x="-28" y="-30" width="56" height="85" rx="28" fill="${color}"/>
                        <rect x="-22" y="-25" width="12" height="70" rx="6" fill="${lighterColor}" opacity="0.3"/>
                        
                        <!-- Nose cone -->
                        <ellipse cx="0" cy="-50" rx="20" ry="35" fill="${color}"/>
                        <ellipse cx="-6" cy="-55" rx="6" ry="20" fill="${lighterColor}" opacity="0.3"/>
                        
                        <!-- Cockpit windows -->
                        <ellipse cx="0" cy="-35" rx="12" ry="15" fill="#1a1a4e" stroke="#00D4FF" stroke-width="2"/>
                        <ellipse cx="-4" cy="-38" rx="5" ry="7" fill="rgba(255,255,255,0.3)"/>
                        
                        <!-- Side windows -->
                        <circle cx="-18" cy="0" r="6" fill="#1a1a4e" stroke="#00D4FF" stroke-width="1.5"/>
                        <circle cx="18" cy="0" r="6" fill="#1a1a4e" stroke="#00D4FF" stroke-width="1.5"/>
                        <circle cx="0" cy="15" r="8" fill="#1a1a4e" stroke="#00D4FF" stroke-width="2"/>
                        
                        <!-- Admiral stars -->
                        <text x="-8" y="38" font-size="14" fill="#FFD700">‚≠ê</text>
                        <text x="2" y="38" font-size="14" fill="#FFD700">‚≠ê</text>
                        
                        <!-- Racing stripes -->
                        <line x1="-18" y1="-75" x2="-18" y2="50" stroke="#FFD700" stroke-width="3"/>
                        <line x1="18" y1="-75" x2="18" y2="50" stroke="#FFD700" stroke-width="3"/>
                    </g>
                </svg>
            `;
        }
        
        // ============ CHARACTER SVG WRAPPER ============
        function getCharacterSVG(stage, expression = 'normal', color = null) {
            const theme = gameState.currentTheme;
            if (theme === 'pirate') {
                return getParrotSVG(stage, expression, color);
            } else if (theme === 'space') {
                return getSpaceshipSVG(stage, expression, color);
            } else {
                return getCatSVG(stage, expression, color);
            }
        }
        
        // ============ INITIALIZATION ============
        function init() {
            createBubbles();
            createStars();
            createGrass();
            updateCatPreview();
            updateTricksList();
            
            // Initialize first cat in cats array
            if (gameState.cats.length === 0) {
                gameState.cats.push({
                    name: gameState.catName,
                    color: gameState.catColor,
                    xp: 0,
                    stage: 0,
                    score: 0,
                    totalCorrect: 0
                });
            }
            
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkAnswer();
            });
            
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            
            // Close tricks panel when clicking outside
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('tricksPanel');
                const btn = document.querySelector('.tricks-btn');
                if (panel && !panel.contains(e.target) && e.target !== btn) {
                    panel.classList.remove('show');
                }
            });
        }
        
        function selectColor(color) {
            gameState.catColor = color;
            
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-color="${color}"]`).classList.add('active');
            
            // Update the color preview in the button
            const colorPreview = document.getElementById('colorPreview');
            if (colorPreview) colorPreview.style.background = color;
            
            updateCatPreview();
            playSound('click');
        }
        
        function toggleHowToPlay() {
            const content = document.getElementById('howToPlayContent');
            const btn = document.getElementById('howToPlayBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.classList.add('expanded');
            } else {
                content.style.display = 'none';
                btn.classList.remove('expanded');
            }
            playSound('click');
        }
        
        function toggleColorPicker() {
            const content = document.getElementById('colorPickerContent');
            const btn = document.getElementById('colorPickerBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.classList.add('expanded');
            } else {
                content.style.display = 'none';
                btn.classList.remove('expanded');
            }
            playSound('click');
        }
        
        function toggleTopicPicker() {
            const content = document.getElementById('topicPickerContent');
            const btn = document.getElementById('topicPickerBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.classList.add('expanded');
            } else {
                content.style.display = 'none';
                btn.classList.remove('expanded');
            }
            playSound('click');
        }
        
        function selectTheme(themeName) {
            gameState.currentTheme = themeName;
            const theme = getTheme();
            
            // Update theme button states
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-theme="${themeName}"]`).classList.add('active');
            
            // Update title
            const titleEl = document.getElementById('gameTitle');
            if (titleEl) titleEl.innerHTML = `üåü Welcome to ${theme.name}! üåü`;
            
            // Update instructions based on theme
            const goalText = document.getElementById('goalText');
            const characterEmoji = document.getElementById('characterEmoji');
            const characterType = document.getElementById('characterType');
            const hungerName = document.getElementById('hungerName');
            const hungerEmoji = document.getElementById('hungerEmoji');
            const thirstName = document.getElementById('thirstName');
            const thirstEmoji = document.getElementById('thirstEmoji');
            const happinessName = document.getElementById('happinessName');
            const happinessEmoji = document.getElementById('happinessEmoji');
            const characterTypeLower = document.getElementById('characterTypeLower');
            const characterTypeLower2 = document.getElementById('characterTypeLower2');
            const characterTypeLower3 = document.getElementById('characterTypeLower3');
            const actionText = document.getElementById('actionText');
            const previewText = document.getElementById('previewText');
            const nameLabel = document.getElementById('nameLabel');
            const colorLabel = document.getElementById('colorLabel');
            const stage1Badge = document.getElementById('stage1Badge');
            const stage2Badge = document.getElementById('stage2Badge');
            const stage3Badge = document.getElementById('stage3Badge');
            const previewContainer = document.getElementById('previewContainer');
            
            if (goalText) goalText.textContent = `Keep your ${theme.characterName} happy and healthy!`;
            if (characterEmoji) characterEmoji.textContent = theme.emoji;
            if (characterType) characterType.textContent = theme.characterName.charAt(0).toUpperCase() + theme.characterName.slice(1);
            if (hungerName) hungerName.textContent = theme.stats.hunger.name;
            if (hungerEmoji) hungerEmoji.textContent = theme.stats.hunger.emoji;
            if (thirstName) thirstName.textContent = theme.stats.thirst.name;
            if (thirstEmoji) thirstEmoji.textContent = theme.stats.thirst.emoji;
            if (happinessName) happinessName.textContent = theme.stats.happiness.name;
            if (happinessEmoji) happinessEmoji.textContent = theme.stats.happiness.emoji;
            if (characterTypeLower) characterTypeLower.textContent = theme.characterName;
            if (characterTypeLower2) characterTypeLower2.textContent = theme.characterName;
            if (characterTypeLower3) characterTypeLower3.textContent = theme.characterName;
            if (actionText) actionText.textContent = `${theme.actions.feed.name.toLowerCase()}, ${theme.actions.water.name.toLowerCase()}, or ${theme.actions.play.name.toLowerCase()} with your ${theme.characterName}`;
            if (previewText) previewText.textContent = `Your New ${theme.stageNames[1]}!`;
            if (previewText) {
                if (themeName === 'space') {
                    previewText.classList.add('dark-bg');
                } else {
                    previewText.classList.remove('dark-bg');
                }
            }
            if (nameLabel) nameLabel.textContent = `Name Your ${theme.stageNames[1]}`;
            if (colorLabel) colorLabel.textContent = `Choose Color`;
            if (stage1Badge) stage1Badge.textContent = theme.stageNames[1];
            if (stage2Badge) stage2Badge.textContent = theme.stageNames[2];
            if (stage3Badge) stage3Badge.textContent = theme.stageNames[3];
            if (previewContainer) previewContainer.style.background = theme.colors.stageBg;
            
            // Update name input placeholder
            const nameInput = document.getElementById('catNameInput');
            if (nameInput) nameInput.placeholder = `Enter ${theme.characterName} name...`;
            
            // Update main header title and subtitle
            const headerTitle = document.getElementById('gameHeaderTitle');
            const headerSubtitle = document.getElementById('gameHeaderSubtitle');
            if (headerTitle) headerTitle.innerHTML = `${theme.emoji} ${theme.name}`;
            if (headerSubtitle) headerSubtitle.textContent = theme.subtitle;
            
            // Update the character preview
            updateCatPreview();
            
            playSound('click');
        }
        
        function updateCatPreview() {
            const preview = document.getElementById('catPreview');
            if (preview) {
                preview.innerHTML = getCharacterSVG(1, 'happy', gameState.catColor);
            }
        }
        
        function createBubbles() {
            const container = document.getElementById('bubbles');
            const colors = ['#FFB6C1', '#87CEEB', '#98FB98', '#DDA0DD', '#F0E68C', '#FFB347'];
            
            for (let i = 0; i < 20; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.style.left = Math.random() * 100 + '%';
                bubble.style.top = Math.random() * 100 + '%';
                bubble.style.width = (Math.random() * 40 + 20) + 'px';
                bubble.style.height = bubble.style.width;
                bubble.style.background = colors[Math.floor(Math.random() * colors.length)];
                bubble.style.animationDelay = Math.random() * 5 + 's';
                bubble.style.animationDuration = (Math.random() * 5 + 5) + 's';
                container.appendChild(bubble);
            }
        }
        
        function createStars() {
            const container = document.getElementById('stars');
            const starEmojis = ['‚≠ê', '‚ú®', 'üåü', 'üí´'];
            
            for (let i = 0; i < 15; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.textContent = starEmojis[Math.floor(Math.random() * starEmojis.length)];
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(star);
            }
        }
        
        function createGrass() {
            const grass = document.getElementById('grass');
            if (!grass) return;
            // Only add blades if not already populated
            if (grass.children.length < 20) {
                for (let i = grass.children.length; i < 35; i++) {
                    const blade = document.createElement('div');
                    blade.className = 'grass-blade';
                    blade.style.animationDelay = Math.random() * 2 + 's';
                    blade.style.height = (15 + Math.random() * 15) + 'px';
                    grass.appendChild(blade);
                }
            }
        }
        
        // ============ GAME FUNCTIONS ============
        function startGame() {
            const theme = getTheme();
            const nameInput = document.getElementById('catNameInput');
            gameState.catName = nameInput.value.trim() || theme.defaultName;
            
            // Save cat data
            saveCatData();
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            const catNameEl = document.getElementById('catNameDisplay');
            if (catNameEl) catNameEl.textContent = gameState.catName;
            
            // Update all themed UI elements
            updateThemedUI();
            
            updateCatDisplay();
            updateAllBars();
            updateTricksList();
            updateEvolutionDisplay();
            
            // Create grass blades after display updates
            createGrass();
            
            playSound('meow');
            
            // Start stat decay
            setInterval(decayStats, 5000);
        }
        
        // Update all UI elements based on current theme
        function updateThemedUI() {
            const theme = getTheme();
            
            // Update action buttons
            const feedBtn = document.getElementById('feedBtnText');
            const waterBtn = document.getElementById('waterBtnText');
            const playBtn = document.getElementById('playBtnText');
            
            if (feedBtn) feedBtn.textContent = `${theme.actions.feed.emoji} ${theme.actions.feed.name}`;
            if (waterBtn) waterBtn.textContent = `${theme.actions.water.emoji} ${theme.actions.water.name}`;
            if (playBtn) playBtn.textContent = `${theme.actions.play.emoji} ${theme.actions.play.name}`;
            
            // Update mini stat bar icons
            const healthIconMini = document.getElementById('healthIconMini');
            const hungerIconMini = document.getElementById('hungerIconMini');
            const thirstIconMini = document.getElementById('thirstIconMini');
            const happinessIconMini = document.getElementById('happinessIconMini');
            
            if (healthIconMini) healthIconMini.textContent = theme.stats.health.emoji;
            if (hungerIconMini) hungerIconMini.textContent = theme.stats.hunger.emoji;
            if (thirstIconMini) thirstIconMini.textContent = theme.stats.thirst.emoji;
            if (happinessIconMini) happinessIconMini.textContent = theme.stats.happiness.emoji;
            
            // Update full stat bar icons and labels
            const healthIconFull = document.getElementById('healthIconFull');
            const hungerIconFull = document.getElementById('hungerIconFull');
            const thirstIconFull = document.getElementById('thirstIconFull');
            const happinessIconFull = document.getElementById('happinessIconFull');
            const healthNameFull = document.getElementById('healthNameFull');
            const hungerNameFull = document.getElementById('hungerNameFull');
            const thirstNameFull = document.getElementById('thirstNameFull');
            const happinessNameFull = document.getElementById('happinessNameFull');
            
            if (healthIconFull) healthIconFull.textContent = theme.stats.health.emoji;
            if (hungerIconFull) hungerIconFull.textContent = theme.stats.hunger.emoji;
            if (thirstIconFull) thirstIconFull.textContent = theme.stats.thirst.emoji;
            if (happinessIconFull) happinessIconFull.textContent = theme.stats.happiness.emoji;
            if (healthNameFull) healthNameFull.textContent = theme.stats.health.name;
            if (hungerNameFull) hungerNameFull.textContent = theme.stats.hunger.name;
            if (thirstNameFull) thirstNameFull.textContent = theme.stats.thirst.name;
            if (happinessNameFull) happinessNameFull.textContent = theme.stats.happiness.name;
            
            // Update game header title
            const gameHeaderTitle = document.getElementById('gameHeaderTitle');
            const gameHeaderSubtitle = document.getElementById('gameHeaderSubtitle');
            if (gameHeaderTitle) gameHeaderTitle.innerHTML = `${theme.emoji} ${theme.name}`;
            if (gameHeaderSubtitle) gameHeaderSubtitle.textContent = theme.subtitle;
            
            // Update page title
            document.title = `${theme.emoji} ${theme.name} - ${theme.subtitle}`;
        }
        
        function restartGame() {
            gameState.health = 100;
            gameState.hunger = 100;
            gameState.thirst = 100;
            gameState.happiness = 100;
            gameState.score = 0;
            gameState.streak = 0;
            gameState.correct = 0;
            gameState.xp = 0;
            gameState.stage = 0;
            gameState.currentAction = null;
            gameState.difficulty = 1;
            gameState.correctInARow = 0;
            gameState.questionsAtCurrentDifficulty = 0;
            
            updateAllBars();
            updateCatDisplay();
            updateScoreDisplay();
            updateEvolutionDisplay();
            updateDifficultyDisplay();
            
            document.getElementById('questionArea').style.display = 'none';
            document.getElementById('feedbackArea').style.display = 'none';
            document.getElementById('helpSection').style.display = 'none';
            
            bootstrap.Modal.getInstance(document.getElementById('gameOverModal')).hide();
            
            playSound('meow');
        }
        
        function decayStats() {
            if (gameState.health <= 0) return;
            
            gameState.hunger = Math.max(0, gameState.hunger - 2);
            gameState.thirst = Math.max(0, gameState.thirst - 3);
            gameState.happiness = Math.max(0, gameState.happiness - 1);
            
            // Health decreases if other stats are low
            if (gameState.hunger < 30 || gameState.thirst < 30) {
                gameState.health = Math.max(0, gameState.health - 2);
            }
            if (gameState.happiness < 20) {
                gameState.health = Math.max(0, gameState.health - 1);
            }
            
            updateAllBars();
            
            if (gameState.health <= 0) {
                gameOver();
            }
        }
        
        function updateAllBars() {
            updateBar('health', gameState.health);
            updateBar('hunger', gameState.hunger);
            updateBar('thirst', gameState.thirst);
            updateBar('happiness', gameState.happiness);
            updateOverlayDisplays();
        }
        
        function updateBar(type, value) {
            const bar = document.getElementById(type + 'Bar');
            const valueDisplay = document.getElementById(type + 'Value');
            
            if (bar) bar.style.width = value + '%';
            if (valueDisplay) valueDisplay.textContent = Math.round(value);
            
            // Add low class for animation when value is low
            if (bar) {
                if (value < 30) {
                    bar.classList.add('low');
                } else {
                    bar.classList.remove('low');
                }
            }
        }
        
        function updateCatDisplay(expression = 'normal') {
            const container = document.getElementById('catContainer');
            if (container) {
                container.innerHTML = getCharacterSVG(gameState.stage, expression);
            }
            updateStageBackground();
        }
        
        // Update stage background based on theme
        function updateStageBackground() {
            const stage = document.getElementById('catStage');
            if (!stage) return;
            
            const theme = gameState.currentTheme;
            
            // Remove any existing theme backgrounds
            const existingBg = stage.querySelector('.theme-background');
            if (existingBg) existingBg.remove();
            
            // Show/hide cat theme elements (grass, sun, clouds, ground)
            const grass = stage.querySelector('.grass');
            const ground = stage.querySelector('.ground');
            const sun = stage.querySelector('.sun');
            const clouds = stage.querySelectorAll('.cloud');
            
            if (theme === 'cat') {
                if (grass) grass.style.display = 'flex';
                if (ground) ground.style.display = 'block';
                if (sun) sun.style.display = 'block';
                clouds.forEach(c => c.style.display = 'block');
            } else {
                if (grass) grass.style.display = 'none';
                if (ground) ground.style.display = 'none';
                if (sun) sun.style.display = 'none';
                clouds.forEach(c => c.style.display = 'none');
            }
            
            // Create new theme background
            const bgDiv = document.createElement('div');
            bgDiv.className = 'theme-background';
            
            if (theme === 'pirate') {
                // Sky at top, ocean at bottom
                stage.style.background = 'linear-gradient(180deg, #87CEEB 0%, #5DADE2 35%, #2E86AB 50%, #1B6B93 70%, #1B4F72 100%)';
                bgDiv.innerHTML = `
                    <!-- Sun -->
                    <div class="pirate-sun"></div>
                    
                    <!-- Clouds -->
                    <div class="pirate-cloud cloud-1">‚òÅÔ∏è</div>
                    <div class="pirate-cloud cloud-2">‚òÅÔ∏è</div>
                    <div class="pirate-cloud cloud-3">‚õÖ</div>
                    
                    <!-- Ocean waves -->
                    <div class="ocean-waves"></div>
                    
                    <!-- Passing islands -->
                    <div class="island island-1">
                        <div class="palm-tree">üå¥</div>
                        <div class="island-base"></div>
                    </div>
                    <div class="island island-2">
                        <div class="palm-tree">üå¥</div>
                        <div class="palm-tree palm-2">üå¥</div>
                        <div class="island-base"></div>
                    </div>
                    
                    <!-- Ship deck -->
                    <div class="ship-deck"></div>
                    
                    <!-- Ship details on deck -->
                    <div class="deck-items">
                        <span class="deck-item" style="left: 15%;">ü™£</span>
                        <span class="deck-item" style="left: 75%;">üß≠</span>
                    </div>
                `;
            } else if (theme === 'space') {
                // Space background with stars and planets
                stage.style.background = 'linear-gradient(180deg, #0a0a2e 0%, #1a1a4e 50%, #0f0f3f 100%)';
                bgDiv.innerHTML = `
                    <div class="stars-container">
                        ${generateStars(50)}
                    </div>
                    <div class="planet planet-1"></div>
                    <div class="planet planet-2"></div>
                    <div class="floating-item space-item" style="left: 5%; top: 20%; animation-delay: 0s;">üåü</div>
                    <div class="floating-item space-item" style="left: 90%; top: 15%; animation-delay: 1.5s;">‚ú®</div>
                    <div class="floating-item space-item" style="left: 8%; top: 70%; animation-delay: 0.8s;">üõ∏</div>
                    <div class="floating-item space-item" style="left: 88%; top: 75%; animation-delay: 2s;">üåô</div>
                    <div class="shooting-star"></div>
                    <div class="space-platform"></div>
                `;
            } else {
                // Default cat theme - restore original
                stage.style.background = 'linear-gradient(180deg, #87CEEB 0%, #98FB98 100%)';
                // Don't add theme background for cat - use native elements
                return;
            }
            
            stage.insertBefore(bgDiv, stage.firstChild);
        }
        
        // Generate random stars for space theme
        function generateStars(count) {
            let stars = '';
            for (let i = 0; i < count; i++) {
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const size = Math.random() * 3 + 1;
                const delay = Math.random() * 3;
                stars += `<div class="star" style="left: ${x}%; top: ${y}%; width: ${size}px; height: ${size}px; animation-delay: ${delay}s;"></div>`;
            }
            return stars;
        }
        
        function updateScoreDisplay() {
            const scoreEl = document.getElementById('scoreDisplay');
            const streakEl = document.getElementById('streakDisplay');
            const correctEl = document.getElementById('correctDisplay');
            
            if (scoreEl) scoreEl.textContent = gameState.score;
            if (streakEl) streakEl.textContent = gameState.streak + ' üî•';
            if (correctEl) correctEl.textContent = gameState.correct;
            
            updateOverlayDisplays();
        }
        
        function updateEvolutionDisplay() {
            const theme = getTheme();
            const stage0 = document.getElementById('stage0');
            const stage1 = document.getElementById('stage1');
            const stage2 = document.getElementById('stage2');
            const stage3 = document.getElementById('stage3');
            const line0 = document.getElementById('line0');
            const line1 = document.getElementById('line1');
            const line2 = document.getElementById('line2');
            const xpBar = document.getElementById('xpBar');
            const xpText = document.getElementById('xpText');
            const stageLabel = document.getElementById('stageLabel');
            
            // Update stage emojis from theme
            if (stage0) stage0.textContent = theme.stageEmojis[0];
            if (stage1) stage1.textContent = theme.stageEmojis[1];
            if (stage2) stage2.textContent = theme.stageEmojis[2];
            if (stage3) stage3.textContent = theme.stageEmojis[3];
            
            // Also update the mini evo dots
            const evo0 = document.getElementById('evo0');
            const evo1 = document.getElementById('evo1');
            const evo2 = document.getElementById('evo2');
            const evo3 = document.getElementById('evo3');
            if (evo0) evo0.textContent = theme.stageEmojis[0];
            if (evo1) evo1.textContent = theme.stageEmojis[1];
            if (evo2) evo2.textContent = theme.stageEmojis[2];
            if (evo3) evo3.textContent = theme.stageEmojis[3];
            
            // Update evolution stage name labels
            const evoLabel0 = document.getElementById('evoLabel0');
            const evoLabel1 = document.getElementById('evoLabel1');
            const evoLabel2 = document.getElementById('evoLabel2');
            const evoLabel3 = document.getElementById('evoLabel3');
            if (evoLabel0) evoLabel0.textContent = theme.stageNames[0];
            if (evoLabel1) evoLabel1.textContent = theme.stageNames[1];
            if (evoLabel2) evoLabel2.textContent = theme.stageNames[2];
            if (evoLabel3) evoLabel3.textContent = theme.stageNames[3];
            
            // Reset classes
            [stage0, stage1, stage2, stage3].forEach(s => { if(s) s.className = 'stage-indicator'; });
            [line0, line1, line2].forEach(l => { if(l) l.className = 'stage-line'; });
            
            // Stage 0 (Newborn)
            if (gameState.stage === 0) {
                if (stage0) stage0.classList.add('active');
            } else {
                if (stage0) stage0.classList.add('completed');
                if (line0) line0.classList.add('completed');
            }
            
            // Stage 1 (Kitten)
            if (gameState.stage >= 1) {
                if (stage1) stage1.classList.add(gameState.stage === 1 ? 'active' : 'completed');
                if (gameState.stage > 1 && line1) line1.classList.add('completed');
            } else {
                if (stage1) stage1.classList.add('locked');
            }
            
            // Stage 2 (Teen)
            if (gameState.stage >= 2) {
                if (stage2) stage2.classList.add(gameState.stage === 2 ? 'active' : 'completed');
                if (gameState.stage > 2 && line2) line2.classList.add('completed');
            } else {
                if (stage2) stage2.classList.add('locked');
            }
            
            // Stage 3 (Adult)
            if (gameState.stage >= 3) {
                if (stage3) stage3.classList.add('active');
            } else {
                if (stage3) stage3.classList.add('locked');
            }
            
            // XP bar with theme-appropriate text
            let xpProgress;
            if (gameState.stage === 0) {
                xpProgress = (gameState.xp / gameState.xpToEvolve[0]) * 100;
                if (xpText) xpText.textContent = `${gameState.xp} / ${gameState.xpToEvolve[0]} XP to ${theme.stageNames[1]}`;
            } else if (gameState.stage === 1) {
                xpProgress = ((gameState.xp - gameState.xpToEvolve[0]) / (gameState.xpToEvolve[1] - gameState.xpToEvolve[0])) * 100;
                if (xpText) xpText.textContent = `${gameState.xp} / ${gameState.xpToEvolve[1]} XP to ${theme.stageNames[2]}`;
            } else if (gameState.stage === 2) {
                xpProgress = ((gameState.xp - gameState.xpToEvolve[1]) / (gameState.xpToEvolve[2] - gameState.xpToEvolve[1])) * 100;
                if (xpText) xpText.textContent = `${gameState.xp} / ${gameState.xpToEvolve[2]} XP to ${theme.stageNames[3]}`;
            } else {
                xpProgress = 100;
                if (xpText) xpText.textContent = `MAX LEVEL! üèÜ`;
            }
            if (xpBar) xpBar.style.width = Math.min(100, Math.max(0, xpProgress)) + '%';
            
            // Stage label from theme
            if (stageLabel) stageLabel.textContent = theme.stages[gameState.stage];
        }
        
        function selectTopic(topic) {
            gameState.currentTopic = topic;
            
            document.querySelectorAll('.topic-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-topic="${topic}"]`).classList.add('active');
            
            // Update the topic label
            const topicNames = {
                'addition': '‚ûï Addition',
                'subtraction': '‚ûñ Subtraction',
                'multiplication': '‚úñÔ∏è Multiplication',
                'division': '‚ûó Division',
                'equations': 'üî¢ Equations',
                'fractions': '¬Ω Fractions',
                'mixed': 'üé≤ Mixed'
            };
            const currentTopicLabel = document.getElementById('currentTopicLabel');
            if (currentTopicLabel) currentTopicLabel.textContent = topicNames[topic] || topic;
            
            // Collapse the picker
            const content = document.getElementById('topicPickerContent');
            const btn = document.getElementById('topicPickerBtn');
            if (content) content.style.display = 'none';
            if (btn) btn.classList.remove('expanded');
            
            playSound('click');
        }
        
        function selectAction(action) {
            gameState.currentAction = action;
            const theme = getTheme();
            
            const questionArea = document.getElementById('questionArea');
            const feedbackArea = document.getElementById('feedbackArea');
            const helpSection = document.getElementById('helpSection');
            const actionHint = document.getElementById('actionHint');
            const answerInput = document.getElementById('answerInput');
            
            if (questionArea) questionArea.style.display = 'block';
            if (feedbackArea) feedbackArea.style.display = 'none';
            if (helpSection) helpSection.style.display = 'none';
            
            generateQuestion();
            
            if (actionHint) {
                actionHint.textContent = theme.actions[action].message;
            }
            
            playSound('click');
            if (answerInput) answerInput.focus();
        }
        
        // ============ MATH QUESTION GENERATION ============
        function generateQuestion() {
            // Hide help section from previous question
            const helpSection = document.getElementById('helpSection');
            if (helpSection) helpSection.style.display = 'none';
            
            let topic = gameState.currentTopic;
            
            if (topic === 'mixed') {
                const topics = ['addition', 'subtraction', 'multiplication', 'division', 'equations', 'fractions'];
                topic = topics[Math.floor(Math.random() * topics.length)];
            }
            
            let question, answer, type;
            
            // Get difficulty parameters based on current difficulty level (1-5)
            const diff = gameState.difficulty;
            const diffParams = getDifficultyParams(diff);
            
            switch(topic) {
                case 'addition':
                    const a1 = Math.floor(Math.random() * diffParams.addSubMax) + diffParams.minNum;
                    const a2 = Math.floor(Math.random() * diffParams.addSubMax) + diffParams.minNum;
                    question = `${a1} + ${a2} = ?`;
                    answer = a1 + a2;
                    type = 'Addition';
                    gameState.currentQuestion = { type: 'addition', num1: a1, num2: a2 };
                    break;
                    
                case 'subtraction':
                    let s1 = Math.floor(Math.random() * diffParams.addSubMax) + diffParams.minNum;
                    let s2 = Math.floor(Math.random() * diffParams.addSubMax) + diffParams.minNum;
                    if (s2 > s1) [s1, s2] = [s2, s1]; // Ensure positive result
                    question = `${s1} - ${s2} = ?`;
                    answer = s1 - s2;
                    type = 'Subtraction';
                    gameState.currentQuestion = { type: 'subtraction', num1: s1, num2: s2 };
                    break;
                    
                case 'multiplication':
                    const m1 = Math.floor(Math.random() * diffParams.multDivMax) + 1;
                    const m2 = Math.floor(Math.random() * diffParams.multDivMax) + 1;
                    question = `${m1} √ó ${m2} = ?`;
                    answer = m1 * m2;
                    type = 'Multiplication';
                    gameState.currentQuestion = { type: 'multiplication', num1: m1, num2: m2 };
                    break;
                    
                case 'division':
                    const divisor = Math.floor(Math.random() * diffParams.multDivMax) + 1;
                    const quotient = Math.floor(Math.random() * diffParams.multDivMax) + 1;
                    const dividend = divisor * quotient;
                    question = `${dividend} √∑ ${divisor} = ?`;
                    answer = quotient;
                    type = 'Division';
                    gameState.currentQuestion = { type: 'division', dividend, divisor, quotient };
                    break;
                    
                case 'equations':
                    const x = Math.floor(Math.random() * diffParams.eqMax) + diffParams.minNum;
                    const b = Math.floor(Math.random() * diffParams.eqMax) + diffParams.minNum;
                    const result = x + b;
                    question = `? + ${b} = ${result}`;
                    answer = x;
                    type = 'Equation';
                    gameState.currentQuestion = { type: 'equation', x, b, result };
                    break;
                    
                case 'fractions':
                    // Generate fraction problems based on difficulty
                    const fractionProblems = generateFractionProblem();
                    question = fractionProblems.question;
                    answer = fractionProblems.answer;
                    type = 'Fraction';
                    gameState.currentQuestion = fractionProblems.questionData;
                    break;
            }
            
            gameState.currentAnswer = answer;
            const questionText = document.getElementById('questionText');
            const questionType = document.getElementById('questionType');
            const answerInput = document.getElementById('answerInput');
            
            if (questionText) questionText.innerHTML = question;
            if (questionType) questionType.textContent = type + ' Problem';
            if (answerInput) answerInput.value = '';
            
            // Update difficulty display
            updateDifficultyDisplay();
        }
        
        function getDifficultyParams(level) {
            // Returns number ranges based on difficulty level 1-5
            const params = {
                1: { minNum: 1, addSubMax: 10, multDivMax: 5, eqMax: 10, fracDenoms: [2, 3, 4] },
                2: { minNum: 1, addSubMax: 20, multDivMax: 8, eqMax: 15, fracDenoms: [2, 3, 4, 5, 6] },
                3: { minNum: 1, addSubMax: 50, multDivMax: 10, eqMax: 20, fracDenoms: [2, 3, 4, 5, 6, 8] },
                4: { minNum: 5, addSubMax: 100, multDivMax: 12, eqMax: 30, fracDenoms: [3, 4, 5, 6, 8, 10] },
                5: { minNum: 10, addSubMax: 200, multDivMax: 15, eqMax: 50, fracDenoms: [4, 5, 6, 8, 10, 12] }
            };
            return params[level] || params[1];
        }
        
        function updateDifficulty(correct) {
            if (correct) {
                gameState.correctInARow++;
                gameState.questionsAtCurrentDifficulty++;
                
                // Increase difficulty after 3 correct in a row (max level 5)
                if (gameState.correctInARow >= 3 && gameState.difficulty < 5) {
                    gameState.difficulty++;
                    gameState.correctInARow = 0;
                    gameState.questionsAtCurrentDifficulty = 0;
                    showDifficultyChange(true);
                }
            } else {
                gameState.correctInARow = 0;
                
                // Decrease difficulty after wrong answer if above level 1
                if (gameState.difficulty > 1) {
                    gameState.difficulty--;
                    gameState.questionsAtCurrentDifficulty = 0;
                    showDifficultyChange(false);
                }
            }
        }
        
        function showDifficultyChange(increased) {
            const message = increased ? 
                `‚¨ÜÔ∏è Level Up! Difficulty: ${gameState.difficulty}/5` : 
                `‚¨áÔ∏è Difficulty adjusted: ${gameState.difficulty}/5`;
            
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.className = 'difficulty-notification';
            notification.innerHTML = message;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${increased ? 'linear-gradient(135deg, #2ECC71, #27AE60)' : 'linear-gradient(135deg, #F39C12, #E67E22)'};
                color: white;
                padding: 10px 25px;
                border-radius: 25px;
                font-family: 'Fredoka', sans-serif;
                font-weight: 600;
                font-size: 1rem;
                z-index: 1001;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                animation: slideDown 0.3s ease, fadeOut 0.5s ease 1.5s forwards;
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }
        
        function updateDifficultyDisplay() {
            const diffDisplay = document.getElementById('difficultyDisplay');
            if (diffDisplay) {
                const stars = '‚≠ê'.repeat(gameState.difficulty) + '‚òÜ'.repeat(5 - gameState.difficulty);
                diffDisplay.innerHTML = `Level ${gameState.difficulty} ${stars}`;
            }
        }
        
        function generateFractionProblem() {
            const diff = gameState.difficulty;
            
            // Problem types available based on difficulty
            let problemTypes;
            if (diff <= 2) {
                problemTypes = ['identify', 'equivalent'];
            } else if (diff <= 3) {
                problemTypes = ['identify', 'equivalent', 'add_same'];
            } else {
                problemTypes = ['identify', 'equivalent', 'add_same', 'subtract_same', 'multiply'];
            }
            
            const problemType = problemTypes[Math.floor(Math.random() * problemTypes.length)];
            const diffParams = getDifficultyParams(diff);
            const availableDenoms = diffParams.fracDenoms;
            
            switch(problemType) {
                case 'identify': {
                    // What fraction is shaded? (visual)
                    const denominator = availableDenoms[Math.floor(Math.random() * availableDenoms.length)];
                    const numerator = Math.floor(Math.random() * denominator) + 1;
                    const question = `
                        <div class="mb-2">What fraction is shaded?</div>
                        <div class="d-flex justify-content-center gap-1 mb-2">
                            ${Array(denominator).fill(0).map((_, i) => 
                                `<div style="width: 40px; height: 40px; border: 2px solid #333; border-radius: 5px; background: ${i < numerator ? '#FF6B9D' : 'white'}"></div>`
                            ).join('')}
                        </div>
                        <div>Enter the <strong>numerator</strong> (top number):</div>
                        <div class="small text-muted">The denominator (bottom) is ${denominator}</div>
                    `;
                    return {
                        question,
                        answer: numerator,
                        questionData: { type: 'fraction_identify', numerator, denominator }
                    };
                }
                
                case 'equivalent': {
                    // Find equivalent fraction
                    const baseDenomOptions = availableDenoms.filter(d => d <= 5);
                    const baseDenom = baseDenomOptions[Math.floor(Math.random() * baseDenomOptions.length)] || 2;
                    const baseNum = Math.floor(Math.random() * (baseDenom - 1)) + 1;
                    const multiplierOptions = diff >= 4 ? [2, 3, 4, 5] : [2, 3, 4];
                    const multiplier = multiplierOptions[Math.floor(Math.random() * multiplierOptions.length)];
                    const newDenom = baseDenom * multiplier;
                    const newNum = baseNum * multiplier;
                    
                    const question = `
                        <div class="mb-2">Find the equivalent fraction:</div>
                        <div class="fs-2"><sup>${baseNum}</sup>‚ÅÑ<sub>${baseDenom}</sub> = <sup>?</sup>‚ÅÑ<sub>${newDenom}</sub></div>
                        <div class="mt-2">What is the numerator (top number)?</div>
                    `;
                    return {
                        question,
                        answer: newNum,
                        questionData: { type: 'fraction_equivalent', baseNum, baseDenom, newNum, newDenom, multiplier }
                    };
                }
                
                case 'add_same': {
                    // Add fractions with same denominator
                    const denom = availableDenoms[Math.floor(Math.random() * availableDenoms.length)];
                    const num1 = Math.floor(Math.random() * (denom - 2)) + 1;
                    const num2 = Math.floor(Math.random() * (denom - num1 - 1)) + 1;
                    const resultNum = num1 + num2;
                    
                    const question = `
                        <div class="mb-2">Add these fractions:</div>
                        <div class="fs-2"><sup>${num1}</sup>‚ÅÑ<sub>${denom}</sub> + <sup>${num2}</sup>‚ÅÑ<sub>${denom}</sub> = <sup>?</sup>‚ÅÑ<sub>${denom}</sub></div>
                        <div class="mt-2">What is the numerator (top number)?</div>
                    `;
                    return {
                        question,
                        answer: resultNum,
                        questionData: { type: 'fraction_add', num1, num2, denom, resultNum }
                    };
                }
                
                case 'subtract_same': {
                    // Subtract fractions with same denominator
                    const denom = availableDenoms[Math.floor(Math.random() * availableDenoms.length)];
                    const num1 = Math.floor(Math.random() * (denom - 1)) + 2;
                    const num2 = Math.floor(Math.random() * (num1 - 1)) + 1;
                    const resultNum = num1 - num2;
                    
                    const question = `
                        <div class="mb-2">Subtract these fractions:</div>
                        <div class="fs-2"><sup>${num1}</sup>‚ÅÑ<sub>${denom}</sub> - <sup>${num2}</sup>‚ÅÑ<sub>${denom}</sub> = <sup>?</sup>‚ÅÑ<sub>${denom}</sub></div>
                        <div class="mt-2">What is the numerator (top number)?</div>
                    `;
                    return {
                        question,
                        answer: resultNum,
                        questionData: { type: 'fraction_subtract', num1, num2, denom, resultNum }
                    };
                }
                
                case 'multiply': {
                    // Multiply a fraction by a whole number
                    const denomOptions = availableDenoms.filter(d => d <= 6);
                    const denom = denomOptions[Math.floor(Math.random() * denomOptions.length)] || 4;
                    const num = Math.floor(Math.random() * (denom - 1)) + 1;
                    const multiplierOptions = diff >= 4 ? [2, 3, 4, 5] : [2, 3, 4];
                    const multiplier = multiplierOptions[Math.floor(Math.random() * multiplierOptions.length)];
                    const resultNum = num * multiplier;
                    
                    const question = `
                        <div class="mb-2">Multiply:</div>
                        <div class="fs-2">${multiplier} √ó <sup>${num}</sup>‚ÅÑ<sub>${denom}</sub> = <sup>?</sup>‚ÅÑ<sub>${denom}</sub></div>
                        <div class="mt-2">What is the numerator (top number)?</div>
                    `;
                    return {
                        question,
                        answer: resultNum,
                        questionData: { type: 'fraction_multiply', num, denom, multiplier, resultNum }
                    };
                }
            }
        }
        
        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            
            if (isNaN(userAnswer)) {
                showFeedback(false, 'Please enter a number!');
                return;
            }
            
            const isCorrect = userAnswer === gameState.currentAnswer;
            
            if (isCorrect) {
                handleCorrectAnswer();
            } else {
                handleIncorrectAnswer(userAnswer);
            }
        }
        
        function handleCorrectAnswer() {
            gameState.streak++;
            gameState.correct++;
            gameState.totalCorrect++;
            gameState.score += 10 * gameState.streak;
            gameState.xp += 10 + Math.floor(gameState.streak / 2) * 5;
            
            // Perform action
            const catContainer = document.getElementById('catContainer');
            const theme = getTheme();
            
            switch(gameState.currentAction) {
                case 'feed':
                    gameState.hunger = Math.min(100, gameState.hunger + 25);
                    gameState.health = Math.min(100, gameState.health + 5);
                    catContainer.classList.add('eating');
                    showItemAnimation(theme.actions.feed.emoji);
                    playSound('feed');
                    break;
                case 'water':
                    gameState.thirst = Math.min(100, gameState.thirst + 30);
                    gameState.health = Math.min(100, gameState.health + 5);
                    catContainer.classList.add('eating');
                    showItemAnimation(theme.actions.water.emoji);
                    playSound('water');
                    break;
                case 'play':
                    gameState.happiness = Math.min(100, gameState.happiness + 25);
                    gameState.health = Math.min(100, gameState.health + 3);
                    catContainer.classList.add('playing');
                    showItemAnimation(theme.actions.play.emoji);
                    playSound('play');
                    break;
            }
            
            setTimeout(() => {
                catContainer.className = 'cat-container happy';
                updateCatDisplay('happy');
                playSound('purr');
            }, 500);
            
            setTimeout(() => {
                catContainer.className = 'cat-container';
                updateCatDisplay('normal');
            }, 1500);
            
            updateAllBars();
            updateScoreDisplay();
            
            showFeedback(true, `üéâ Correct! +${10 * gameState.streak} points! Streak: ${gameState.streak}üî•`);
            showHearts();
            playSound('correct');
            
            // Update difficulty based on performance
            updateDifficulty(true);
            
            // Boss battle damage
            if (gameState.bossActive) {
                damageBoss();
            }
            
            // Story mode progress
            if (gameState.storyMode) {
                checkStoryProgress();
            }
            
            // Check evolution
            checkEvolution();
            
            // Show cat fact every 5 correct answers
            if (gameState.totalCorrect % 5 === 0) {
                setTimeout(showCatFact, 1500);
            }
            
            // Mini-game reward every 8 streak
            if (gameState.streak > 0 && gameState.streak % 8 === 0) {
                setTimeout(() => {
                    offerMiniGame();
                }, 2000);
            }
            
            // Generate new question after delay
            setTimeout(() => {
                document.getElementById('feedbackArea').style.display = 'none';
                generateQuestion();
                document.getElementById('answerInput').focus();
            }, 2000);
        }
        
        function handleIncorrectAnswer(userAnswer) {
            gameState.streak = 0;
            gameState.health = Math.max(0, gameState.health - 10);
            
            const catContainer = document.getElementById('catContainer');
            catContainer.classList.add('sad');
            updateCatDisplay('sad');
            playSound('sad');
            
            setTimeout(() => {
                catContainer.className = 'cat-container';
                updateCatDisplay('normal');
            }, 1500);
            
            updateAllBars();
            updateScoreDisplay();
            
            const theme = getTheme();
            showFeedback(false, `üò¢ Not quite! The answer was ${gameState.currentAnswer}. Your ${theme.characterName} lost some health!`);
            playSound('incorrect');
            
            // Update difficulty based on performance
            updateDifficulty(false);
            
            // Show help
            showHelp();
            
            if (gameState.health <= 0) {
                setTimeout(gameOver, 1500);
            }
        }
        
        function showFeedback(isCorrect, message) {
            const feedbackArea = document.getElementById('feedbackArea');
            const feedbackMessage = document.getElementById('feedbackMessage');
            
            feedbackArea.style.display = 'block';
            feedbackMessage.className = 'feedback-message ' + (isCorrect ? 'feedback-correct' : 'feedback-incorrect');
            feedbackMessage.innerHTML = message;
        }
        
        function showHelp() {
            const helpSection = document.getElementById('helpSection');
            const helpContent = document.getElementById('helpContent');
            const q = gameState.currentQuestion;
            
            let helpHtml = '';
            
            switch(q.type) {
                case 'addition':
                    helpHtml = `
                        <p><strong>Addition</strong> means putting numbers together to find the total.</p>
                        <p>Think of it like counting objects:</p>
                        <p class="fs-5">${'üîµ'.repeat(Math.min(q.num1, 10))} + ${'üü¢'.repeat(Math.min(q.num2, 10))}</p>
                        <p>${q.num1} + ${q.num2} = <strong>${q.num1 + q.num2}</strong></p>
                        <p><em>Tip: Start with the bigger number and count up!</em></p>
                    `;
                    break;
                    
                case 'subtraction':
                    helpHtml = `
                        <p><strong>Subtraction</strong> means taking away to find what's left.</p>
                        <p>Start with ${q.num1} and take away ${q.num2}:</p>
                        <p class="fs-5">${'üîµ'.repeat(Math.min(q.num1, 10))} - ${'‚ùå'.repeat(Math.min(q.num2, 10))}</p>
                        <p>${q.num1} - ${q.num2} = <strong>${q.num1 - q.num2}</strong></p>
                        <p><em>Tip: Count backwards from the first number!</em></p>
                    `;
                    break;
                    
                case 'multiplication':
                    helpHtml = `
                        <p><strong>Multiplication</strong> is like adding the same number multiple times.</p>
                        <p>${q.num1} √ó ${q.num2} means ${q.num1} groups of ${q.num2}:</p>
                        <p class="fs-6">${Array(Math.min(q.num1, 5)).fill('(' + '‚óè'.repeat(Math.min(q.num2, 5)) + ')').join(' ')}</p>
                        <p>${q.num2} + ${Array(Math.min(q.num1-1, 4)).fill(q.num2).join(' + ')} = <strong>${q.num1 * q.num2}</strong></p>
                        <p><em>Tip: Practice your times tables!</em></p>
                    `;
                    break;
                    
                case 'division':
                    helpHtml = `
                        <p><strong>Division</strong> means splitting into equal groups.</p>
                        <p>${q.dividend} √∑ ${q.divisor} means: how many groups of ${q.divisor} fit in ${q.dividend}?</p>
                        <p>Think: ${q.divisor} √ó <strong>?</strong> = ${q.dividend}</p>
                        <p>${q.divisor} √ó <strong>${q.quotient}</strong> = ${q.dividend}</p>
                        <p>So ${q.dividend} √∑ ${q.divisor} = <strong>${q.quotient}</strong></p>
                        <p><em>Tip: Division is the opposite of multiplication!</em></p>
                    `;
                    break;
                    
                case 'equation':
                    helpHtml = `
                        <p><strong>Equations</strong> are like puzzles - find the missing number!</p>
                        <p>? + ${q.b} = ${q.result}</p>
                        <p>To find ?, we can subtract: ${q.result} - ${q.b} = ?</p>
                        <p>${q.result} - ${q.b} = <strong>${q.x}</strong></p>
                        <p>Check: ${q.x} + ${q.b} = ${q.result} ‚úì</p>
                        <p><em>Tip: Work backwards using the opposite operation!</em></p>
                    `;
                    break;
                    
                case 'fraction_identify':
                    helpHtml = `
                        <p><strong>Fractions</strong> show parts of a whole!</p>
                        <p>A fraction has two parts:</p>
                        <div class="ms-3">
                            <p>‚Ä¢ <strong>Numerator (top)</strong>: How many parts are shaded/colored</p>
                            <p>‚Ä¢ <strong>Denominator (bottom)</strong>: Total number of equal parts</p>
                        </div>
                        <p>In this problem, count the shaded (pink) boxes:</p>
                        <p>There are <strong>${q.numerator}</strong> shaded parts out of ${q.denominator} total parts.</p>
                        <p>So the fraction is: <span class="fs-4"><sup><strong>${q.numerator}</strong></sup>‚ÅÑ<sub>${q.denominator}</sub></span></p>
                        <p><em>üí° Tip: Always count carefully! The numerator (answer) was ${q.numerator}.</em></p>
                    `;
                    break;
                    
                case 'fraction_equivalent':
                    helpHtml = `
                        <p><strong>Equivalent fractions</strong> are different fractions that show the same amount!</p>
                        <p>To find an equivalent fraction, multiply BOTH the top and bottom by the same number.</p>
                        <div class="p-2 my-2" style="background: #fff; border-radius: 10px;">
                            <p class="mb-1">Starting fraction: <span class="fs-4"><sup>${q.baseNum}</sup>‚ÅÑ<sub>${q.baseDenom}</sub></span></p>
                            <p class="mb-1">We need the bottom to be ${q.newDenom}.</p>
                            <p class="mb-1">${q.baseDenom} √ó <strong>${q.multiplier}</strong> = ${q.newDenom}</p>
                            <p class="mb-1">So multiply the top by ${q.multiplier} too:</p>
                            <p class="mb-1">${q.baseNum} √ó ${q.multiplier} = <strong>${q.newNum}</strong></p>
                        </div>
                        <p>Answer: <span class="fs-4"><sup>${q.baseNum}</sup>‚ÅÑ<sub>${q.baseDenom}</sub> = <sup><strong>${q.newNum}</strong></sup>‚ÅÑ<sub>${q.newDenom}</sub></span></p>
                        <p><em>üí° Tip: Whatever you do to the bottom, do to the top!</em></p>
                    `;
                    break;
                    
                case 'fraction_add':
                    helpHtml = `
                        <p><strong>Adding fractions</strong> with the same denominator is easy!</p>
                        <p>When the denominators (bottom numbers) are the same:</p>
                        <div class="ms-3">
                            <p>1. Keep the denominator the same</p>
                            <p>2. Just add the numerators (top numbers)</p>
                        </div>
                        <div class="p-2 my-2" style="background: #fff; border-radius: 10px;">
                            <p class="fs-4 text-center"><sup>${q.num1}</sup>‚ÅÑ<sub>${q.denom}</sub> + <sup>${q.num2}</sup>‚ÅÑ<sub>${q.denom}</sub></p>
                            <p class="text-center">Top: ${q.num1} + ${q.num2} = <strong>${q.resultNum}</strong></p>
                            <p class="text-center">Bottom stays: ${q.denom}</p>
                        </div>
                        <p>Answer: <span class="fs-4"><sup><strong>${q.resultNum}</strong></sup>‚ÅÑ<sub>${q.denom}</sub></span></p>
                        <p><em>üí° Tip: Don't add the denominators - only add the top numbers!</em></p>
                    `;
                    break;
                    
                case 'fraction_subtract':
                    helpHtml = `
                        <p><strong>Subtracting fractions</strong> with the same denominator:</p>
                        <p>When the denominators (bottom numbers) match:</p>
                        <div class="ms-3">
                            <p>1. Keep the denominator the same</p>
                            <p>2. Subtract the numerators (top numbers)</p>
                        </div>
                        <div class="p-2 my-2" style="background: #fff; border-radius: 10px;">
                            <p class="fs-4 text-center"><sup>${q.num1}</sup>‚ÅÑ<sub>${q.denom}</sub> - <sup>${q.num2}</sup>‚ÅÑ<sub>${q.denom}</sub></p>
                            <p class="text-center">Top: ${q.num1} - ${q.num2} = <strong>${q.resultNum}</strong></p>
                            <p class="text-center">Bottom stays: ${q.denom}</p>
                        </div>
                        <p>Answer: <span class="fs-4"><sup><strong>${q.resultNum}</strong></sup>‚ÅÑ<sub>${q.denom}</sub></span></p>
                        <p><em>üí° Tip: The denominator never changes when subtracting with same denominators!</em></p>
                    `;
                    break;
                    
                case 'fraction_multiply':
                    helpHtml = `
                        <p><strong>Multiplying a fraction</strong> by a whole number:</p>
                        <p>When you multiply a fraction by a whole number:</p>
                        <div class="ms-3">
                            <p>1. Multiply the numerator (top) by the whole number</p>
                            <p>2. Keep the denominator (bottom) the same</p>
                        </div>
                        <div class="p-2 my-2" style="background: #fff; border-radius: 10px;">
                            <p class="fs-4 text-center">${q.multiplier} √ó <sup>${q.num}</sup>‚ÅÑ<sub>${q.denom}</sub></p>
                            <p class="text-center">Top: ${q.multiplier} √ó ${q.num} = <strong>${q.resultNum}</strong></p>
                            <p class="text-center">Bottom stays: ${q.denom}</p>
                        </div>
                        <p>Answer: <span class="fs-4"><sup><strong>${q.resultNum}</strong></sup>‚ÅÑ<sub>${q.denom}</sub></span></p>
                        <p><em>üí° Tip: Only the top number gets multiplied!</em></p>
                    `;
                    break;
            }
            
            helpContent.innerHTML = helpHtml;
            helpSection.style.display = 'block';
        }
        
        function tryAgain() {
            document.getElementById('helpSection').style.display = 'none';
            document.getElementById('feedbackArea').style.display = 'none';
            generateQuestion();
            document.getElementById('answerInput').focus();
        }
        
        function showItemAnimation(emoji) {
            const stage = document.getElementById('catStage');
            const item = document.createElement('div');
            item.className = 'item-animation';
            item.textContent = emoji;
            item.style.left = '50%';
            item.style.bottom = '100px';
            item.style.transform = 'translateX(-50%)';
            stage.appendChild(item);
            
            setTimeout(() => item.remove(), 1000);
        }
        
        function showHearts() {
            const stage = document.getElementById('catStage');
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'heart-particle';
                    heart.textContent = '‚ù§Ô∏è';
                    heart.style.left = (40 + Math.random() * 20) + '%';
                    heart.style.bottom = '120px';
                    stage.appendChild(heart);
                    
                    setTimeout(() => heart.remove(), 1500);
                }, i * 100);
            }
        }
        
        function checkEvolution() {
            const oldStage = gameState.stage;
            
            if (gameState.stage === 0 && gameState.xp >= gameState.xpToEvolve[0]) {
                gameState.stage = 1;
            } else if (gameState.stage === 1 && gameState.xp >= gameState.xpToEvolve[1]) {
                gameState.stage = 2;
            } else if (gameState.stage === 2 && gameState.xp >= gameState.xpToEvolve[2]) {
                gameState.stage = 3;
            }
            
            if (gameState.stage !== oldStage) {
                showEvolution(oldStage);
            }
            
            updateEvolutionDisplay();
        }
        
        function showEvolution(oldStage) {
            playSound('evolution');
            createConfetti();
            
            const theme = getTheme();
            const stages = theme.stageNames;
            const messages = [
                '',
                `${gameState.catName} woke up! Your ${stages[1].toLowerCase()} is ready to play! üéâ`,
                `${gameState.catName} is growing up! Keep practicing!`,
                `${gameState.catName} is now a ${stages[3].toLowerCase()}! üèÜ`
            ];
            
            const evolutionText = document.getElementById('evolutionText');
            const evolutionCatDisplay = document.getElementById('evolutionCatDisplay');
            const evolutionMessage = document.getElementById('evolutionMessage');
            
            // Special message for waking up
            if (oldStage === 0) {
                if (evolutionText) evolutionText.textContent = 
                    `${gameState.catName} is waking up!`;
            } else {
                if (evolutionText) evolutionText.textContent = 
                    `${gameState.catName} evolved into a ${stages[gameState.stage]}!`;
            }
            if (evolutionCatDisplay) evolutionCatDisplay.innerHTML = getCharacterSVG(gameState.stage, 'happy');
            if (evolutionMessage) evolutionMessage.textContent = messages[gameState.stage];
            
            const modalEl = document.getElementById('evolutionModal');
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
            
            updateCatDisplay('happy');
        }
        
        function createConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#FF6B9D', '#FFD700', '#2ECC71', '#3498DB', '#9B59B6', '#F39C12'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = confetti.style.width;
                    container.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }
        
        function gameOver() {
            const theme = getTheme();
            const finalScore = document.getElementById('finalScore');
            const gameOverTitle = document.getElementById('gameOverTitle');
            const gameOverMessage = document.getElementById('gameOverMessage');
            const gameOverEncouragement = document.getElementById('gameOverEncouragement');
            
            if (finalScore) finalScore.textContent = gameState.score;
            if (gameOverTitle) gameOverTitle.textContent = theme.gameOverTitle || 'üòø Oh No!';
            if (gameOverMessage) gameOverMessage.textContent = theme.gameOverMessage;
            if (gameOverEncouragement) gameOverEncouragement.textContent = `Don't worry, you can try again and help your ${theme.characterName} thrive!`;
            
            const modalEl = document.getElementById('gameOverModal');
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
        }
        
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) soundToggle.textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
        }
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const isDark = document.body.classList.contains('dark-mode');
            if (darkModeToggle) darkModeToggle.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            playSound('click');
        }
        
        // ============ TRICKS SYSTEM ============
        function toggleTricksPanel(event) {
            if (event) event.stopPropagation();
            const panel = document.getElementById('tricksPanel');
            const isVisible = panel.style.display !== 'none';
            
            // Close other expanded panels first
            closeAllExpandedPanels();
            
            if (isVisible) {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                updateTricksList();
            }
        }
        
        // ============ EXPANDED PANEL TOGGLES ============
        function toggleStatsExpand() {
            const panel = document.getElementById('statsExpanded');
            const isVisible = panel.style.display !== 'none';
            closeAllExpandedPanels();
            if (!isVisible) {
                panel.style.display = 'block';
            }
        }
        
        function toggleScoreExpand() {
            const panel = document.getElementById('scoreExpanded');
            const isVisible = panel.style.display !== 'none';
            closeAllExpandedPanels();
            if (!isVisible) {
                panel.style.display = 'block';
            }
        }
        
        function toggleEvolutionExpand() {
            const panel = document.getElementById('evolutionExpanded');
            const isVisible = panel.style.display !== 'none';
            closeAllExpandedPanels();
            if (!isVisible) {
                panel.style.display = 'block';
            }
        }
        
        function toggleModeExpand() {
            const panel = document.getElementById('modeExpanded');
            const isVisible = panel.style.display !== 'none';
            closeAllExpandedPanels();
            if (!isVisible) {
                panel.style.display = 'block';
            }
        }
        
        function closeAllExpandedPanels() {
            document.getElementById('statsExpanded').style.display = 'none';
            document.getElementById('scoreExpanded').style.display = 'none';
            document.getElementById('evolutionExpanded').style.display = 'none';
            document.getElementById('modeExpanded').style.display = 'none';
            document.getElementById('tricksPanel').style.display = 'none';
        }
        
        // Update mini overlay displays
        function updateOverlayDisplays() {
            // Update mini health bars
            const healthBarMini = document.getElementById('healthBarMini');
            const hungerBarMini = document.getElementById('hungerBarMini');
            const thirstBarMini = document.getElementById('thirstBarMini');
            const happinessBarMini = document.getElementById('happinessBarMini');
            
            if (healthBarMini) healthBarMini.style.width = gameState.health + '%';
            if (hungerBarMini) hungerBarMini.style.width = gameState.hunger + '%';
            if (thirstBarMini) thirstBarMini.style.width = gameState.thirst + '%';
            if (happinessBarMini) happinessBarMini.style.width = gameState.happiness + '%';
            
            // Update score displays
            const scoreCompactTop = document.getElementById('scoreCompactTop');
            const streakCompactTop = document.getElementById('streakCompactTop');
            const correctCompactTop = document.getElementById('correctCompactTop');
            if (scoreCompactTop) scoreCompactTop.textContent = gameState.score;
            if (streakCompactTop) streakCompactTop.textContent = gameState.streak;
            if (correctCompactTop) correctCompactTop.textContent = gameState.correct;
            
            // Update evo dots
            for (let i = 0; i <= 3; i++) {
                const dot = document.getElementById(`evo${i}`);
                if (dot) {
                    dot.classList.remove('active', 'completed');
                    if (i < gameState.stage) {
                        dot.classList.add('completed');
                    } else if (i === gameState.stage) {
                        dot.classList.add('active');
                    }
                }
            }
            
            // Update mini XP bar
            const xpBarMini = document.getElementById('xpBarMini');
            if (xpBarMini) {
                let progress = 0;
                if (gameState.stage === 0) {
                    progress = (gameState.xp / gameState.xpToEvolve[0]) * 100;
                } else if (gameState.stage === 1) {
                    progress = ((gameState.xp - gameState.xpToEvolve[0]) / (gameState.xpToEvolve[1] - gameState.xpToEvolve[0])) * 100;
                } else if (gameState.stage === 2) {
                    progress = ((gameState.xp - gameState.xpToEvolve[1]) / (gameState.xpToEvolve[2] - gameState.xpToEvolve[1])) * 100;
                } else {
                    progress = 100;
                }
                xpBarMini.style.width = Math.min(100, Math.max(0, progress)) + '%';
            }
        }
        
        function updateTricksList() {
            const container = document.getElementById('tricksList');
            if (!container) return;
            let html = '';
            
            for (const [key, trick] of Object.entries(getTricksData())) {
                const unlocked = gameState.stage >= trick.unlockStage;
                html += `
                    <div class="trick-item ${unlocked ? '' : 'locked'}" onclick="${unlocked ? `performTrick('${key}')` : ''}">
                        <span class="emoji">${trick.emoji}</span>
                        <span class="name">${unlocked ? trick.name : 'üîí'}</span>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function performTrick(trickName) {
            const panel = document.getElementById('tricksPanel');
            if (panel) panel.style.display = 'none';
            
            const catContainer = document.getElementById('catContainer');
            if (!catContainer) return;
            
            // Remove any existing trick classes
            catContainer.classList.remove('trick-wave', 'trick-roll', 'trick-highfive', 'trick-dance', 'trick-backflip', 'trick-sit');
            
            // Add the trick animation class
            setTimeout(() => {
                catContainer.classList.add(`trick-${trickName}`);
                playSound('meow');
                
                // Show a little celebration
                showHearts();
                
                // Remove class after animation
                setTimeout(() => {
                    catContainer.classList.remove(`trick-${trickName}`);
                }, 1500);
            }, 50);
        }
        
        // ============ GAME MODES ============
        function setGameMode(mode) {
            // Update button states (both regular and large buttons)
            document.querySelectorAll('.mode-btn, .mode-btn-large').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll(`.mode-btn.${mode}, .mode-btn-large.${mode}`).forEach(btn => btn.classList.add('active'));
            
            // Hide all banners first
            document.getElementById('storyBanner').classList.remove('active');
            document.getElementById('bossBanner').classList.remove('active');
            
            gameState.storyMode = false;
            gameState.bossActive = false;
            
            // Update mode panel display
            const modeIcon = document.getElementById('currentModeIcon');
            const modeLabel = document.getElementById('currentModeLabel');
            
            if (mode === 'free') {
                if (modeIcon) modeIcon.textContent = 'üéÆ';
                if (modeLabel) modeLabel.textContent = 'Free';
            } else if (mode === 'story') {
                gameState.storyMode = true;
                gameState.storyProgress = 0;
                updateStoryBanner();
                document.getElementById('storyBanner').classList.add('active');
                if (modeIcon) modeIcon.textContent = 'üìñ';
                if (modeLabel) modeLabel.textContent = 'Story';
            } else if (mode === 'boss') {
                startBossBattle();
                if (modeIcon) modeIcon.textContent = 'üëπ';
                if (modeLabel) modeLabel.textContent = 'Boss';
            }
        }
        
        // ============ STORY MODE ============
        function updateStoryBanner() {
            const chapter = getStoryChapters()[Math.min(gameState.storyProgress, getStoryChapters().length - 1)];
            const storyIcon = document.getElementById('storyIcon');
            const storyTitle = document.getElementById('storyTitle');
            const storyDesc = document.getElementById('storyDesc');
            const storyCount = document.getElementById('storyCount');
            const storyProgressFill = document.getElementById('storyProgressFill');
            
            if (storyIcon) storyIcon.textContent = chapter.icon;
            if (storyTitle) storyTitle.textContent = chapter.title;
            if (storyDesc) storyDesc.textContent = chapter.description;
            
            const collected = gameState.correct % chapter.goal;
            if (storyCount) storyCount.textContent = `${collected}/${chapter.goal}`;
            if (storyProgressFill) storyProgressFill.style.width = `${(collected / chapter.goal) * 100}%`;
        }
        
        function checkStoryProgress() {
            if (!gameState.storyMode) return;
            
            const chapter = getStoryChapters()[Math.min(gameState.storyProgress, getStoryChapters().length - 1)];
            const collected = gameState.correct % chapter.goal;
            
            updateStoryBanner();
            
            if (collected === 0 && gameState.correct > 0) {
                // Completed a chapter!
                completeStoryChapter();
            }
        }
        
        function completeStoryChapter() {
            const chapter = getStoryChapters()[Math.min(gameState.storyProgress, getStoryChapters().length - 1)];
            
            // Reward XP
            gameState.xp += chapter.reward;
            gameState.score += chapter.reward;
            
            // Show completion message
            showFeedback(true, `üéâ Chapter Complete! "${chapter.title}" +${chapter.reward} bonus XP!`);
            playSound('evolution');
            createConfetti();
            
            // Move to next chapter
            gameState.storyProgress++;
            
            if (gameState.storyProgress >= getStoryChapters().length) {
                // Completed all chapters!
                setTimeout(() => {
                    showFeedback(true, `üèÜ STORY COMPLETE! You finished all chapters! Amazing!`);
                    gameState.storyProgress = 0; // Reset to replay
                }, 2000);
            }
            
            setTimeout(() => {
                updateStoryBanner();
                checkEvolution();
                updateScoreDisplay();
            }, 500);
        }
        
        // ============ BOSS BATTLES ============
        function startBossBattle() {
            const bossDataArr = getBossData();
            const bossIndex = Math.min(Math.floor(gameState.totalCorrect / 20), bossDataArr.length - 1);
            const boss = bossDataArr[bossIndex];
            
            gameState.bossActive = true;
            gameState.bossHealth = boss.hp;
            gameState.currentBoss = boss;
            
            const bossEmoji = document.getElementById('bossEmoji');
            const bossName = document.getElementById('bossName');
            const bossHP = document.getElementById('bossHP');
            const bossHealthFill = document.getElementById('bossHealthFill');
            const bossBanner = document.getElementById('bossBanner');
            
            if (bossEmoji) bossEmoji.textContent = boss.emoji;
            if (bossName) bossName.textContent = boss.name;
            if (bossHP) bossHP.textContent = `${boss.hp}/${boss.hp}`;
            if (bossHealthFill) bossHealthFill.style.width = '100%';
            if (bossBanner) bossBanner.classList.add('active');
            
            playSound('meow');
        }
        
        function damageBoss() {
            if (!gameState.bossActive) return;
            
            gameState.bossHealth--;
            const boss = gameState.currentBoss;
            
            const bossHP = document.getElementById('bossHP');
            const bossHealthFill = document.getElementById('bossHealthFill');
            const bossEmoji = document.getElementById('bossEmoji');
            
            if (bossHP) bossHP.textContent = `${gameState.bossHealth}/${boss.hp}`;
            if (bossHealthFill) bossHealthFill.style.width = `${(gameState.bossHealth / boss.hp) * 100}%`;
            
            // Boss shake effect
            if (bossEmoji) {
                bossEmoji.style.animation = 'none';
                setTimeout(() => {
                    bossEmoji.style.animation = 'bossFloat 1s ease-in-out infinite';
                }, 100);
            }
            
            if (gameState.bossHealth <= 0) {
                defeatBoss();
            }
        }
        
        function defeatBoss() {
            const boss = gameState.currentBoss;
            
            gameState.bossActive = false;
            gameState.xp += boss.reward;
            gameState.score += boss.reward;
            
            const bossBanner = document.getElementById('bossBanner');
            if (bossBanner) bossBanner.classList.remove('active');
            
            showFeedback(true, `üéâ BOSS DEFEATED! ${boss.name} is gone! +${boss.reward} XP!`);
            playSound('evolution');
            createConfetti();
            
            checkEvolution();
            updateScoreDisplay();
            
            // Start new boss after delay
            setTimeout(() => {
                if (document.querySelector('.mode-btn.boss.active')) {
                    startBossBattle();
                }
            }, 3000);
        }
        
        // ============ CAT FACTS ============
        function showCatFact() {
            const theme = getTheme();
            const facts = theme.facts;
            
            // Pick a random fact (different from last one)
            let factIndex;
            do {
                factIndex = Math.floor(Math.random() * facts.length);
            } while (factIndex === gameState.lastFactIndex && facts.length > 1);
            
            gameState.lastFactIndex = factIndex;
            const fact = facts[factIndex];
            
            // Create popup if doesn't exist
            let popup = document.getElementById('catFactPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'catFactPopup';
                popup.className = 'cat-fact-popup';
                popup.innerHTML = `
                    <div class="d-flex align-items-start">
                        <span class="fs-3 me-2" id="factEmoji">${theme.emoji}</span>
                        <div>
                            <div class="fw-bold text-purple small">Did you know?</div>
                            <div id="catFactText"></div>
                        </div>
                        <button class="btn-close ms-2" onclick="hideCatFact()"></button>
                    </div>
                `;
                document.body.appendChild(popup);
            }
            
            // Update emoji for current theme
            const factEmoji = document.getElementById('factEmoji');
            if (factEmoji) factEmoji.textContent = theme.emoji;
            
            document.getElementById('catFactText').textContent = fact;
            popup.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(hideCatFact, 5000);
        }
        
        function hideCatFact() {
            const popup = document.getElementById('catFactPopup');
            if (popup) {
                popup.classList.remove('show');
            }
        }
        
        // ============ MINI-GAMES ============
        function startMiniGame(specificGame = null) {
            const miniGamesArr = getMiniGames();
            const game = specificGame || miniGamesArr[Math.floor(Math.random() * miniGamesArr.length)];
            
            gameState.miniGameActive = true;
            gameState.miniGameScore = 0;
            gameState.currentMiniGame = game;
            
            const overlay = document.createElement('div');
            overlay.id = 'miniGameOverlay';
            overlay.className = 'mini-game-overlay';
            overlay.innerHTML = `
                <div class="mini-game-container">
                    <h4>${game.emoji} ${game.name}</h4>
                    <p class="small">${game.description}</p>
                    <div class="mini-game-area" id="miniGameArea" style="background: ${game.bg};">
                        ${game.id === 'fish' ? '<div class="water-waves"></div>' : ''}
                    </div>
                    <div class="d-flex justify-content-around mt-2">
                        <div>Score: <span class="fw-bold" id="miniGameScoreDisplay">0</span></div>
                        <div>Time: <span class="fw-bold" id="miniGameTimer">10</span>s</div>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            const gameArea = document.getElementById('miniGameArea');
            let timeLeft = 10;
            
            const spawnTarget = (isDecoy = false) => {
                if (!gameState.miniGameActive) return;
                
                const target = document.createElement('div');
                target.className = 'catch-target';
                
                // Decide if this is a decoy (30% chance)
                const spawnDecoy = isDecoy || (Math.random() < 0.3 && game.decoys.length > 0);
                const emoji = spawnDecoy ? game.decoys[Math.floor(Math.random() * game.decoys.length)] : game.target;
                target.textContent = emoji;
                target.dataset.isTarget = !spawnDecoy;
                
                // Game-specific spawn and animation
                if (game.id === 'mice') {
                    // Mice scurry across the screen
                    const fromLeft = Math.random() > 0.5;
                    const yPos = Math.random() * 60 + 20;
                    target.style.top = yPos + '%';
                    target.style.left = fromLeft ? '0%' : '100%';
                    target.style.transform = fromLeft ? 'translateX(-100%) scaleX(1)' : 'translateX(0%) scaleX(-1)';
                    
                    setTimeout(() => {
                        target.style.transition = 'left 2.5s linear';
                        target.style.left = fromLeft ? '100%' : '0%';
                        target.style.transform = fromLeft ? 'translateX(0%) scaleX(1)' : 'translateX(-100%) scaleX(-1)';
                    }, 50);
                    
                    setTimeout(() => { if (target.parentNode) target.remove(); }, 2600);
                    
                } else if (game.id === 'fish') {
                    // Fish swim across
                    const fromLeft = Math.random() > 0.5;
                    const yPos = Math.random() * 50 + 25;
                    target.style.top = yPos + '%';
                    target.style.left = fromLeft ? '0%' : '100%';
                    target.style.transform = fromLeft ? 'translateX(-100%) scaleX(1)' : 'translateX(0%) scaleX(-1)';
                    target.classList.add('swimming');
                    
                    setTimeout(() => {
                        target.style.transition = 'left 3s linear';
                        target.style.left = fromLeft ? '100%' : '0%';
                        target.style.transform = fromLeft ? 'translateX(0%) scaleX(1)' : 'translateX(-100%) scaleX(-1)';
                    }, 50);
                    
                    setTimeout(() => { if (target.parentNode) target.remove(); }, 3100);
                    
                } else if (game.id === 'yarn') {
                    // Yarn bounces across
                    const fromLeft = Math.random() > 0.5;
                    target.style.top = '55%';
                    target.style.left = fromLeft ? '0%' : '100%';
                    target.style.transform = fromLeft ? 'translateX(-100%)' : 'translateX(0%)';
                    target.classList.add('bouncing');
                    
                    setTimeout(() => {
                        target.style.transition = 'left 2.5s linear';
                        target.style.left = fromLeft ? '100%' : '0%';
                        target.style.transform = fromLeft ? 'translateX(0%)' : 'translateX(-100%)';
                    }, 50);
                    
                    setTimeout(() => { if (target.parentNode) target.remove(); }, 2600);
                    
                } else if (game.id === 'butterfly') {
                    // Butterflies float smoothly across the screen
                    const fromLeft = Math.random() > 0.5;
                    const yPos = Math.random() * 50 + 25;
                    target.style.top = yPos + '%';
                    target.style.left = fromLeft ? '0%' : '100%';
                    target.style.transform = fromLeft ? 'translateX(-100%)' : 'translateX(0%)';
                    target.classList.add('floating');
                    
                    setTimeout(() => {
                        target.style.transition = 'left 3.5s linear';
                        target.style.left = fromLeft ? '100%' : '0%';
                        target.style.transform = fromLeft ? 'translateX(0%)' : 'translateX(-100%)';
                    }, 50);
                    
                    setTimeout(() => { if (target.parentNode) target.remove(); }, 3600);
                    
                } else if (game.id === 'treats') {
                    // Treats fall from the top
                    const xPos = Math.random() * 80 + 10;
                    target.style.left = xPos + '%';
                    target.style.top = '0%';
                    target.style.transform = 'translateY(-100%)';
                    target.classList.add('falling');
                    
                    setTimeout(() => {
                        target.style.transition = 'top 2.5s linear';
                        target.style.top = '100%';
                        target.style.transform = 'translateY(0%)';
                    }, 50);
                    
                    setTimeout(() => { if (target.parentNode) target.remove(); }, 2600);
                    
                } else if (game.id === 'laser') {
                    // Laser dots zip around erratically
                    const xPos = Math.random() * 70 + 15;
                    const yPos = Math.random() * 60 + 20;
                    target.style.left = xPos + '%';
                    target.style.top = yPos + '%';
                    target.classList.add('laser-dot');
                    
                    // Move to new position after a moment
                    setTimeout(() => {
                        target.style.transition = 'left 0.8s ease-out, top 0.8s ease-out';
                        target.style.left = (Math.random() * 70 + 15) + '%';
                        target.style.top = (Math.random() * 60 + 20) + '%';
                    }, 50);
                    
                    // Move again
                    setTimeout(() => {
                        target.style.left = (Math.random() * 70 + 15) + '%';
                        target.style.top = (Math.random() * 60 + 20) + '%';
                    }, 900);
                    
                    // Move one more time
                    setTimeout(() => {
                        target.style.left = (Math.random() * 70 + 15) + '%';
                        target.style.top = (Math.random() * 60 + 20) + '%';
                    }, 1800);
                    
                    setTimeout(() => { if (target.parentNode) target.remove(); }, 2700);
                }
                
                target.onclick = (e) => {
                    e.stopPropagation();
                    if (target.dataset.isTarget === 'true') {
                        // Correct target!
                        gameState.miniGameScore++;
                        document.getElementById('miniGameScoreDisplay').textContent = gameState.miniGameScore;
                        target.textContent = '‚ú®';
                        playSound('correct');
                    } else {
                        // Decoy - wrong!
                        target.textContent = '‚ùå';
                        playSound('incorrect');
                    }
                    target.style.animation = 'none';
                    target.style.transition = 'none';
                    target.onclick = null;
                    setTimeout(() => target.remove(), 200);
                };
                
                gameArea.appendChild(target);
            };
            
            const spawnRate = game.id === 'yarn' ? 800 : game.id === 'butterfly' ? 900 : 700;
            const spawnInterval = setInterval(() => spawnTarget(false), spawnRate);
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                const timerEl = document.getElementById('miniGameTimer');
                if (timerEl) timerEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(spawnInterval);
                    clearInterval(timerInterval);
                    endMiniGame();
                }
            }, 1000);
            
            // Initial spawn - just one to start
            spawnTarget(false);
        }
        
        function endMiniGame() {
            gameState.miniGameActive = false;
            const game = gameState.currentMiniGame;
            
            const bonus = gameState.miniGameScore * 2;
            gameState.xp += bonus;
            gameState.score += bonus;
            
            // Determine rating
            let rating = '‚≠ê';
            let message = 'Good try!';
            if (gameState.miniGameScore >= 15) {
                rating = '‚≠ê‚≠ê‚≠ê';
                message = 'AMAZING!';
            } else if (gameState.miniGameScore >= 10) {
                rating = '‚≠ê‚≠ê';
                message = 'Great job!';
            }
            
            const overlay = document.getElementById('miniGameOverlay');
            overlay.innerHTML = `
                <div class="mini-game-container">
                    <h4>üéâ ${message}</h4>
                    <div class="fs-1 my-3">${game.emoji}</div>
                    <p>You caught <strong>${gameState.miniGameScore}</strong> ${game.caught}!</p>
                    <div class="fs-4 mb-2">${rating}</div>
                    <p class="text-warning fw-bold">+${bonus} bonus XP!</p>
                    <button class="btn btn-light mt-2" onclick="closeMiniGame()">Continue</button>
                </div>
            `;
            
            playSound('evolution');
            checkEvolution();
            updateScoreDisplay();
        }
        
        function closeMiniGame() {
            const overlay = document.getElementById('miniGameOverlay');
            if (overlay) overlay.remove();
        }
        
        function offerMiniGame() {
            const miniGamesArr = getMiniGames();
            const game = miniGamesArr[Math.floor(Math.random() * miniGamesArr.length)];
            
            const popup = document.createElement('div');
            popup.id = 'miniGameOffer';
            popup.className = 'mini-game-overlay';
            popup.innerHTML = `
                <div class="mini-game-container" style="max-width: 350px;">
                    <h4>üéÆ Bonus Game!</h4>
                    <div class="fs-1 my-3">${game.emoji}</div>
                    <p class="fw-bold">${game.name}</p>
                    <p class="small">${game.description}</p>
                    <p class="small text-warning">Earn bonus XP!</p>
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <button class="btn btn-success" onclick="acceptMiniGame('${game.id}')">Play!</button>
                        <button class="btn btn-secondary" onclick="declineMiniGame()">Skip</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }
        
        function acceptMiniGame(gameId) {
            const popup = document.getElementById('miniGameOffer');
            if (popup) popup.remove();
            
            const game = getMiniGames().find(g => g.id === gameId);
            startMiniGame(game);
        }
        
        function declineMiniGame() {
            const popup = document.getElementById('miniGameOffer');
            if (popup) popup.remove();
        }
        
        // ============ MULTIPLE CATS ============
        function addNewCat() {
            if (gameState.cats.length >= 5) {
                alert('Maximum 5 cats!');
                return;
            }
            
            // Save current cat
            saveCatData();
            
            // Create new cat
            const newCat = {
                name: 'Kitty ' + (gameState.cats.length + 1),
                color: ['#FFB347', '#808080', '#333333', '#FFF8DC', '#8B4513', '#9B59B6', '#3498DB'][Math.floor(Math.random() * 7)],
                xp: 0,
                stage: 0,
                score: 0,
                totalCorrect: 0
            };
            
            gameState.cats.push(newCat);
            gameState.currentCatIndex = gameState.cats.length - 1;
            
            loadCatData(gameState.currentCatIndex);
            updateCatsSelector();
            
            // Show start screen for new cat
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gamePlay').style.display = 'none';
        }
        
        function saveCatData() {
            if (gameState.cats.length === 0) {
                gameState.cats.push({});
            }
            
            gameState.cats[gameState.currentCatIndex] = {
                name: gameState.catName,
                color: gameState.catColor,
                xp: gameState.xp,
                stage: gameState.stage,
                score: gameState.score,
                totalCorrect: gameState.totalCorrect
            };
        }
        
        function loadCatData(index) {
            if (index >= gameState.cats.length) return;
            
            const cat = gameState.cats[index];
            gameState.catName = cat.name;
            gameState.catColor = cat.color;
            gameState.xp = cat.xp;
            gameState.stage = cat.stage;
            gameState.score = cat.score;
            gameState.totalCorrect = cat.totalCorrect || 0;
            gameState.currentCatIndex = index;
            
            updateCatDisplay();
            updateEvolutionDisplay();
            updateScoreDisplay();
        }
        
        function switchCat(index) {
            saveCatData();
            loadCatData(index);
            updateCatsSelector();
        }
        
        function updateCatsSelector() {
            // Only show selector if more than one cat
            let selector = document.getElementById('catsSelector');
            
            if (gameState.cats.length <= 1) {
                if (selector) selector.style.display = 'none';
                return;
            }
            
            if (!selector) {
                selector = document.createElement('div');
                selector.id = 'catsSelector';
                selector.className = 'cats-selector';
                const evolutionCard = document.querySelector('.evolution-card');
                if (evolutionCard) {
                    evolutionCard.parentNode.insertBefore(selector, evolutionCard);
                }
            }
            
            selector.style.display = 'flex';
            selector.innerHTML = gameState.cats.map((cat, i) => `
                <div class="cat-tab ${i === gameState.currentCatIndex ? 'active' : ''}" onclick="switchCat(${i})">
                    ${cat.name || 'Cat ' + (i+1)}
                </div>
            `).join('') + `
                <div class="cat-tab add-new" onclick="addNewCat()">+ New Cat</div>
            `;
        }
        
        // ============ ADDITIONAL EXPRESSIONS ============
        function setExpression(expression) {
            const catSvg = document.querySelector('.cat-svg');
            if (!catSvg) return;
            
            catSvg.classList.remove('curious', 'excited');
            
            if (expression === 'curious' || expression === 'excited') {
                catSvg.classList.add(expression);
            }
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!-- Cat Fact Popup -->
    <div class="cat-fact-popup" id="catFactPopup">
        <div class="d-flex align-items-start">
            <span class="fs-3 me-2">üê±</span>
            <div>
                <div class="fw-bold small" style="color: var(--primary-purple);">Did you know?</div>
                <div id="catFactText"></div>
            </div>
            <button class="btn-close ms-2" onclick="hideCatFact()"></button>
        </div>
    </div>
</body>
</html>
